<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #ffd700; --blue: #2980b9; --red: #c0392b; --orange: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; }
        .header { background: var(--primary); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--gold); }
        .container { max-width: 1200px; margin: 20px auto; padding: 10px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white; width: 100%; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; padding: 8px 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; min-width: 800px; }
        th { background: var(--primary); color: white; padding: 12px; border: 1px solid #ddd; font-size: 14px; }
        td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        
        .m-input { width: 70px !important; padding: 8px; border: 1px solid #aaa; border-radius: 4px; text-align: center; font-size: 16px; font-weight: bold; }
        .hidden { display: none; }
        .link-box { background: #f8f9fa; padding: 15px; border: 1px dashed #2980b9; border-radius: 5px; word-break: break-all; font-family: monospace; display: block; margin: 10px 0; color: #2980b9; }
        
        /* Auth Tabs */
        .auth-box { max-width: 450px; margin: -40px auto 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .auth-tabs { display: flex; background: #eee; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .auth-tab.active { background: white; border-top: 4px solid var(--primary); color: var(--primary); }
        .r-sts { width: 105px !important;  padding: 6px; font-size: 13px; font-weight: bold; border: 1px solid #aaa; border-radius: 4px; background-color: white; }
    </style>
</head>
<body>

<div id="authSection">
    <div class="header"><h1>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥æ‡¥®‡µΩ</h1></div>
    <div class="auth-box">
        <div class="auth-tabs">
            <div id="tabL" class="auth-tab active" onclick="showAuth('L')">LOGIN</div>
            <div id="tabR" class="auth-tab" onclick="showAuth('R')">REGISTER</div>
        </div>
        <div style="padding: 30px;">
            <div id="loginForm">
                <input type="tel" id="lPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="login()">‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
            </div>
            <div id="regForm" class="hidden">
                <input type="text" id="rName" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç">
                <input type="text" id="rPlace" placeholder="‡¥∏‡µç‡¥•‡¥≤‡¥Ç">
                <input type="text" id="rSadar" placeholder="‡¥∏‡¥¶‡µº ‡¥â‡¥∏‡µç‡¥§‡¥æ‡¥¶‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥™‡µá‡¥∞‡µç">
                <input type="tel" id="rPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="register()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
            </div>
        </div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="card" style="display: flex; justify-content: space-between; align-items: center; border-left: 10px solid var(--gold);">
        <div>
            <h2 id="displayMName" style="margin:0; color:var(--primary);">---</h2>
            <p style="margin:5px 0; color:#666;"><span id="displayDetails"></span> | Sadar: <b id="displaySadar"></b></p>
        </div>
        <button id="topSaveBtn" class="btn btn-blue" onclick="saveAllData()">SAVE ALL DATA ‚úÖ</button>
    </div>

    <div id="mainWorkArea">
        <div class="card">
            <h3>1. ‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡¥≥‡µÜ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <select id="selClass"></select>
                <input type="number" id="inReg" placeholder="Reg No">
                <input type="text" id="inName" placeholder="Student Name">
                <button class="btn btn-green" onclick="addStudent()">ADD STUDENT</button>
            </div>
            <div id="studentListArea"></div>
        </div>

        <div class="card">
            <h3>2. ‡¥µ‡¥ø‡¥∑‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <select id="selSubClass" onchange="refreshSubList()"></select>
                <input type="text" id="inSubName" placeholder="Subject Name">
                <button class="btn btn-green" onclick="addSubject()">ADD SUBJECT</button>
            </div>
            <div id="subjectListArea"></div>
        </div>

        <div class="card">
            <h3>3. ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥é‡µª‡¥ü‡µç‡¥∞‡¥ø & ‡¥π‡¥æ‡¥ú‡µº</h3>
            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                <select id="selMarkClass" style="width: 200px;" onchange="updateTotalAttField()"></select>
                <input type="number" id="totalAttDays" placeholder="Total Working Days" style="width: 200px;">
                <button class="btn btn-blue" onclick="loadMainTable()">LOAD TABLE</button>
            </div>
            <div id="mainTableWrapper" style="overflow-x: auto;"></div>
        </div>
        <div id="downloadButtons" style="margin-top: 15px; display: none; gap: 10px;">
    <button class="btn" style="background: #27ae60; color: white;" onclick="exportToExcel()">
        <i class="fa fa-file-excel"></i> Excel Download
    </button>
    <button class="btn" style="background: #e74c3c; color: white;" onclick="exportToPDF()">
        <i class="fa fa-file-pdf"></i> PDF Download
    </button>
</div>
        <button id="finalSubmitBtn" class="btn btn-green" style="font-size: 18px; padding: 20px;" onclick="finalSubmit()">PUBLISH TO SUPER ADMIN üöÄ</button>
    </div>

    <div id="photoWorkArea" class="hidden">
        <div class="card" style="text-align: center;">
            <h2 id="statusText" style="color: var(--blue);">‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï...</h2>
            <div id="approvedSection" class="hidden">
                <p>‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡µΩ ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ. ‡¥§‡¥æ‡¥¥‡µÜ ‡¥ï‡¥æ‡¥£‡µÅ‡¥®‡µç‡¥® ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥â‡¥∏‡µç‡¥§‡¥æ‡¥¶‡µÅ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥®‡µΩ‡¥ï‡¥ø ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥™‡µÇ‡µº‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</p>
                <span id="photoLinkDisp" class="link-box"></span>
                <button class="btn btn-blue" onclick="copyText('photoLinkDisp')">COPY PHOTO LINK</button>

                <div class="card" style="margin-top: 30px; border: 1px solid #ddd;">
                    <h3>‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç</h3>
                    <select id="selStatusClass" onchange="showPhotoStatusList()" style="width: 250px;"></select>
                    <div id="photoStatusTableArea"></div>
                </div>
                <button id="btnFinalPub" class="btn btn-orange" style="width: 100%; margin-top: 20px; background: var(--orange); color: white;" onclick="makeFinalPublish()">FINAL PUBLISH (VIEW RESULT) üöÄ</button>
            </div>
        </div>
    </div>

    <div id="finalResultArea" class="hidden">
        <div class="card" style="text-align: center; border: 3px solid #27ae60;">
            <h2 style="color: #27ae60;">‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ! ‚úÖ</h2>
            <p>‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥®‡µΩ‡¥ï‡µá‡¥£‡µç‡¥ü ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç:</p>
            <span id="viewLinkDisp" class="link-box"></span>
            <button class="btn btn-red" onclick="copyText('viewLinkDisp')">COPY RESULT LINK</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf-plugin-autotable.min.js"></script>
<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = {};
    let currentDocId = "";
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6", "Class 7", "Class 8", "Class 9", "Class 10"];

    window.onload = () => {
        const clsHtml = '<option value="">‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('#selClass, #selSubClass, #selMarkClass, #selStatusClass').forEach(s => s.innerHTML = clsHtml);
    };

    function showAuth(t) {
        document.getElementById('loginForm').classList.toggle('hidden', t === 'R');
        document.getElementById('regForm').classList.toggle('hidden', t === 'L');
        document.getElementById('tabL').classList.toggle('active', t === 'L');
        document.getElementById('tabR').classList.toggle('active', t === 'R');
    }

    async function register() {
        const ph = document.getElementById('rPhone').value.trim();
        const n = document.getElementById('rName').value.trim();
        const p = document.getElementById('rPlace').value.trim();
        const s = document.getElementById('rSadar').value.trim();
        if(!ph || !n || !p || !s) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
        
        const check = await db.collection("madrasa_data").doc(ph).get();
        if(check.exists) return alert("‡¥à ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥£‡µç‡¥ü‡µç!");

        const uID = "MID" + Math.floor(1000 + Math.random() * 9000);
        mData = { info: { name: n, place: p, sadar: s, phone: ph }, uID, students: {}, subjects: {}, results: {}, attSettings: {}, photos: {}, isSubmitted: false, isApproved: false, isFinalPublished: false };
        await db.collection("madrasa_data").doc(ph).set(mData);
        alert("‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!"); showAuth('L');
    }

    async function login() {
        const ph = document.getElementById('lPhone').value.trim();
        const doc = await db.collection("madrasa_data").doc(ph).get();
        if(doc.exists) { currentDocId = ph; mData = doc.data(); startPanel(); } else alert("‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥£‡µç!");
    }

    function startPanel() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('displayMName').innerText = mData.info.name;
        document.getElementById('displayDetails').innerText = mData.info.place;
        document.getElementById('displaySadar').innerText = mData.info.sadar || "---";

        if(mData.isFinalPublished) {
            document.getElementById('mainWorkArea').classList.add('hidden');
            document.getElementById('photoWorkArea').classList.add('hidden');
            document.getElementById('finalResultArea').classList.remove('hidden');
            document.getElementById('viewLinkDisp').innerText = `https://mannanimuhsin-sys.github.io/my-website-1/misbahresultview.html?id=${mData.uID}`;
        } else if(mData.isSubmitted) {
            document.getElementById('mainWorkArea').classList.add('hidden');
            document.getElementById('photoWorkArea').classList.remove('hidden');
            if(mData.isApproved) {
                document.getElementById('statusText').innerText = "‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡µΩ ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ ‚úÖ";
                document.getElementById('approvedSection').classList.remove('hidden');
                document.getElementById('photoLinkDisp').innerText = `https://mannanimuhsin-sys.github.io/my-website-1/photoupload.html?id=${mData.uID}`;
            } else {
                document.getElementById('statusText').innerText = "‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡¥≤‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï... ‚è≥";
            }
        }
        refreshStList();
        refreshSubList();
    }

    function addStudent() {
        const c = document.getElementById('selClass').value;
        const r = document.getElementById('inReg').value.trim();
        const n = document.getElementById('inName').value.trim();
        if(!c || !r || !n) return;
        if(!mData.students[c]) mData.students[c] = {};
        mData.students[c][r] = n;
        document.getElementById('inReg').value = '';
        document.getElementById('inName').value = '';
        refreshStList();
    }

    function refreshStList() {
        let h = "";
        for(let c in mData.students) {
            h += `<h4>${c}</h4><table><tr><th>Reg</th><th>Name</th><th>Action</th></tr>`;
            for(let r in mData.students[c]) {
                h += `<tr><td>${r}</td><td>${mData.students[c][r]}</td><td><button class="btn-red" onclick="deleteStudent('${c}','${r}')">Delete</button></td></tr>`;
            }
            h += `</table>`;
        }
        document.getElementById('studentListArea').innerHTML = h;
    }
    
    function deleteStudent(c, r) {
        delete mData.students[c][r];
        refreshStList();
    }

    function addSubject() {
        const c = document.getElementById('selSubClass').value;
        const s = document.getElementById('inSubName').value.trim();
        if(!c || !s) return;
        if(!mData.subjects[c]) mData.subjects[c] = [];
        mData.subjects[c].push(s);
        document.getElementById('inSubName').value = '';
        refreshSubList();
    }

    function refreshSubList() {
        const c = document.getElementById('selSubClass').value;
        if(!c) { document.getElementById('subjectListArea').innerHTML = ""; return; }
        let h = `<table><tr><th>Subject</th><th>Action</th></tr>`;
        (mData.subjects[c] || []).forEach((s, i) => {
            h += `<tr><td>${s}</td><td><button class="btn-red" onclick="deleteSubject('${c}',${i})">Delete</button></td></tr>`;
        });
        document.getElementById('subjectListArea').innerHTML = h + `</table>`;
    }

    function deleteSubject(c, i) {
        mData.subjects[c].splice(i, 1);
        refreshSubList();
    }

    function updateTotalAttField() {
        const c = document.getElementById('selMarkClass').value;
        document.getElementById('totalAttDays').value = (mData.attSettings && mData.attSettings[c]) ? mData.attSettings[c] : "";
    }

    function loadMainTable() {
        const c = document.getElementById('selMarkClass').value;
        if(!c) return alert("‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï");
        const studs = mData.students[c] || {};
        const subs = mData.subjects[c] || [];
        
        let h = `<table><thead><tr><th>Reg</th><th>Name</th><th>Att.</th>`;
        subs.forEach(s => h += `<th>${s.substring(0,6)}</th>`);
        h += '<th>Total</th><th style="min-width:110px;">Status</th><th>Rank</th></tr></thead><tbody>';        
        for(let r in studs) {
            const res = (mData.results[c] && mData.results[c][r]) ? mData.results[c][r] : { marks: {}, att: '', total: 0, status: 'Passed', rank: '' };
            h += `<tr data-reg="${r}"><td>${r}</td><td style="text-align:left; font-size:13px;">${studs[r]}</td>
            <td><input type="number" class="m-input s-att" value="${res.att}"></td>`;
            subs.forEach(s => h += `<td><input type="number" class="m-input s-mark" data-sub="${s}" value="${res.marks[s] || ''}" oninput="updateRowLogic(this)"></td>`);
            h += `<td class="r-tot" style="font-weight:bold">${res.total}</td>
            <td><select class="r-sts">
                <option value="Passed" ${res.status=='Passed'?'selected':''}>Passed</option>
                <option value="Failed" ${res.status=='Failed'?'selected':''}>Failed</option>
                <option value="Promotion" ${res.status=='Promotion'?'selected':''}>Promotion</option>
            </select></td>
            <td><input type="text" class="m-input r-rank" value="${res.rank || ''}"></td></tr>`;
        }
        document.getElementById('mainTableWrapper').innerHTML = h + `</tbody></table>`;
    }

    function updateRowLogic(el) {
        const row = el.closest('tr');
        let tot = 0;
        let isFailed = false;
        row.querySelectorAll('.s-mark').forEach(i => {
            let val = parseInt(i.value) || 0;
            tot += val;
            if(val < 18) isFailed = true; // ‡¥™‡¥æ‡¥∏‡µç ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç 18 ‡¥Ü‡¥Ø‡¥ø ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        });
        row.querySelector('.r-tot').innerText = tot;
        if(isFailed) row.querySelector('.r-sts').value = "Failed";
        else row.querySelector('.r-sts').value = "Passed";
    }

    async function saveAllData() {
        const c = document.getElementById('selMarkClass').value;
        if(c) {
            if(!mData.attSettings) mData.attSettings = {};
            mData.attSettings[c] = document.getElementById('totalAttDays').value;
            if(!mData.results) mData.results = {};
            if(!mData.results[c]) mData.results[c] = {};
            document.querySelectorAll('#mainTableWrapper tbody tr').forEach(row => {
                const r = row.getAttribute('data-reg');
                let marks = {};
                row.querySelectorAll('.s-mark').forEach(i => marks[i.getAttribute('data-sub')] = i.value);
                mData.results[c][r] = { 
                    att: row.querySelector('.s-att').value, 
                    marks, 
                    total: row.querySelector('.r-tot').innerText, 
                    status: row.querySelector('.r-sts').value, 
                    rank: row.querySelector('.r-rank').value 
                };
            });
        }
        await db.collection("madrasa_data").doc(currentDocId).set(mData);
        alert("‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥∏‡µÅ‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ! ‚úÖ");
    }

    async function finalSubmit() {
        if(!confirm("‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡¥®‡µç ‡¥∏‡¥Æ‡µº‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥£‡µã? ‡¥™‡¥ø‡¥®‡µç‡¥®‡µÄ‡¥ü‡µç ‡¥§‡¥ø‡¥∞‡µÅ‡¥§‡µç‡¥§‡¥æ‡µª ‡¥∏‡¥æ‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡¥ø‡¥≤‡µç‡¥≤.")) return;
        mData.isSubmitted = true;
        await saveAllData(); startPanel();
    }

    async function makeFinalPublish() {
        if(!confirm("‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã? ‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥ï‡¥æ‡¥£‡¥æ‡¥Ç.")) return;
        mData.isFinalPublished = true;
        await db.collection("madrasa_data").doc(currentDocId).update({ isFinalPublished: true });
        startPanel();
    }

    function showPhotoStatusList() {
        const c = document.getElementById('selStatusClass').value;
        if(!c) return;
        const studs = mData.students[c] || {};
        const photos = mData.photos || {};
        let h = `<table><tr><th>Reg No</th><th>Name</th><th>Status</th></tr>`;
        for(let r in studs) {
            h += `<tr><td>${r}</td><td>${studs[r]}</td><td>${photos[r] ? '‚úÖ' : '‚ùå'}</td></tr>`;
        }
        document.getElementById('photoStatusTableArea').innerHTML = h + `</table>`;
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text);
        alert("Copied to clipboard!");
    }
function exportToExcel() {
    const cls = document.getElementById('selMarkClass').value;
    const table = document.querySelector("#mainTableWrapper table");
    if (!table) return alert("‡¥Ü‡¥¶‡µç‡¥Ø‡¥Ç ‡¥ü‡µá‡¥¨‡¥ø‡µæ ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï!");

    let data = [];
    const rows = table.querySelectorAll("tr");

    rows.forEach((row) => {
        let rowData = [];
        const cols = row.querySelectorAll("th, td");
        
        cols.forEach((col) => {
            const input = col.querySelector("input");
            const select = col.querySelector("select");
            
            if (input) {
                rowData.push(input.value);
            } else if (select) {
                rowData.push(select.value); // ‡¥∏‡µÜ‡¥≤‡¥ï‡µç‡¥ü‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§ ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç
            } else {
                rowData.push(col.innerText); // ‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£ ‡¥ü‡µÜ‡¥ï‡µç‡¥∏‡µç‡¥±‡µç‡¥±‡µç (Reg, Name, Total)
            }
        });
        data.push(rowData);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Result");
    XLSX.writeFile(workbook, `${mData.info.name}_${cls}_Result.xlsx`);
}


function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = jsPDF('l', 'pt'); // Landscape
    const cls = document.getElementById('selMarkClass').value;
    const table = document.querySelector("#mainTableWrapper table");
    if (!table) return alert("‡¥Ü‡¥¶‡µç‡¥Ø‡¥Ç ‡¥ü‡µá‡¥¨‡¥ø‡µæ ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï!");

    // ‡¥ü‡µá‡¥¨‡¥ø‡µæ ‡¥π‡µÜ‡¥°‡µº ‡¥§‡¥Ø‡µç‡¥Ø‡¥æ‡¥±‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    let headers = [];
    table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText));

    // ‡¥ü‡µá‡¥¨‡¥ø‡µæ ‡¥¨‡µã‡¥°‡¥ø ‡¥§‡¥Ø‡µç‡¥Ø‡¥æ‡¥±‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    let body = [];
    table.querySelectorAll("tbody tr").forEach(row => {
        let rowData = [];
        row.querySelectorAll("td").forEach(td => {
            const input = td.querySelector("input");
            const select = td.querySelector("select");
            if (input) rowData.push(input.value);
            else if (select) rowData.push(select.value);
            else rowData.push(td.innerText);
        });
        body.push(rowData);
    });

    doc.setFontSize(16);
    doc.text(`${mData.info.name} - ${cls} Result`, 40, 40);

    doc.autoTable({
        head: [headers],
        body: body,
        startY: 60,
        styles: { fontSize: 9 },
        headStyles: { fillStyle: 'f', fillColor: [0, 77, 0] }
    });

    doc.save(`${mData.info.name}_${cls}_Result.pdf`);
}
const originalLoadMainTable = loadMainTable;
loadMainTable = function() {
    originalLoadMainTable(); 
    const btnBox = document.getElementById('downloadButtons');
    if(btnBox) btnBox.style.display = 'flex'; 
};
</script>

</body>
</html>