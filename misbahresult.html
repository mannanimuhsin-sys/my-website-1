<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Admin Panel | Final Secured</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; }
        .header { background: #004d00; color: white; padding: 30px; text-align: center; border-bottom: 5px solid #ffd700; }
        .container { max-width: 1100px; margin: 20px auto; padding: 10px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .auth-box { max-width: 450px; margin: -50px auto 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .auth-tabs { display: flex; background: #eee; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .auth-tab.active { background: white; border-top: 4px solid #004d00; color: #004d00; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-green { background: #004d00; color: white; width: 100%; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #c0392b; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #004d00; color: white; padding: 12px; border: 1px solid #ddd; font-size: 14px; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .m-input.s-att { width: 85px; padding: 8px; border: 2px solid #004d00; border-radius: 4px; text-align: center; font-weight: bold; }
        .m-input.s-mark { width: 55px; text-align: center; border: 1px solid #bbb; border-radius: 4px; padding: 8px; }
        .hidden { display: none; }
        .status-passed { color: green !important; font-weight: bold; }
        .status-failed { color: red !important; font-weight: bold; }
        .edit-input { border: none; background: transparent; text-align: center; width: 100%; font-size: inherit; }
    </style>
</head>
<body>

<div id="authSection">
    <div class="header"><h1>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥æ‡¥®‡µΩ</h1></div>
    <div class="auth-box">
        <div class="auth-tabs">
            <div id="tabL" class="auth-tab active" onclick="showAuth('L')">LOGIN</div>
            <div id="tabR" class="auth-tab" onclick="showAuth('R')">REGISTER</div>
        </div>
        <div style="padding: 30px;">
            <div id="loginForm">
                <input type="tel" id="lPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="login()">‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
            </div>
            <div id="regForm" class="hidden">
                <input type="text" id="rName" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç">
                <input type="text" id="rPlace" placeholder="‡¥∏‡µç‡¥•‡¥≤‡¥Ç">
                <input type="text" id="rSadr" placeholder="‡¥∏‡¥¶‡µº ‡¥Æ‡µÅ‡¥Ö‡¥≤‡µç‡¥≤‡¥ø‡¥Ç">
                <input type="tel" id="rPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="register()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
            </div>
        </div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 id="displayMName" style="margin:0; color:#004d00;">Madrasa Name</h2>
            <p id="displayDetails" style="margin:5px 0; color:#666;"></p>
        </div>
        <button class="btn btn-blue" id="mainSaveBtn" onclick="saveAllData()">SAVE DATA ‚úÖ</button>
    </div>

    <div id="managementSection">
        <div class="card">
            <h3>‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡¥≥‡µÜ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï / ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</h3>
            <div style="display: flex; gap: 10px;">
                <select id="selClass"></select>
                <input type="number" id="inReg" placeholder="Reg No">
                <input type="text" id="inName" placeholder="Student Name">
                <button class="btn btn-green" style="width:auto" onclick="addStudent()">ADD</button>
            </div>
            <div id="studentListArea"></div>
        </div>

        <div class="card">
            <h3>‡¥µ‡¥ø‡¥∑‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</h3>
            <div style="display: flex; gap: 10px;">
                <select id="selSubClass" onchange="refreshSubList()"></select>
                <input type="text" id="inSubName" placeholder="Subject Name">
                <button class="btn btn-green" style="width:auto" onclick="addSubject()">ADD</button>
            </div>
            <div id="subjectListArea"></div>
        </div>
    </div>

    <div class="card">
        <h3>‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥é‡µª‡¥ü‡µç‡¥∞‡¥ø & ‡¥π‡¥æ‡¥ú‡µº</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <select id="selMarkClass" style="width: 200px;"></select>
            <input type="number" id="totalAttDays" placeholder="Total Working Days" style="width: 200px;">
            <button class="btn btn-blue" onclick="loadMainTable()">LOAD TABLE</button>
        </div>
        <div id="mainTableWrapper" style="overflow-x: auto;"></div>
    </div>

    <div id="photoSection" class="card hidden">
        <h3>‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç</h3>
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ff9800;">
            <strong>‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç:</strong> <br>
            <code id="photoLinkDisp" style="color: #e65100; font-weight: bold; word-break: break-all;">---</code>
            <button class="btn btn-blue" style="padding:5px; margin-top:5px" onclick="copyLink()">Copy Link</button>
        </div>
        <div id="photoStatusTable"></div>
    </div>

    <div class="card">
        <button id="finalSubmitBtn" class="btn btn-green" style="width:100%" onclick="finalSubmit()">SUBMIT & GENERATE UPLOAD LINK üöÄ</button>
        <button id="publishBtn" class="btn btn-red hidden" style="width:100%" onclick="publishFinal()">PUBLISH FINAL RESULTS üì¢</button>
        <div id="linkSection" class="hidden" style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 10px;">
            <p><strong>‡¥´‡µà‡¥®‡µΩ ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç:</strong> <br><span id="rLinkText" style="font-weight:bold; color:#1565c0;"></span></p>
            <button class="btn btn-green" onclick="shareWhatsApp()">SHARE VIA WHATSAPP</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = { info: {}, students: {}, subjects: {}, results: {}, photos: {}, attSettings: {}, isSubmitted: false, uID: '' };
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6", "Class 7", "Class 8", "Class 9", "Class 10"];

    window.onload = () => {
        const clsHtml = '<option value="">‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('#selClass, #selSubClass, #selMarkClass').forEach(s => s.innerHTML = clsHtml);
    }

    function showAuth(t) {
        document.getElementById('loginForm').classList.toggle('hidden', t === 'R');
        document.getElementById('regForm').classList.toggle('hidden', t === 'L');
        document.getElementById('tabL').classList.toggle('active', t === 'L');
        document.getElementById('tabR').classList.toggle('active', t === 'R');
    }

    async function register() {
        const n = document.getElementById('rName').value.trim();
        const p = document.getElementById('rPlace').value.trim();
        const s = document.getElementById('rSadr').value.trim();
        const ph = document.getElementById('rPhone').value.trim();
        if(!n || !p || !s || !ph) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");
        const uID = "MID" + Math.floor(1000 + Math.random() * 9000);
        mData = { info: { name: n, place: p, sadr: s, phone: ph }, uID: uID, students: {}, subjects: {}, results: {}, photos: {}, attSettings: {}, isSubmitted: false };
        await db.collection("madrasa_data").doc(ph).set(mData);
        alert("‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥ü‡µç‡¥∞‡µá‡¥∑‡µª ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ö‡µç‡¥ö‡µÅ! ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.");
        showAuth('L');
    }

    async function login() {
        const ph = document.getElementById('lPhone').value.trim();
        const doc = await db.collection("madrasa_data").doc(ph).get();
        if(doc.exists) {
            mData = doc.data();
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('displayMName').innerText = mData.info.name;
            document.getElementById('displayDetails').innerText = `${mData.info.place} | Sadr: ${mData.info.sadr}`;
            checkStatus();
            refreshStList();
        } else { alert("‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥£‡µç!"); }
    }

    function checkStatus() {
        if (mData.isSubmitted) {
            document.getElementById('managementSection').classList.add('hidden');
            document.getElementById('photoSection').classList.remove('hidden');
            document.getElementById('finalSubmitBtn').classList.add('hidden');
            document.getElementById('publishBtn').classList.remove('hidden');
            document.getElementById('photoLinkDisp').innerText = "https://mannanimuhsin-sys.github.io/my-website-1/photoupload.html?id=" + mData.uID;
        }
    }

    function addStudent() {
        const c = document.getElementById('selClass').value;
        const r = document.getElementById('inReg').value;
        const n = document.getElementById('inName').value;
        if(!c || !r || !n) return;
        if(!mData.students[c]) mData.students[c] = {};
        mData.students[c][r] = n;
        refreshStList();
    }

    function refreshStList() {
        let h = "";
        for(let c in mData.students) {
            h += `<h4>${c}</h4><table><tr><th>Reg</th><th>Name</th><th>Action</th></tr>`;
            for(let r in mData.students[c]) {
                h += `<tr>
                    <td><input class="edit-input" value="${r}" onchange="updateReg('${c}','${r}',this.value)"></td>
                    <td><input class="edit-input" value="${mData.students[c][r]}" onchange="mData.students['${c}']['${r}']=this.value"></td>
                    <td><button onclick="delete mData.students['${c}']['${r}']; refreshStList()">Delete</button></td>
                </tr>`;
            }
            h += `</table>`;
        }
        document.getElementById('studentListArea').innerHTML = h;
    }
    function updateReg(c, o, n){ mData.students[c][n]=mData.students[c][o]; delete mData.students[c][o]; refreshStList(); }

    function addSubject() {
        const c = document.getElementById('selSubClass').value;
        const s = document.getElementById('inSubName').value;
        if(!c || !s) return;
        if(!mData.subjects[c]) mData.subjects[c] = [];
        mData.subjects[c].push(s);
        refreshSubList();
    }

    function refreshSubList() {
        const c = document.getElementById('selSubClass').value;
        if(!c) return;
        let h = `<table><tr><th>Subject</th><th>Action</th></tr>`;
        (mData.subjects[c] || []).forEach((s, i) => {
            h += `<tr><td><input class="edit-input" value="${s}" onchange="mData.subjects['${c}'][${i}]=this.value"></td>
                <td><button onclick="mData.subjects['${c}'].splice(${i},1); refreshSubList()">Delete</button></td></tr>`;
        });
        document.getElementById('subjectListArea').innerHTML = h + `</table>`;
    }

    function loadMainTable() {
        const c = document.getElementById('selMarkClass').value;
        if(!c) return alert("‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");
        const studs = mData.students[c] || {};
        const subs = mData.subjects[c] || [];
        document.getElementById('totalAttDays').value = (mData.attSettings && mData.attSettings[c]) ? mData.attSettings[c] : "";
        let h = `<table><thead><tr><th>Reg</th><th>Name</th><th>Att.</th>`;
        subs.forEach(s => h += `<th>${s}</th>`);
        h += `<th>Total</th><th>Status</th></tr></thead><tbody>`;
        for(let r in studs) {
            const res = (mData.results[c] && mData.results[c][r]) ? mData.results[c][r] : { marks: {}, att: '', total: 0, status: 'Passed' };
            h += `<tr data-reg="${r}"><td>${r}</td><td style="text-align:left">${studs[r]}</td><td><input type="number" class="m-input s-att" value="${res.att || ''}"></td>`;
            subs.forEach(s => {
                let m = (res.marks && res.marks[s]) ? res.marks[s] : '';
                h += `<td><input type="number" class="m-input s-mark" data-sub="${s}" value="${m}" oninput="updateRowLogic(this)"></td>`;
            });
            h += `<td class="r-tot">${res.total || 0}</td><td><select class="r-sts ${res.status=='Failed'?'status-failed':'status-passed'}">
                    <option value="Passed" ${res.status=='Passed'?'selected':''}>Passed</option>
                    <option value="Failed" ${res.status=='Failed'?'selected':''}>Failed</option>
                    <option value="Promoted" ${res.status=='Promoted'?'selected':''}>Promoted</option></select></td></tr>`;
        }
        document.getElementById('mainTableWrapper').innerHTML = h + `</tbody></table>`;
        if(mData.isSubmitted) refreshPhotoStatusTable(c);
    }

    function updateRowLogic(el) {
        const row = el.closest('tr');
        let tot = 0; let failed = false;
        row.querySelectorAll('.s-mark').forEach(i => {
            let val = parseFloat(i.value);
            if(!isNaN(val)) { tot += val; if(val <= 17) failed = true; }
        });
        row.querySelector('.r-tot').innerText = tot;
        const st = row.querySelector('.r-sts');
        st.value = failed ? "Failed" : "Passed";
        st.className = failed ? "r-sts status-failed" : "r-sts status-passed";
    }

    async function saveAllData() {
        const c = document.getElementById('selMarkClass').value;
        if(c) {
            if(!mData.attSettings) mData.attSettings = {};
            mData.attSettings[c] = document.getElementById('totalAttDays').value;
            if(!mData.results[c]) mData.results[c] = {};
            document.querySelectorAll('#mainTableWrapper tbody tr').forEach(row => {
                const r = row.getAttribute('data-reg');
                let marks = {};
                row.querySelectorAll('.s-mark').forEach(i => marks[i.getAttribute('data-sub')] = i.value);
                mData.results[c][r] = { att: row.querySelector('.s-att').value, marks, total: row.querySelector('.r-tot').innerText, status: row.querySelector('.r-sts').value };
            });
        }
        await db.collection("madrasa_data").doc(mData.info.phone).set(mData);
        alert("‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
    }

    async function finalSubmit() {
        if(!confirm("‡¥∏‡¥¨‡µç‡¥Æ‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡¥æ‡µΩ ‡¥™‡¥ø‡¥®‡µç‡¥®‡µÄ‡¥ü‡µç ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥ï‡¥¥‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤. ‡¥â‡¥±‡¥™‡µç‡¥™‡¥æ‡¥£‡µã?")) return;
        mData.isSubmitted = true;
        await saveAllData();
        checkStatus();
        alert("‡¥∏‡¥¨‡µç‡¥Æ‡¥ø‡¥±‡µç‡¥±‡µç ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø!");
    }

    function refreshPhotoStatusTable(c) {
        const studs = mData.students[c] || {};
        let h = "<table><tr><th>Student</th><th>Status</th></tr>";
        for(let r in studs) {
            const hasPhoto = mData.photos && mData.photos[r];
            h += `<tr><td>${studs[r]}</td><td>${hasPhoto ? "<b style='color:green'>‚úÖ Uploaded</b>" : "<b style='color:red'>‚ùå Pending</b>"}</td></tr>`;
        }
        document.getElementById('photoStatusTable').innerHTML = h + "</table>";
    }

    async function publishFinal() {
        // ‡¥á‡¥§‡¥æ‡¥£‡µç ‡¥µ‡µç‡¥Ø‡µÇ ‡¥™‡µá‡¥ú‡µÅ‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç
        const link = "https://mannanimuhsin-sys.github.io/my-website-1/misbahresult.html?id=" + mData.uID;
        document.getElementById('rLinkText').innerText = link;
        document.getElementById('linkSection').classList.remove('hidden');
    }
    
    function copyLink() { navigator.clipboard.writeText(document.getElementById('photoLinkDisp').innerText); alert("Copied!"); }
    function shareWhatsApp() { window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent("‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç: " + document.getElementById('rLinkText').innerText)); }
</script>

</body>
</html>