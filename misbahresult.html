<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #ffd700; --blue: #2980b9; --red: #c0392b; --orange: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; }
        .header { background: var(--primary); color: white; padding: 30px; text-align: center; border-bottom: 5px solid var(--gold); }
        .container { max-width: 1100px; margin: 20px auto; padding: 10px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* Auth Design */
        .auth-box { max-width: 450px; margin: -50px auto 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .auth-tabs { display: flex; background: #eee; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .auth-tab.active { background: white; border-top: 4px solid var(--primary); color: var(--primary); }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white; width: 100%; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-orange { background: var(--orange); color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: var(--primary); color: white; padding: 12px; border: 1px solid #ddd; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        
        .m-input { width: 60px !important; padding: 8px; border: 2px solid #ddd; border-radius: 4px; text-align: center; font-size: 15px; font-weight: bold; }
        .hidden { display: none; }
        .status-up { color: green; font-weight: bold; }
        .status-pen { color: red; font-weight: bold; }
        .link-box { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 5px; word-break: break-all; font-family: monospace; margin: 10px 0; display: block; }
    </style>
</head>
<body>

<div id="authSection">
    <div class="header"><h1>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥æ‡¥®‡µΩ</h1></div>
    <div class="auth-box">
        <div class="auth-tabs">
            <div id="tabL" class="auth-tab active" onclick="showAuth('L')">LOGIN</div>
            <div id="tabR" class="auth-tab" onclick="showAuth('R')">REGISTER</div>
        </div>
        <div style="padding: 30px;">
            <div id="loginForm">
                <input type="tel" id="lPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="login()">‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
            </div>
            <div id="regForm" class="hidden">
                <input type="text" id="rName" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç">
                <input type="text" id="rPlace" placeholder="‡¥∏‡µç‡¥•‡¥≤‡¥Ç">
                <input type="tel" id="rPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
                <button class="btn btn-green" onclick="register()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
            </div>
        </div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 id="displayMName" style="margin:0; color:var(--primary);">---</h2>
            <p id="displayDetails" style="margin:5px 0; color:#666;"></p>
        </div>
        <button id="topSaveBtn" class="btn btn-blue" onclick="saveAllData()">SAVE DATA ‚úÖ</button>
    </div>

    <div id="mainWorkArea">
        <div class="card">
            <h3>‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡¥≥‡µÜ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="selClass" style="width: 200px;"></select>
                <input type="number" id="inReg" placeholder="Reg No" style="width: 100px;">
                <input type="text" id="inName" placeholder="Student Name" style="width: 250px;">
                <button class="btn btn-green" style="width:auto" onclick="addStudent()">ADD</button>
            </div>
            <div id="studentListArea"></div>
        </div>

        <div class="card">
            <h3>‡¥µ‡¥ø‡¥∑‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="selSubClass" onchange="refreshSubList()" style="width: 200px;"></select>
                <input type="text" id="inSubName" placeholder="Subject Name" style="width: 250px;">
                <button class="btn btn-green" style="width:auto" onclick="addSubject()">ADD</button>
            </div>
            <div id="subjectListArea"></div>
        </div>

        <div class="card">
            <h3>‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥é‡µª‡¥ü‡µç‡¥∞‡¥ø & ‡¥π‡¥æ‡¥ú‡µº</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="selMarkClass" style="width: 200px;"></select>
                <input type="number" id="totalAttDays" placeholder="Total Working Days" style="width: 200px;">
                <button class="btn btn-blue" onclick="loadMainTable()">LOAD TABLE</button>
            </div>
            <div id="mainTableWrapper" style="overflow-x: auto;"></div>
        </div>
        <button id="finalSubmitBtn" class="btn btn-green" style="width:100%" onclick="finalSubmit()">PUBLISH TO SUPER ADMIN üöÄ</button>
    </div>

    <div id="photoWorkArea" class="hidden">
        <div class="card" style="text-align: center; border: 2px solid #2ecc71;">
            <h3 id="statusText">‡¥™‡µç‡¥∞‡µã‡¥∏‡¥∏‡µç‡¥∏‡¥ø‡¥Ç‡¥ó‡¥ø‡¥≤‡¥æ‡¥£‡µç...</h3>
            
            <div id="approvedSection" class="hidden">
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <p><strong>1. ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç (‡¥â‡¥∏‡µç‡¥§‡¥æ‡¥¶‡µÅ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç):</strong></p>
                    <span id="photoLinkDisp" class="link-box"></span>
                    <button class="btn btn-blue" onclick="copyText('photoLinkDisp')">COPY LINK</button>
                </div>

                <div class="card" style="box-shadow: none; border: 1px solid #ddd;">
                    <h3>2. ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç & ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ì‡¥™‡µç‡¥∑‡µª</h3>
                    <select id="selStatusClass" onchange="showPhotoStatusList()" style="width: 250px;"></select>
                    <div id="photoStatusTableArea"></div>
                </div>

                <div id="finalPublishStep" class="card" style="background: #fff3cd; border: 1px solid #ffeeba;">
                    <p>‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ‡¥Ø‡µÅ‡¥Ç ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã‡¥ï‡µæ ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µã? ‡¥é‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥Ç.</p>
                    <button id="btnFinalPub" class="btn btn-orange" onclick="makeFinalPublish()">FINAL PUBLISH (VIEW RESULT) üöÄ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="finalResultArea" class="hidden">
        <div class="card" style="text-align: center; background: #eef9f0; border: 2px solid #27ae60;">
            <h2 style="color: green;">‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ! ‚úÖ</h2>
            <p><strong>‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥≥‡µç‡¥≥ ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç:</strong></p>
            <span id="viewLinkDisp" class="link-box"></span>
            <button class="btn btn-red" onclick="copyText('viewLinkDisp')">COPY RESULT LINK</button>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥µ‡¥∞‡µÅ‡¥ü‡µÜ ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥ï‡¥æ‡¥£‡¥æ‡¥µ‡µÅ‡¥®‡µç‡¥®‡¥§‡¥æ‡¥£‡µç.</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = {};
    let currentDocId = "";
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6", "Class 7", "Class 8", "Class 9", "Class 10"];

    window.onload = () => {
        const clsHtml = '<option value="">‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('#selClass, #selSubClass, #selMarkClass, #selStatusClass').forEach(s => s.innerHTML = clsHtml);
    };

    function showAuth(t) {
        document.getElementById('loginForm').classList.toggle('hidden', t === 'R');
        document.getElementById('regForm').classList.toggle('hidden', t === 'L');
        document.getElementById('tabL').classList.toggle('active', t === 'L');
        document.getElementById('tabR').classList.toggle('active', t === 'R');
    }

    async function register() {
        const ph = document.getElementById('rPhone').value.trim();
        const n = document.getElementById('rName').value.trim();
        const p = document.getElementById('rPlace').value.trim();
        if(!ph || !n || !p) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
        
        const check = await db.collection("madrasa_data").doc(ph).get();
        if(check.exists) return alert("‡¥à ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥£‡µç‡¥ü‡µç!");

        const uID = "MID" + Math.floor(1000 + Math.random() * 9000);
        mData = { info: { name: n, place: p, phone: ph }, uID: uID, students: {}, subjects: {}, results: {}, attSettings: {}, photos: {}, isSubmitted: false, isApproved: false, isFinalPublished: false };
        await db.collection("madrasa_data").doc(ph).set(mData);
        alert("‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥ü‡µç‡¥∞‡µá‡¥∑‡µª ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ö‡µç‡¥ö‡µÅ!"); showAuth('L');
    }

    async function login() {
        const ph = document.getElementById('lPhone').value.trim();
        const doc = await db.collection("madrasa_data").doc(ph).get();
        if(doc.exists) { currentDocId = ph; mData = doc.data(); startPanel(); } else alert("‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥£‡µç!");
    }

    function startPanel() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('displayMName').innerText = mData.info.name;
        document.getElementById('displayDetails').innerText = mData.info.place;

        // ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥´‡µç‡¥≤‡µã ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ
        if(mData.isFinalPublished) {
            // ‡¥´‡µà‡¥®‡µΩ ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡¥æ‡µΩ ‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥Æ‡¥±‡¥ö‡µç‡¥ö‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï
            document.getElementById('mainWorkArea').classList.add('hidden');
            document.getElementById('photoWorkArea').classList.add('hidden');
            document.getElementById('topSaveBtn').classList.add('hidden');
            document.getElementById('finalResultArea').classList.remove('hidden');
            document.getElementById('viewLinkDisp').innerText = `https://mannanimuhsin-sys.github.io/my-website-1/misbahresultview.html?id=${mData.uID}`;
        } 
        else if(mData.isSubmitted) {
            // ‡¥∏‡¥¨‡µç‡¥Æ‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥Æ‡µÜ‡¥Ø‡¥ø‡µª ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥Æ‡¥±‡¥ö‡µç‡¥ö‡µç ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥è‡¥∞‡¥ø‡¥Ø ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï
            document.getElementById('mainWorkArea').classList.add('hidden');
            document.getElementById('topSaveBtn').classList.add('hidden');
            document.getElementById('photoWorkArea').classList.remove('hidden');
            
            if(mData.isApproved) {
                document.getElementById('statusText').innerText = "‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡µΩ ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ ‚úÖ";
                document.getElementById('approvedSection').classList.remove('hidden');
                document.getElementById('photoLinkDisp').innerText = `https://mannanimuhsin-sys.github.io/my-website-1/photoupload.html?id=${mData.uID}`;
                showPhotoStatusList();
            } else {
                document.getElementById('statusText').innerText = "‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡¥≤‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï... ‚è≥";
            }
        }
        refreshStList(); refreshSubList();
    }

    function addStudent() {
        const c = document.getElementById('selClass').value;
        const r = document.getElementById('inReg').value;
        const n = document.getElementById('inName').value;
        if(!c || !r || !n) return;
        if(!mData.students[c]) mData.students[c] = {};
        mData.students[c][r] = n;
        refreshStList();
    }

    function refreshStList() {
        let h = "";
        for(let c in mData.students) {
            h += `<h4>${c}</h4><table><tr><th>Reg</th><th>Name</th><th>Action</th></tr>`;
            for(let r in mData.students[c]) {
                h += `<tr><td>${r}</td><td>${mData.students[c][r]}</td><td><button class="btn-red" onclick="delete mData.students['${c}']['${r}']; refreshStList()">Delete</button></td></tr>`;
            }
            h += `</table>`;
        }
        document.getElementById('studentListArea').innerHTML = h;
    }

    function addSubject() {
        const c = document.getElementById('selSubClass').value;
        const s = document.getElementById('inSubName').value;
        if(!c || !s) return;
        if(!mData.subjects[c]) mData.subjects[c] = [];
        mData.subjects[c].push(s);
        refreshSubList();
    }

    function refreshSubList() {
        const c = document.getElementById('selSubClass').value;
        if(!c) { document.getElementById('subjectListArea').innerHTML = ""; return; }
        let h = `<table><tr><th>Subject</th><th>Action</th></tr>`;
        (mData.subjects[c] || []).forEach((s, i) => {
            h += `<tr><td>${s}</td><td><button class="btn-red" onclick="mData.subjects['${c}'].splice(${i},1); refreshSubList()">Delete</button></td></tr>`;
        });
        document.getElementById('subjectListArea').innerHTML = h + `</table>`;
    }

    function loadMainTable() {
        const c = document.getElementById('selMarkClass').value;
        if(!c) return alert("‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï");
        const studs = mData.students[c] || {};
        const subs = mData.subjects[c] || [];
        document.getElementById('totalAttDays').value = (mData.attSettings && mData.attSettings[c]) ? mData.attSettings[c] : "";
        
        let h = `<table><thead><tr><th>Reg</th><th>Name</th><th>Attendance</th>`;
        subs.forEach(s => h += `<th>${s}</th>`);
        h += `<th>Total</th><th>Status</th><th>Rank</th></tr></thead><tbody>`;
        
        for(let r in studs) {
            const res = (mData.results[c] && mData.results[c][r]) ? mData.results[c][r] : { marks: {}, att: '', total: 0, status: 'Passed', rank: '' };
            h += `<tr data-reg="${r}"><td>${r}</td><td style="text-align:left">${studs[r]}</td><td><input type="number" class="m-input s-att" value="${res.att}"></td>`;
            subs.forEach(s => h += `<td><input type="number" class="m-input s-mark" data-sub="${s}" value="${res.marks[s] || ''}" oninput="updateRow(this)"></td>`);
            h += `<td class="r-tot">${res.total}</td><td><select class="r-sts"><option value="Passed" ${res.status=='Passed'?'selected':''}>Passed</option><option value="Failed" ${res.status=='Failed'?'selected':''}>Failed</option><option value="Promotion" ${res.status=='Promotion'?'selected':''}>Promotion</option></select></td><td><input type="text" class="m-input r-rank" value="${res.rank || ''}"></td></tr>`;
        }
        document.getElementById('mainTableWrapper').innerHTML = h + `</tbody></table>`;
    }

    function updateRow(el) {
        const row = el.closest('tr');
        let tot = 0;
        row.querySelectorAll('.s-mark').forEach(i => tot += (parseInt(i.value) || 0));
        row.querySelector('.r-tot').innerText = tot;
    }

    function showPhotoStatusList() {
        const c = document.getElementById('selStatusClass').value;
        if(!c) return;
        const studs = mData.students[c] || {};
        const photos = mData.photos || {};
        let h = `<table><tr><th>Reg No</th><th>Name</th><th>Status</th><th>Action</th></tr>`;
        for(let r in studs) {
            const up = photos[r];
            h += `<tr><td>${r}</td><td>${studs[r]}</td><td>${up ? '<span class="status-up">Uploaded ‚úÖ</span>' : '<span class="status-pen">Pending ‚ùå</span>'}</td><td>${up ? `<button class="btn-red" style="padding:5px" onclick="deletePhoto('${r}')">Delete</button>` : '-'}</td></tr>`;
        }
        document.getElementById('photoStatusTableArea').innerHTML = h + `</table>`;
    }

    async function deletePhoto(r) {
        if(!confirm("‡¥à ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) return;
        delete mData.photos[r];
        await db.collection("madrasa_data").doc(currentDocId).update({ photos: mData.photos });
        showPhotoStatusList();
    }

    async function saveAllData() {
        const c = document.getElementById('selMarkClass').value;
        if(c) {
            if(!mData.attSettings) mData.attSettings = {};
            mData.attSettings[c] = document.getElementById('totalAttDays').value;
            if(!mData.results) mData.results = {};
            if(!mData.results[c]) mData.results[c] = {};
            document.querySelectorAll('#mainTableWrapper tbody tr').forEach(row => {
                const r = row.getAttribute('data-reg');
                let marks = {};
                row.querySelectorAll('.s-mark').forEach(i => marks[i.getAttribute('data-sub')] = i.value);
                mData.results[c][r] = { att: row.querySelector('.s-att').value, marks, total: row.querySelector('.r-tot').innerText, status: row.querySelector('.r-sts').value, rank: row.querySelector('.r-rank').value };
            });
        }
        await db.collection("madrasa_data").doc(currentDocId).update(mData);
        alert("‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
    }

    async function finalSubmit() {
        if(!confirm("‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡¥®‡µç ‡¥∏‡¥Æ‡µº‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥£‡µã? ‡¥™‡¥ø‡¥®‡µç‡¥®‡µÄ‡¥ü‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡µª ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥µ‡¥ø‡¥ö‡¥æ‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥£‡¥Ç.")) return;
        mData.isSubmitted = true;
        await saveAllData(); startPanel();
    }

    async function makeFinalPublish() {
        if(!confirm("‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã? ‡¥á‡¥§‡µç ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡¥æ‡µΩ ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µÅ‡¥ï‡µæ ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Æ‡µá ‡¥ï‡¥æ‡¥£‡¥æ‡µª ‡¥∏‡¥æ‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÇ.")) return;
        mData.isFinalPublished = true;
        await db.collection("madrasa_data").doc(currentDocId).update({ isFinalPublished: true });
        startPanel();
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text);
        alert("Copied!");
    }
</script>
</body>
</html>