<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Admin | Secured</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --dark-green: #004d00; --gold: #ffd700; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; }
        .header { background: var(--dark-green); color: white; padding: 25px; text-align: center; border-bottom: 5px solid var(--gold); }
        .container { max-width: 1200px; margin: 20px auto; padding: 15px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; min-width: 600px; }
        th { background: var(--dark-green); color: white; padding: 12px; border: 1px solid #ddd; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        
        /* ‡¥ü‡µá‡¥¨‡¥ø‡µæ ‡¥ï‡¥≥‡µç‡¥≥‡¥ø‡¥ï‡µæ ‡¥µ‡¥≤‡µÅ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡¥ø */
        .m-input { width: 70px !important; padding: 10px; text-align: center; font-weight: bold; font-size: 16px; border: 2px solid #ddd; }
        .s-name-cell { text-align: left; min-width: 180px; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-green { background: var(--dark-green); color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-promo { background: #007bff; color: white; } /* ‡¥™‡µç‡¥∞‡¥Æ‡µã‡¥∑‡µª ‡¥®‡µÄ‡¥≤ ‡¥®‡¥ø‡¥±‡¥Ç */
        
        .status-passed { color: green; font-weight: bold; }
        .status-failed { color: red; font-weight: bold; }
        .status-promo { color: #007bff; font-weight: bold; }
        
        .hidden { display: none; }
        .uploaded { color: #2ecc71; font-weight: bold; }
        .pending { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

<div id="authSection">
    <div class="header"><h1>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥æ‡¥®‡µΩ</h1></div>
    <div class="card" style="max-width:450px; margin: 40px auto; text-align:center;">
        <div id="loginForm">
            <h3>‡¥≤‡µã‡¥ó‡¥ø‡µª / ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº</h3>
            <input type="tel" id="userPhone" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï" style="width:100%"><br><br>
            <button class="btn btn-green" style="width:100%" onclick="handleAuth()">‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
            <p id="authMsg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
        
        <div id="regExtra" class="hidden">
            <input type="text" id="rName" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç" style="width:100%">
            <input type="text" id="rPlace" placeholder="‡¥∏‡µç‡¥•‡¥≤‡¥Ç" style="width:100%">
            <button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="completeRegistration()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥ü‡µç‡¥∞‡µá‡¥∑‡µª ‡¥™‡µÇ‡µº‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        </div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 id="displayMName" style="margin:0; color:var(--dark-green);">---</h2>
            <p id="displayDetails" style="margin:5px 0; color:#666;"></p>
        </div>
        <button class="btn btn-blue" onclick="saveAllData()">SAVE DATA ‚úÖ</button>
    </div>

    <div id="setupSection">
        <div class="card">
            <h3>‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡¥≥‡µÜ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <select id="selClass" style="width:200px;"></select>
                <input type="number" id="inReg" placeholder="Reg No" style="width:100px;">
                <input type="text" id="inName" placeholder="Student Name" style="width:250px;">
                <button class="btn btn-green" onclick="addStudent()">ADD</button>
            </div>
            <div id="studentListArea"></div>
        </div>

        <div class="card">
            <h3>‡¥µ‡¥ø‡¥∑‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h3>
            <div style="display:flex; gap:10px;">
                <select id="selSubClass" onchange="refreshSubList()" style="width:200px;"></select>
                <input type="text" id="inSubName" placeholder="Subject Name" style="width:250px;">
                <button class="btn btn-green" onclick="addSubject()">ADD</button>
            </div>
            <div id="subjectListArea"></div>
        </div>
    </div>

    <div class="card">
        <h3>‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥é‡µª‡¥ü‡µç‡¥∞‡¥ø & ‡¥π‡¥æ‡¥ú‡µº</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
            <select id="selMarkClass" style="width:200px;"></select>
            <input type="number" id="totalAttDays" placeholder="Total Working Days" style="width:180px;">
            <button class="btn btn-blue" onclick="loadMainTable()">LOAD TABLE</button>
        </div>
        <div id="mainTableWrapper" style="overflow-x:auto;"></div>
    </div>

    <div class="card">
        <button id="finalSubmitBtn" class="btn btn-green" style="width:100%; font-size:18px;" onclick="finalSubmit()">PUBLISH RESULTS üì¢</button>
        <div id="publishMsg" class="hidden" style="text-align:center; color:green; font-weight:bold;">‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ. ‡¥á‡¥®‡¥ø ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡¥∞‡µÅ‡¥§‡µç‡¥§‡¥æ‡µª ‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡¥®‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = {};
    let currentDocId = "";
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6", "Class 7", "Class 8", "Class 9", "Class 10"];

    window.onload = () => {
        const clsHtml = '<option value="">‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        document.querySelectorAll('#selClass, #selSubClass, #selMarkClass').forEach(s => s.innerHTML = clsHtml);
    }

    async function handleAuth() {
        const ph = document.getElementById('userPhone').value.trim();
        if(!ph) return alert("‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï");
        
        const doc = await db.collection("madrasa_data").doc(ph).get();
        if(doc.exists) {
            mData = doc.data();
            currentDocId = ph;
            loadAdminPanel();
        } else {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('regExtra').classList.remove('hidden');
        }
    }

    async function completeRegistration() {
        const ph = document.getElementById('userPhone').value.trim();
        const n = document.getElementById('rName').value.trim();
        const p = document.getElementById('rPlace').value.trim();
        if(!n || !p) return alert("‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï");

        mData = { info: { name: n, place: p, phone: ph }, uID: "MID"+Date.now(), students: {}, subjects: {}, results: {}, photos: {}, attSettings: {}, isSubmitted: false };
        await db.collection("madrasa_data").doc(ph).set(mData);
        currentDocId = ph;
        loadAdminPanel();
    }

    function loadAdminPanel() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('displayMName').innerText = mData.info.name;
        document.getElementById('displayDetails').innerText = mData.info.place;
        if(mData.isSubmitted) {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('finalSubmitBtn').classList.add('hidden');
            document.getElementById('publishMsg').classList.remove('hidden');
        }
        refreshStList();
    }

    function addStudent() {
        const c = document.getElementById('selClass').value;
        const r = document.getElementById('inReg').value;
        const n = document.getElementById('inName').value;
        if(!c || !r || !n) return;
        if(!mData.students[c]) mData.students[c] = {};
        mData.students[c][r] = n;
        refreshStList();
    }

    function refreshStList() {
        let h = "";
        for(let c in mData.students) {
            h += `<h4>${c}</h4><table><tr><th>Reg</th><th>Name</th><th>Action</th></tr>`;
            for(let r in mData.students[c]) {
                h += `<tr><td>${r}</td><td>${mData.students[c][r]}</td><td><button onclick="deleteStudent('${c}','${r}')">Delete</button></td></tr>`;
            }
            h += `</table>`;
        }
        document.getElementById('studentListArea').innerHTML = h;
    }

    function loadMainTable() {
        const c = document.getElementById('selMarkClass').value;
        if(!c) return alert("‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï");
        
        const studs = mData.students[c] || {};
        const subs = mData.subjects[c] || [];
        document.getElementById('totalAttDays').value = mData.attSettings?.[c] || "";

        let h = `<table><thead><tr><th>Reg</th><th class="s-name-cell">Name</th><th>Att.</th>`;
        subs.forEach(s => h += `<th>${s}</th>`);
        h += `<th>Total</th><th>Status</th></tr></thead><tbody>`;

        for(let r in studs) {
            const res = mData.results?.[c]?.[r] || { marks: {}, att: '', total: 0, status: 'Passed' };
            h += `<tr data-reg="${r}"><td>${r}</td><td class="s-name-cell">${studs[r]}</td>`;
            h += `<td><input type="number" class="m-input s-att" value="${res.att}"></td>`;
            
            let isFailed = false;
            subs.forEach(s => {
                let m = res.marks[s] || '';
                if(m !== '' && parseInt(m) < 18) isFailed = true;
                h += `<td><input type="number" class="m-input s-mark" data-sub="${s}" value="${m}" oninput="updateRow(this)"></td>`;
            });

            let statusHtml = `<select class="r-sts" onchange="updateRowStyle(this)">
                <option value="Passed" ${res.status=='Passed'?'selected':''}>Passed</option>
                <option value="Failed" ${res.status=='Failed'?'selected':''}>Failed</option>`;
            
            // 17 ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µã ‡¥§‡¥æ‡¥¥‡µÜ‡¥Ø‡µã ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç ‡¥™‡µç‡¥∞‡¥Æ‡µã‡¥∑‡µª ‡¥ì‡¥™‡µç‡¥∑‡µª
            if(isFailed) {
                statusHtml += `<option value="Promotion" ${res.status=='Promotion'?'selected':''}>Promotion</option>`;
            }
            statusHtml += `</select>`;

            h += `<td class="r-tot">${res.total}</td><td>${statusHtml}</td></tr>`;
        }
        document.getElementById('mainTableWrapper').innerHTML = h + `</tbody></table>`;
    }

    function updateRow(el) {
        const row = el.closest('tr');
        let tot = 0;
        let isFailed = false;
        row.querySelectorAll('.s-mark').forEach(i => {
            let val = parseInt(i.value) || 0;
            tot += val;
            if(val < 18) isFailed = true;
        });
        row.querySelector('.r-tot').innerText = tot;
        
        // ‡¥≤‡µã‡¥ú‡¥ø‡¥ï‡µç ‡¥Ö‡¥™‡µç‡¥°‡µá‡¥±‡µç‡¥±‡µç: 17 ‡¥§‡¥æ‡¥¥‡µÜ ‡¥µ‡¥®‡µç‡¥®‡¥æ‡µΩ ‡¥™‡µç‡¥∞‡¥Æ‡µã‡¥∑‡µª ‡¥ì‡¥™‡µç‡¥∑‡µª ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡µΩ ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡¥£‡¥Ç
        const sel = row.querySelector('.r-sts');
        const hasPromo = Array.from(sel.options).some(opt => opt.value === 'Promotion');
        if(isFailed && !hasPromo) {
            let opt = document.createElement('option');
            opt.value = 'Promotion'; opt.text = 'Promotion';
            sel.add(opt);
        } else if (!isFailed && hasPromo) {
            for (let i=0; i<sel.length; i++) {
                if(sel.options[i].value === 'Promotion') sel.remove(i);
            }
        }
    }

    async function saveAllData() {
        const c = document.getElementById('selMarkClass').value;
        if(c) {
            if(!mData.attSettings) mData.attSettings = {};
            mData.attSettings[c] = document.getElementById('totalAttDays').value;
            if(!mData.results) mData.results = {};
            if(!mData.results[c]) mData.results[c] = {};
            
            document.querySelectorAll('#mainTableWrapper tbody tr').forEach(row => {
                const r = row.getAttribute('data-reg');
                let marks = {};
                row.querySelectorAll('.s-mark').forEach(i => marks[i.getAttribute('data-sub')] = i.value);
                mData.results[c][r] = { 
                    att: row.querySelector('.s-att').value, 
                    marks: marks, 
                    total: row.querySelector('.r-tot').innerText, 
                    status: row.querySelector('.r-sts').value 
                };
            });
        }
        await db.collection("madrasa_data").doc(currentDocId).update(mData);
        alert("‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
    }

    async function finalSubmit() {
        if(!confirm("‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥™‡¥ø‡¥®‡µç‡¥®‡µÄ‡¥ü‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥Ç ‡¥µ‡¥∞‡µÅ‡¥§‡µç‡¥§‡¥æ‡µª ‡¥ï‡¥¥‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) return;
        mData.isSubmitted = true;
        await saveAllData();
        loadAdminPanel();
    }
</script>
</body>
</html>