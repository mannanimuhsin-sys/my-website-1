<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Photo Upload | Madrasa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .upload-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .header { background: #004d00; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        h2 { margin: 0; font-size: 20px; }
        .madrasa-name { color: #d35400; font-weight: bold; margin-bottom: 20px; }
        select, input, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-upload { background: #004d00; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-upload:hover { background: #006400; }
        #msg { margin-top: 15px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        .preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; border: 3px solid #004d00; display: none; }
    </style>
</head>
<body>

<div class="upload-card">
    <div class="header">
        <h2>ഫോട്ടോ അപ്‌ലോഡ്</h2>
    </div>
    <div id="madrasaName" class="madrasa-name">Loading...</div>
    
    <div id="formArea">
        <select id="studentSelect">
            <option value="">വിദ്യാർത്ഥിയെ തിരഞ്ഞെടുക്കുക</option>
        </select>
        
        <p style="text-align: left; font-size: 14px; margin-bottom: 5px;">ഫോട്ടോ തിരഞ്ഞെടുക്കുക:</p>
        <input type="file" id="photoInput" accept="image/*" onchange="previewImage(this)">
        <img id="imagePreview" class="preview">
        
        <button class="btn-upload" id="uploadBtn" onclick="uploadPhoto()">UPLOAD PHOTO ✅</button>
    </div>
    
    <div id="msg"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // നിങ്ങളുടെ അതേ Firebase Config
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const uID = urlParams.get('id');
    let madrasaDocId = "";

    // മദ്രസ ഡാറ്റയും കുട്ടികളുടെ ലിസ്റ്റും ലോഡ് ചെയ്യുന്നു
    if (uID) {
        db.collection("madrasa_data").where("uID", "==", uID).get().then(snap => {
            if (snap.empty) {
                document.getElementById('madrasaName').innerText = "Madrasa Not Found!";
                return;
            }
            snap.forEach(doc => {
                madrasaDocId = doc.id;
                const data = doc.data();
                document.getElementById('madrasaName').innerText = data.info.name;
                
                let select = document.getElementById('studentSelect');
                for (let c in data.students) {
                    for (let r in data.students[c]) {
                        let opt = document.createElement('option');
                        opt.value = r;
                        opt.innerText = `${data.students[c][r]} (${c} - Reg: ${r})`;
                        select.appendChild(opt);
                    }
                }
            });
        }).catch(err => {
            console.error("Error loading data:", err);
            document.getElementById('msg').innerHTML = "<span class='error'>ഡാറ്റ ലോഡ് ചെയ്യുന്നതിൽ പിഴവ് സംഭവിച്ചു!</span>";
        });
    }

    // ഫോട്ടോ പ്രിവ്യൂ കാണിക്കാൻ
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ഫോട്ടോ അപ്‌ലോഡ് ചെയ്യുന്ന ഫങ്ക്ഷൻ
    async function uploadPhoto() {
        const reg = document.getElementById('studentSelect').value;
        const file = document.getElementById('photoInput').files[0];
        const msg = document.getElementById('msg');
        const btn = document.getElementById('uploadBtn');

        if (!reg) return alert("ദയവായി വിദ്യാർത്ഥിയെ തിരഞ്ഞെടുക്കുക!");
        if (!file) return alert("ദയവായി ഒരു ഫോട്ടോ തിരഞ്ഞെടുക്കുക!");

        // ഫയൽ സൈസ് ചെക്ക് (പരമാവധി 1MB)
        if (file.size > 1024 * 1024) {
            return alert("ഫോട്ടോയുടെ സൈസ് വളരെ കൂടുതലാണ്. 1MB-യിൽ താഴെയുള്ള ഫോട്ടോ ഉപയോഗിക്കുക.");
        }

        btn.disabled = true;
        btn.innerText = "Uploading... ⏳";
        msg.innerHTML = "അപ്‌ലോഡ് ചെയ്യുന്നു, ദയവായി കാത്തിരിക്കൂ...";

        try {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Photo = e.target.result;
                
                // Firestore-ലേക്ക് ഫോട്ടോ സേവ് ചെയ്യുന്നു
                let updateData = {};
                updateData[`photos.${reg}`] = base64Photo;
                
                await db.collection("madrasa_data").doc(madrasaDocId).update(updateData);
                
                msg.innerHTML = "<span class='success'>ഫോട്ടോ വിജയകരമായി അപ്‌ലോഡ് ചെയ്തു! ✅</span>";
                btn.innerText = "UPLOAD COMPLETED ✅";
                alert("അപ്‌ലോഡ് പൂർത്തിയായി!");
            };
            reader.readAsDataURL(file);
        } catch (error) {
            console.error("Upload Error:", error);
            msg.innerHTML = "<span class='error'>അപ്‌ലോഡ് പരാജയപ്പെട്ടു! വീണ്ടും ശ്രമിക്കുക.</span>";
            btn.disabled = false;
            btn.innerText = "UPLOAD PHOTO ✅";
        }
    }
</script>

</body>
</html>