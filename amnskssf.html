<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ MASTER ADMIN</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding-bottom: 50px; }
        .tabs { display: flex; background: #004d00; position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: #003300; border-bottom: 4px solid #f1c40f; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: #27ae60; } .btn-red { background: #c0392b; } .btn-blue { background: #2980b9; }
        .q-item { background: #fafafa; padding: 15px; border-radius: 10px; border-left: 6px solid #004d00; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #004d00; color: white; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'questions')">ചോദ്യങ്ങൾ ചേർക്കുക</button>
    <button class="tab-btn" onclick="openTab(event, 'results')">റിസൾട്ട് & കൺട്രോൾ</button>
</div>

<div id="questions" class="tab-content container">
    <div class="card">
        <h3>പുതിയ ചോദ്യം</h3>
        <textarea id="qText" rows="3" placeholder="ചോദ്യം ടൈപ്പ് ചെയ്യുക..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="o0" placeholder="Option 1">
            <input type="text" id="o1" placeholder="Option 2">
            <input type="text" id="o2" placeholder="Option 3">
            <input type="text" id="o3" placeholder="Option 4">
        </div>
        <select id="correct">
            <option value="0">Option 1 ശരിയുത്തരം</option>
            <option value="1">Option 2 ശരിയുത്തരം</option>
            <option value="2">Option 3 ശരിയുത്തരം</option>
            <option value="3">Option 4 ശരിയുത്തരം</option>
        </select>
        <button class="btn btn-green" onclick="addQuestion()" style="width:100%">SAVE QUESTION</button>
    </div>
    <div class="card">
        <h3>ചേർത്ത ചോദ്യങ്ങൾ (<span id="qCount">0</span>)</h3>
        <div id="qDisplay"></div>
    </div>
</div>

<div id="results" class="tab-content container" style="display:none;">
    <div class="card">
        <h3>ക്വിസ് കൺട്രോൾ</h3>
        Start Time: <input type="datetime-local" id="startTime">
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn btn-blue" onclick="statusUpdate('time')">SET TIME</button>
            <button class="btn btn-green" onclick="statusUpdate('live')">PUBLISH LIVE</button>
            <button class="btn btn-red" onclick="statusUpdate('stop')">STOP QUIZ</button>
            <button class="btn" style="background:#f1c40f; color:black;" onclick="statusUpdate('poster')">SHOW POSTERS</button>
        </div>
    </div>

    <div class="card">
        <h3>മാർക്ക് ലിസ്റ്റ് (Marks & Time Based Rank)</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Rank</th><th>ID</th><th>Name</th><th>Branch</th><th>Mobile</th><th>Score</th><th>Time</th><th>Action</th></tr>
                </thead>
                <tbody id="resBody"></tbody>
            </table>
        </div>
    </div>
    <button class="btn btn-red" style="width:100%" onclick="resetQuiz()">RESET ENTIRE QUIZ</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function openTab(e, t) {
    document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.getElementById(t).style.display = "block";
    e.currentTarget.classList.add("active");
    if(t==='results') loadRes();
}

async function addQuestion() {
    const text = document.getElementById('qText').value;
    const options = [document.getElementById('o0').value, document.getElementById('o1').value, document.getElementById('o2').value, document.getElementById('o3').value];
    const correct = document.getElementById('correct').value;
    if(!text || options.includes("")) return alert("പൂർണ്ണമായി പൂരിപ്പിക്കുക");
    await db.collection("questions").add({ text, options, correct });
    alert("Saved!"); location.reload();
}

async function loadQuestions() {
    const s = await db.collection("questions").get();
    document.getElementById("qCount").innerText = s.size;
    let h = "";
    s.forEach(doc => h += `<div class="q-item"><b>${doc.data().text}</b><br><small>${doc.data().options.join(" | ")}</small></div>`);
    document.getElementById("qDisplay").innerHTML = h;
}

async function statusUpdate(type) {
    const ref = db.collection("quiz_settings").doc("status");
    if(type==='time') await ref.set({ startTime: document.getElementById('startTime').value }, {merge:true});
    if(type==='live') await ref.update({ published: true, closed: false });
    if(type==='stop') await ref.update({ closed: true, published: false });
    if(type==='poster') await ref.update({ showPosters: true });
    alert("Updated!");
}

async function loadRes() {
    const qSnap = await db.collection("questions").get();
    let correctMap = {}; qSnap.forEach(d => correctMap[d.id] = d.data().correct);
    const rSnap = await db.collection("results").get();
    let res = [];
    rSnap.forEach(doc => {
        let s = 0; const d = doc.data();
        for(let qid in correctMap) { if(d.answers && d.answers[qid] == correctMap[qid]) s++; }
        let t = d.submitTime ? d.submitTime.toDate().toLocaleTimeString() : "--";
        res.push({...d, score: s, timeStr: t});
    });
    res.sort((a,b) => b.score - a.score || a.submitTime - b.submitTime);
    
    const winDoc = await db.collection("winners").doc("list").get();
    let winIds = winDoc.exists ? winDoc.data().winnerIds || [] : [];

    let h = "";
    res.forEach((r, i) => {
        const isW = winIds.includes(r.regId.toString());
        h += `<tr style="background:${isW?'#dcfce7':''}"><td>${i+1}</td><td>${r.regId}</td><td>${r.name}</td><td>${r.branch}</td><td>${r.mobile}</td><td><b>${r.score}</b></td><td>${r.timeStr}</td>
        <td><button onclick="markWinner('${r.regId}', ${!isW})">${isW?'Remove':'Winner'}</button></td></tr>`;
    });
    document.getElementById("resBody").innerHTML = h;
}

async function markWinner(id, add) {
    const doc = await db.collection("winners").doc("list").get();
    let list = doc.exists ? doc.data().winnerIds || [] : [];
    if(add) list.push(id.toString()); else list = list.filter(l => l != id.toString());
    await db.collection("winners").doc("list").set({ winnerIds: list });
    loadRes();
}

async function resetQuiz() {
    if(!confirm("പൂർണ്ണമായും ഡാറ്റ ഡിലീറ്റ് ചെയ്യണോ?")) return;
    const cols = ['questions','results','winners','participants'];
    for(let c of cols) {
        const s = await db.collection(c).get();
        const b = db.batch(); s.forEach(d => b.delete(d.ref)); await b.commit();
    }
    alert("Reset Complete!"); location.reload();
}
loadQuestions();
</script>
</body>
</html>