<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSSF QUIZ - Verified Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --red: #c0392b; --blue: #2980b9; --purple: #8e44ad; }
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; margin: 0; padding: 15px; }
        .admin-container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid var(--primary); }
        h2 { color: var(--primary); font-size: 19px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white !important; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: var(--purple); color: white; }

        .info-display { background: #fffde7; border: 2px dashed var(--blue); padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        
        .rank-grid { display: flex; gap: 15px; margin-bottom: 20px; }
        .rank-btn { flex: 1; padding: 20px 10px; border: 2px solid #ddd; border-radius: 15px; background: white; cursor: pointer; text-align: center; }
        .rank-btn.active { border-color: var(--gold); background: #fffde7; transform: scale(1.03); border-width: 3px; }

        .table-area { overflow-x: auto; max-height: 450px; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f8f9fa; padding: 15px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; line-height: 1.5; }
        
        .score-badge { background: #27ae60; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .q-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1 style="text-align:center; color: var(--primary); font-weight: 800; text-transform: uppercase;">SKSSF ADMIN MASTER CONTROL</h1>

    <div class="card" style="border-top-color: var(--blue);">
        <h2><i class="fa fa-search-plus"></i> ‡¥Ø‡µÇ‡¥∏‡µº ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡µº (ID ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç)</h2>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="trackId" placeholder="ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï (eg: 1001)" style="margin:0;">
            <button class="btn btn-blue" onclick="findUser()" style="width: 120px;">FIND</button>
        </div>
        <div id="userInfoBox" class="info-display"><div id="uDetailContent"></div></div>
    </div>

    <div class="card">
        <h2><i class="fa fa-folder-plus"></i> ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥Æ‡¥æ‡¥®‡µá‡¥ú‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</h2>
        <textarea id="qText" placeholder="‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..."></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="opt0" placeholder="Option 1">
            <input type="text" id="opt1" placeholder="Option 2">
            <input type="text" id="opt2" placeholder="Option 3">
            <input type="text" id="opt3" placeholder="Option 4">
        </div>
        <select id="correctOpt">
            <option value="0">Option 1 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="1">Option 2 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="2">Option 3 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="3">Option 4 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
        </select>
        <button class="btn btn-green" onclick="addQuestion()">ADD QUESTION</button>
        <button class="btn btn-purple" style="margin-top:10px" onclick="publishQuizToUsers()">PUBLISH ALL TO USERS</button>
        <div id="questionsList" style="margin-top:15px; font-size: 13px;"></div>
    </div>

    <div class="card">
        <h2><i class="fa fa-power-off"></i> ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ</h2>
        <label style="font-size: 12px; font-weight: bold;">‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï:</label>
        <input type="datetime-local" id="quizTime">
        <button class="btn btn-green" onclick="updateTime()">SET TIMER</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-red" onclick="toggleQuiz(true)"><i class="fa fa-stop-circle"></i> STOP QUIZ NOW</button>
            <button class="btn" style="background:#2ecc71; color:white;" onclick="toggleQuiz(false)">RESUME QUIZ</button>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-chart-line"></i> ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç & ‡¥±‡¥æ‡¥ô‡µç‡¥ï‡µç ‡¥∏‡µÜ‡¥≤‡¥ï‡µç‡¥∑‡µª</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="search" onkeyup="searchResult()" placeholder="‡¥™‡µá‡¥∞‡µç, ‡¥ê‡¥°‡¥ø, ‡¥¨‡µç‡¥∞‡¥æ‡¥û‡µç‡¥ö‡µç ‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï..." style="margin:0;">
            <button class="btn btn-red" onclick="resetEntireQuiz()" style="width: 200px; font-size: 11px; background: #c0392b !important;"><i class="fa fa-sync-alt"></i> FULL RESET QUIZ</button>
        </div>
        
        <div class="rank-grid">
            <div id="rb1" class="rank-btn" onclick="setRank(1)">ü•á<br>1st PRIZE</div>
            <div id="rb2" class="rank-btn" onclick="setRank(2)">ü•à<br>2nd PRIZE</div>
            <div id="rb3" class="rank-btn" onclick="setRank(3)">ü•â<br>3rd PRIZE</div>
        </div>

        <div class="table-area">
            <table>
                <thead>
                <tr><th>ID & Name</th><th>Mobile & Branch</th><th>Score</th><th>Submitted Time</th><th>Action</th></tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>

        <div style="margin-top:20px; padding:20px; background:#fffde7; border-radius:15px; border: 2px solid var(--gold);">
            <p style="margin:0 0 10px 0; font-weight: bold; color: var(--primary);">‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ (ID ‡¥∏‡¥π‡¥ø‡¥§‡¥Ç ‡¥™‡µã‡¥∏‡µç‡¥±‡µç‡¥±‡¥±‡¥ø‡µΩ ‡¥µ‡¥∞‡µÅ‡¥Ç):</p>
            <div id="wList" style="font-size:15px; font-weight:bold; color:var(--red); line-height: 1.8;">
                1st Prize: <span id="s1">-</span><br>
                2nd Prize: <span id="s2">-</span><br>
                3rd Prize: <span id="s3">-</span>
            </div>
            <button class="btn btn-gold" style="margin-top:10px;" onclick="publishWinners()">PUBLISH OFFICIAL POSTER</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pickRank = 0; 
let winnersData = { 1: {id:null, name:null}, 2: {id:null, name:null}, 3: {id:null, name:null} };

// 1. FULL RESET (‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ, ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ, ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ ‡¥ï‡µç‡¥≤‡¥ø‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ)
async function resetEntireQuiz() {
    if(confirm("‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï! ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç, ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µÅ‡¥Ç, ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥Ç ‡¥Æ‡¥æ‡¥û‡µç‡¥û‡µÅ‡¥™‡µã‡¥ï‡µÅ‡¥Ç. ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥æ‡µª ‡¥á‡¥§‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) {
        // ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
        const qSnap = await db.collection("questions").get();
        qSnap.forEach(doc => doc.ref.delete());
        
        // ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
        const rSnap = await db.collection("results").get();
        rSnap.forEach(doc => doc.ref.delete());

        // ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        await db.collection("winners").doc("list").delete().catch(e => console.log("No winners to delete"));

        // ‡¥∏‡µÜ‡¥±‡µç‡¥±‡¥ø‡¥Ç‡¥ó‡µç‡¥∏‡µç ‡¥™‡¥¥‡¥Ø ‡¥™‡¥ü‡¥ø‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        await db.collection("quiz_settings").doc("status").set({
            closed: true,
            showPosters: false,
            questionsPublished: false,
            startTime: ""
        });

        alert("‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥Ç ‡¥±‡µÄ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ. ‡¥á‡¥®‡¥ø ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡¥æ‡¥Ç.");
        location.reload();
    }
}

// 2. USER TRACKER FINDER
async function findUser() {
    const id = document.getElementById('trackId').value;
    const doc = await db.collection("participants").doc(id).get();
    if(doc.exists) {
        const d = doc.data();
        document.getElementById('uDetailContent').innerHTML = `<b>‡¥™‡µá‡¥∞‡µç:</b> ${d.name}<br><b>‡¥Æ‡µä‡¥¨‡µà‡µΩ:</b> ${d.mobile}<br><b>‡¥∂‡¥æ‡¥ñ:</b> ${d.branch}<br><b>ID:</b> ${d.regId}`;
        document.getElementById('userInfoBox').style.display = 'block';
    } else { alert("ID ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥£‡µç!"); }
}

// 3. QUESTIONS MANAGEMENT
async function addQuestion() {
    const text = document.getElementById('qText').value;
    const options = [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value, document.getElementById('opt3').value];
    const correct = parseInt(document.getElementById('correctOpt').value);
    if(!text || options.includes("")) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");
    await db.collection("questions").add({ text, options, correct, createdAt: new Date() });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ!");
    document.getElementById('qText').value = "";
    document.querySelectorAll('input[placeholder^="Option"]').forEach(i => i.value = "");
}

db.collection("questions").orderBy("createdAt", "desc").onSnapshot(snap => {
    let h = ""; snap.forEach(doc => { h += `<div class="q-item"><span>${doc.data().text}</span><i class="fa fa-trash" style="color:red; cursor:pointer;" onclick="deleteQ('${doc.id}')"></i></div>`; });
    document.getElementById('questionsList').innerHTML = h;
});

async function deleteQ(id) { if(confirm("‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) await db.collection("questions").doc(id).delete(); }

async function publishQuizToUsers() {
    await db.collection("quiz_settings").doc("status").update({ questionsPublished: true });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
}

// 4. TIMER & STOP
async function updateTime() {
    const t = document.getElementById('quizTime').value;
    if(!t) return alert("‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
    await db.collection("quiz_settings").doc("status").set({ startTime: t, closed: false, showPosters: false }, {merge:true});
    alert("Timer Published!");
}

async function toggleQuiz(st) { 
    await db.collection("quiz_settings").doc("status").update({ closed: st }); 
    alert(st ? "Quiz Stopped Successfully" : "Quiz Resumed Successfully");
}

// 5. RESULTS DISPLAY
db.collection("results").onSnapshot(snap => {
    let res = []; snap.forEach(doc => res.push(doc.data()));
    res.sort((a,b) => b.score - a.score || a.time - b.time);
    let h = "";
    res.forEach(d => {
    // ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤‡¥ø‡¥∏‡µÜ‡¥ï‡µç‡¥ï‡¥®‡µç‡¥±‡µç ‡¥∏‡¥π‡¥ø‡¥§‡¥Ç ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    let submitTime = "N/A";
    if (d.time) {
        let date = d.time.toDate ? d.time.toDate() : new Date(d.time);
        submitTime = date.getHours().toString().padStart(2, '0') + ":" + 
                     date.getMinutes().toString().padStart(2, '0') + ":" + 
                     date.getSeconds().toString().padStart(2, '0') + ":" + 
                     date.getMilliseconds().toString().padStart(3, '0');
    }

    h += `<tr>
        <td><b style="color:var(--blue)">#${d.regId}</b><br>${d.name}</td>
        <td>${d.mobile || 'N/A'}<br><small>${d.branch || 'N/A'}</small></td>
        <td><span class="score-badge">${d.score !== undefined ? d.score : 0}</span></td>
        <td><b style="color:var(--red); font-size:11px;">${submitTime}</b></td>
        <td><button class="btn btn-green" style="padding:6px 12px; font-size:10px;" onclick="confirmWinner('${d.regId}','${d.name}')">PICK</button></td>
    </tr>`;
});
    document.getElementById('resultBody').innerHTML = h;
});

function setRank(r) { pickRank = r; document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('active')); document.getElementById('rb'+r).classList.add('active'); }

function confirmWinner(id, name) { 
    if(pickRank===0) return alert("‡¥Ü‡¥¶‡µç‡¥Ø‡¥Ç ‡¥™‡µç‡¥∞‡µà‡¥∏‡µç ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ (1st, 2nd, 3rd) ‡¥Ö‡¥Æ‡µº‡¥§‡µç‡¥§‡µÅ‡¥ï!"); 
    winnersData[pickRank] = {id: id, name: name};
    document.getElementById('s'+pickRank).innerText = `${name} (ID: ${id})`; 
}

async function publishWinners() { 
    if(!winnersData[1].id || !winnersData[2].id || !winnersData[3].id) return alert("3 ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÜ‡¥Ø‡µÅ‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡¥£‡¥Ç!");
    await db.collection("winners").doc("list").set({ 
        ranks: { 1: winnersData[1].id, 2: winnersData[2].id, 3: winnersData[3].id },
        names: { 1: winnersData[1].name, 2: winnersData[2].name, 3: winnersData[3].name }
    }); 
    await db.collection("quiz_settings").doc("status").update({ showPosters: true, closed: true }); 
    alert("‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÜ ‡¥ê‡¥°‡¥ø ‡¥∏‡¥π‡¥ø‡¥§‡¥Ç ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!"); 
}

function searchResult() {
    let input = document.getElementById("search").value.toUpperCase();
    let rows = document.getElementById("resultBody").getElementsByTagName("tr");
    for (let row of rows) { row.style.display = row.textContent.toUpperCase().includes(input) ? "" : "none"; }
}
</script>
</body>
</html>