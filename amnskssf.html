<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Admin - SKSSF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --dark: #1a1a1a; }
        body { font-family: 'Poppins', sans-serif; background: #eef2f3; margin: 0; padding: 20px; }
        .admin-container { max-width: 900px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary); }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        .btn-start { background: var(--primary); color: white; }
        .btn-stop { background: #c0392b; color: white; }
        .btn-publish { background: var(--gold); color: black; width: 100%; margin-top: 15px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); }

        .rank-btn { padding: 5px 10px; font-size: 11px; margin-right: 5px; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; }
        .rank-1 { background: gold; }
        .rank-2 { background: silver; }
        .rank-3 { background: #cd7f32; color: white; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .live { background: #d4edda; color: #155724; }
        .stopped { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1 style="text-align:center; color: var(--primary);">SKSSF QUIZ ADMIN PANEL</h1>

    <div class="card">
        <h2><i class="fa fa-cog"></i> Quiz Status Control</h2>
        <div class="controls">
            <div>
                <label>Start Date & Time</label>
                <input type="datetime-local" id="quizStartTime">
                <button class="btn btn-start" style="margin-top:10px; width:100%;" onclick="updateTime()">Set Timer & Open</button>
            </div>
            <div style="text-align: center;">
                <label>Quick Actions</label><br><br>
                <button class="btn btn-stop" onclick="toggleQuiz(true)">STOP QUIZ NOW</button>
                <button class="btn btn-start" onclick="toggleQuiz(false)">RESUME QUIZ</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-trophy"></i> Winner Selection</h2>
        <div id="winnerDisplay" style="background: #fdf9e7; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; color: #856404;">
            Selected: 1st: <span id="w1">-</span> | 2nd: <span id="w2">-</span> | 3rd: <span id="w3">-</span>
        </div>
        
        <div style="overflow-x: auto;">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Branch</th>
                        <th>Score/Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    </tbody>
            </table>
        </div>
        <button class="btn btn-publish" onclick="publishWinners()">PUBLISH WINNERS TO USER PAGE</button>
    </div>

    <div class="card" style="border: 1px solid #f8d7da;">
        <h2 style="color: #c0392b;">Danger Zone</h2>
        <p style="font-size: 12px; color: #666;">ഇത് അമർത്തിയാൽ ഇതുവരെയുള്ള എല്ലാ രജിസ്‌ട്രേഷനും റിസൾട്ടും ഡിലീറ്റ് ആകും!</p>
        <button class="btn btn-stop" style="width: 100%;" onclick="resetAllData()">RESET ENTIRE QUIZ DATA</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selectedWinners = { 1: null, 2: null, 3: null };

// ടൈമർ സെറ്റ് ചെയ്യാൻ
async function updateTime() {
    const time = document.getElementById('quizStartTime').value;
    if(!time) return alert("ദയവായി സമയം നൽകുക");
    await db.collection("quiz_settings").doc("status").update({
        startTime: time,
        closed: false,
        showPosters: false
    });
    alert("സമയക്രമം മാറ്റിയിരിക്കുന്നു");
}

// ക്വിസ് നിർത്താൻ/തുടങ്ങാൻ
async function toggleQuiz(isStop) {
    await db.collection("quiz_settings").doc("status").update({
        closed: isStop,
        showPosters: false
    });
    alert(isStop ? "ക്വിസ് നിർത്തിവെച്ചു" : "ക്വിസ് പുനരാരംഭിച്ചു");
}

// റിസൾട്ടുകൾ കാണിക്കാൻ
db.collection("results").onSnapshot(snap => {
    let h = "";
    snap.forEach(doc => {
        const d = doc.data();
        h += `<tr>
            <td>${d.regId}</td>
            <td>${d.name}</td>
            <td>${d.branch}</td>
            <td>${Object.keys(d.answers || {}).length} Ans</td>
            <td>
                <button class="rank-btn rank-1" onclick="selectRank(1, '${d.regId}', '${d.name}')">1st</button>
                <button class="rank-btn rank-2" onclick="selectRank(2, '${d.regId}', '${d.name}')">2nd</button>
                <button class="rank-btn rank-3" onclick="selectRank(3, '${d.regId}', '${d.name}')">3rd</button>
            </td>
        </tr>`;
    });
    document.getElementById('resultsBody').innerHTML = h;
});

function selectRank(rank, id, name) {
    selectedWinners[rank] = id;
    document.getElementById(`w${rank}`).innerText = name;
}

// വിജയികളെ പബ്ലിഷ് ചെയ്യാൻ
async function publishWinners() {
    if(!selectedWinners[1] || !selectedWinners[2] || !selectedWinners[3]) {
        return alert("മൂന്ന് വിജയികളെയും തിരഞ്ഞെടുക്കുക!");
    }
    await db.collection("winners").doc("list").set({ ranks: selectedWinners });
    await db.collection("quiz_settings").doc("status").update({ showPosters: true, closed: true });
    alert("വിജയികളെ പ്രഖ്യാപിച്ചു! ഇപ്പോൾ എല്ലാവർക്കും വിന്നർ പോസ്റ്റർ കാണാൻ സാധിക്കും.");
}

// ഡാറ്റ ക്ലീൻ ചെയ്യാൻ
async function resetAllData() {
    if(!confirm("എല്ലാ ഡാറ്റയും ഡിലീറ്റ് ചെയ്യട്ടെ?")) return;
    // Note: Firebase delete requires loop or cloud function, here we just alert simple way
    alert("ഡാറ്റ റീസെറ്റ് ചെയ്യാൻ ഫയർബേസ് കൺസോൾ ഉപയോഗിക്കുക അല്ലെങ്കിൽ എക്സ്റ്റൻഷൻ ഉപയോഗിക്കുക.");
}
</script>
</body>
</html>