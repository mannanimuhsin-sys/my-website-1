<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ ADMIN - SKSSF CHAPPARAPPADAV</title>
    <style>
        :root { --admin-bg: #f0f2f5; --primary: #004d00; --gold: #f1c40f; }
        body { font-family: sans-serif; background: var(--admin-bg); margin: 0; }
        .nav { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 25px; border-top: 5px solid var(--primary); }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-red { background: #c0392b; }
        .btn-gold { background: var(--gold); color: black; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; color: var(--primary); }
        .winner-row { background: #fff9e6 !important; }
        .win-toggle { padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; font-size: 12px; }
        .is-win { background: var(--gold); font-weight: bold; border-color: orange; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; background: #ddd; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .tab-link.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: bold; font-size: 1.2rem;">SKSSF QUIZ ADMIN</div>
    <div style="font-size: 0.9rem;">Muhsin Mannani | +91 7559950633</div>
</div>

<div class="container">
    <div class="tabs">
        <div class="tab-link active" onclick="switchTab('qTab')">QUESTIONS</div>
        <div class="tab-link" onclick="switchTab('rTab')">RESULTS & CONTROL</div>
    </div>

    <div id="qTab" class="tab-content">
        <div class="card">
            <h3>പുതിയ ചോദ്യം ചേർക്കുക</h3>
            <textarea id="qText" rows="3" placeholder="ചോദ്യം ഇവിടെ ടൈപ്പ് ചെയ്യുക..."></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="o0" placeholder="Option 1">
                <input type="text" id="o1" placeholder="Option 2">
                <input type="text" id="o2" placeholder="Option 3">
                <input type="text" id="o3" placeholder="Option 4">
            </div>
            <select id="correct">
                <option value="0">Option 1 ശരിയുത്തരം</option>
                <option value="1">Option 2 ശരിയുത്തരം</option>
                <option value="2">Option 3 ശരിയുത്തരം</option>
                <option value="3">Option 4 ശരിയുത്തരം</option>
            </select>
            <button class="btn btn-green" onclick="saveQuestion()" style="width:100%">SAVE QUESTION</button>
        </div>
        <div class="card">
            <h3>ചേർത്ത ചോദ്യങ്ങൾ (<span id="qCount">0</span>)</h3>
            <div id="qList"></div>
        </div>
    </div>

    <div id="rTab" class="tab-content" style="display:none;">
        <div class="card">
            <h3>ക്വിസ് കൺട്രോൾ പാനൽ</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>മത്സരം തുടങ്ങുന്ന സമയം:</label>
                    <input type="datetime-local" id="startTime">
                    <button class="btn btn-blue" style="width:100%" onclick="updateControl('time')">SET TIME</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; justify-content: center;">
                    <button class="btn btn-green" onclick="updateControl('live')">PUBLISH LIVE NOW</button>
                    <button class="btn btn-red" onclick="updateControl('stop')">STOP QUIZ (END)</button>
                    <button class="btn btn-gold" onclick="updateControl('poster')">PUBLISH POSTERS TO USERS</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>റാങ്ക് ലിസ്റ്റ് (Score & Time Based)</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th><th>ID</th><th>Name</th><th>Branch</th><th>Score</th><th>Time</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config (അതേ Config തന്നെ ഉപയോഗിക്കുക)
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
    document.getElementById(tabId).style.display = 'block';
    event.currentTarget.classList.add('active');
    if(tabId === 'rTab') loadResults();
}

async function saveQuestion() {
    const text = document.getElementById('qText').value;
    const options = [document.getElementById('o0').value, document.getElementById('o1').value, document.getElementById('o2').value, document.getElementById('o3').value];
    const correct = document.getElementById('correct').value;
    if(!text || options.includes("")) return alert("Fill all fields");
    await db.collection("questions").add({ text, options, correct });
    alert("Saved!"); location.reload();
}

async function updateControl(type) {
    const ref = db.collection("quiz_settings").doc("status");
    if(type==='time') await ref.set({ startTime: document.getElementById('startTime').value }, {merge:true});
    if(type==='live') await ref.update({ published: true, closed: false, showPosters: false });
    if(type==='stop') await ref.update({ closed: true, published: false });
    if(type==='poster') await ref.update({ showPosters: true });
    alert("ക്വിസ് സെറ്റിംഗ്സ് അപ്ഡേറ്റ് ചെയ്തു!");
}

async function loadResults() {
    const qSnap = await db.collection("questions").get();
    let correctMap = {}; 
    qSnap.forEach(d => correctMap[d.id] = d.data().correct);
    
    const rSnap = await db.collection("results").get();
    let res = [];
    rSnap.forEach(doc => {
        let score = 0; 
        const d = doc.data();
        for(let qid in correctMap) {
            if(d.answers && d.answers[qid] == correctMap[qid]) score++;
        }
        res.push({...d, score, timeVal: d.submitTime ? d.submitTime.toDate().getTime() : 0, timeStr: d.submitTime ? d.submitTime.toDate().toLocaleTimeString() : '--'});
    });

    // Sort by Score (High to Low) then Time (Fast to Slow)
    res.sort((a,b) => b.score - a.score || a.timeVal - b.timeVal);
    
    const winSnap = await db.collection("winners").doc("list").get();
    const winIds = winSnap.exists ? winSnap.data().winnerIds || [] : [];

    let h = "";
    res.forEach((r, i) => {
        const isWin = winIds.includes(r.regId.toString());
        h += `<tr class="${isWin ? 'winner-row' : ''}">
            <td>${i+1}</td>
            <td>${r.regId}</td>
            <td>${r.name}</td>
            <td>${r.branch}</td>
            <td><b>${r.score}</b></td>
            <td>${r.timeStr}</td>
            <td><button class="win-toggle ${isWin ? 'is-win' : ''}" onclick="toggleWinner('${r.regId}')">${isWin ? 'Winner ✅' : 'Select'}</button></td>
        </tr>`;
    });
    document.getElementById("resultTableBody").innerHTML = h;
}

async function toggleWinner(id) {
    const doc = await db.collection("winners").doc("list").get();
    let list = doc.exists ? doc.data().winnerIds || [] : [];
    id = id.toString();
    if(list.includes(id)) list = list.filter(l => l !== id);
    else list.push(id);
    await db.collection("winners").doc("list").set({ winnerIds: list });
    loadResults();
}

async function loadQList() {
    const snap = await db.collection("questions").get();
    document.getElementById("qCount").innerText = snap.size;
    let h = "";
    snap.forEach(doc => {
        h += `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${doc.data().text}</b></div>`;
    });
    document.getElementById("qList").innerHTML = h;
}
loadQList();
</script>
</body>
</html>