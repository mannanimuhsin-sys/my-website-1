<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ ADMIN PRO - MOBILE FRIENDLY</title>
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --dark: #121212; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; padding-bottom: 50px; }
        .tab-bar { display: flex; background: #1a1a1a; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #888; font-weight: bold; cursor: pointer; }
        .tab-btn.active { color: var(--gold); border-bottom: 3px solid var(--gold); background: #222; }
        
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
        h3 { color: var(--gold); margin-top: 0; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; box-sizing: border-box; }
        
        .opt-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .radio-btn { width: 20px; height: 20px; accent-color: var(--gold); }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-gold { background: var(--gold); color: #000; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { padding: 10px; border: 1px solid #333; text-align: left; }
        th { background: #222; color: var(--gold); }
        .winner-row { background: #004d00 !important; }
        .reset-section { text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid #333; }
    </style>
</head>
<body>

<div class="tab-bar">
    <button class="tab-btn active" onclick="openTab(event, 'questions')">QUESTIONS</button>
    <button class="tab-btn" onclick="openTab(event, 'results')">RESULTS & WINNERS</button>
</div>

<div id="questions" class="tab-content container">
    <div class="card">
        <h3>1. ക്വിസ് സമയം സെറ്റ് ചെയ്യുക</h3>
        തുടങ്ങുന്ന സമയം: <input type="datetime-local" id="startTime">
        <button class="btn btn-blue" onclick="saveSettings()">SAVE TIME</button>
    </div>

    <div class="card">
        <h3>2. ചോദ്യങ്ങൾ ചേർക്കുക</h3>
        <textarea id="qText" rows="3" placeholder="ചോദ്യം ഇവിടെ നൽകുക..."></textarea>
        
        <p style="font-size: 12px; color: #aaa; margin: 5px 0;">ഓപ്ഷനുകൾ നൽകി ശരിയായ ഉത്തരത്തിന് നേരെയുള്ള ബട്ടൺ സെലക്ട് ചെയ്യുക:</p>
        <div class="opt-row">
            <input type="radio" name="correct" value="0" class="radio-btn" checked>
            <input type="text" id="opt0" placeholder="Option 1">
        </div>
        <div class="opt-row">
            <input type="radio" name="correct" value="1" class="radio-btn">
            <input type="text" id="opt1" placeholder="Option 2">
        </div>
        <div class="opt-row">
            <input type="radio" name="correct" value="2" class="radio-btn">
            <input type="text" id="opt2" placeholder="Option 3">
        </div>
        <div class="opt-row">
            <input type="radio" name="correct" value="3" class="radio-btn">
            <input type="text" id="opt3" placeholder="Option 4">
        </div>
        
        <button class="btn btn-green" onclick="addQuestion()">ADD QUESTION</button>
    </div>

    <div class="card">
        <h3>ചേർത്ത ചോദ്യങ്ങൾ</h3>
        <div id="qListDisplay" style="font-size: 13px; color: #ccc;"></div>
    </div>
</div>

<div id="results" class="tab-content container" style="display:none;">
    <div class="card">
        <h3>ക്വിസ് കൺട്രോൾ</h3>
        <button class="btn btn-blue" onclick="togglePublish(true)">PUBLISH QUIZ (LIVE)</button>
        <button class="btn btn-red" onclick="stopQuiz()">STOP QUIZ & SHOW MARKS</button>
    </div>

    <div id="resultCard" class="card" style="display:none;">
        <h3>പങ്കെടുത്തവർ & മാർക്ക്</h3>
        <button class="btn btn-gold" onclick="publishPosters()">PUBLISH ALL WINNER POSTERS</button>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>Rank</th><th>Name</th><th>Branch</th><th>Score</th><th>Action</th></tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <div class="reset-section">
        <button class="btn btn-red" style="width: auto;" onclick="resetQuiz()">RESET ENTIRE QUIZ</button>
        <p style="font-size: 10px; color: #666; margin-top: 10px;">ഇത് ക്ലിക്ക് ചെയ്താൽ എല്ലാ ചോദ്യങ്ങളും റിസൾട്ടുകളും ഡിലീറ്റ് ആകും.</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config (Keep your existing config)
const firebaseConfig = {
  apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o",
  authDomain: "skssf-quiz.firebaseapp.com",
  projectId: "skssf-quiz",
  storageBucket: "skssf-quiz.firebasestorage.app",
  messagingSenderId: "999161549501",
  appId: "1:999161549501:web:7be9c98c287b92881a5dd4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function openTab(evt, tabName) {
    let content = document.getElementsByClassName("tab-content");
    for (let i = 0; i < content.length; i++) content[i].style.display = "none";
    let btn = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < btn.length; i++) btn[i].className = btn[i].className.replace(" active", "");
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
    if(tabName === 'results') checkQuizStatus();
}

async function addQuestion() {
    const text = document.getElementById('qText').value;
    const options = [
        document.getElementById('opt0').value,
        document.getElementById('opt1').value,
        document.getElementById('opt2').value,
        document.getElementById('opt3').value
    ];
    const correct = document.querySelector('input[name="correct"]:checked').value;

    if(!text || options.includes("")) return alert("എല്ലാ കോളങ്ങളും പൂരിപ്പിക്കുക!");

    await db.collection("questions").add({ text, options, correct });
    alert("ചോദ്യം ചേർത്തു!");
    document.getElementById('qText').value = "";
    loadAddedQuestions();
}

async function loadAddedQuestions() {
    const snap = await db.collection("questions").get();
    const container = document.getElementById('qListDisplay');
    container.innerHTML = snap.empty ? "ചോദ്യങ്ങൾ ഒന്നും ചേർത്തിട്ടില്ല." : "";
    snap.forEach((doc, i) => {
        container.innerHTML += `<div style="padding:5px 0; border-bottom:1px solid #333;">${i+1}. ${doc.data().text}</div>`;
    });
}

async function saveSettings() {
    const time = document.getElementById('startTime').value;
    await db.collection("quiz_settings").doc("status").set({ startTime: time, closed: false, published: false }, {merge:true});
    alert("സമയം സെറ്റ് ചെയ്തു!");
}

async function togglePublish(val) {
    await db.collection("quiz_settings").doc("status").update({ published: val, closed: false });
    alert("ക്വിസ് ലൈവ് ആക്കി!");
}

async function stopQuiz() {
    await db.collection("quiz_settings").doc("status").update({ closed: true, published: false });
    loadResults();
}

async function loadResults() {
    document.getElementById('resultCard').style.display = 'block';
    const qSnap = await db.collection("questions").get();
    let correctMap = {};
    qSnap.forEach(d => correctMap[d.id] = d.data().correct);

    const rSnap = await db.collection("results").get();
    let results = [];
    rSnap.forEach(doc => {
        const d = doc.data();
        let score = 0;
        for(let qid in correctMap) {
            if(d.answers && d.answers[qid] == correctMap[qid]) score++;
        }
        results.push({...d, score});
    });

    results.sort((a,b) => b.score - a.score || a.submitTime - b.submitTime);

    const winDoc = await db.collection("winners").doc("list").get();
    let winnerIds = winDoc.exists ? winDoc.data().winnerIds || [] : [];

    const body = document.getElementById('resultBody');
    body.innerHTML = "";
    results.forEach((r, i) => {
        const isWin = winnerIds.includes(r.regId.toString());
        body.innerHTML += `<tr class="${isWin ? 'winner-row' : ''}">
            <td>${i+1}</td><td>${r.name}</td><td>${r.branch}</td><td>${r.score}</td>
            <td>
                <button onclick="toggleWinner('${r.regId}', ${!isWin})" style="background:${isWin?'#c0392b':'#27ae60'}; color:white; border:none; padding:5px; border-radius:4px; font-size:10px;">
                    ${isWin ? 'REMOVE' : 'SELECT'}
                </button>
            </td>
        </tr>`;
    });
}

async function toggleWinner(id, isAdd) {
    const winDoc = await db.collection("winners").doc("list").get();
    let winners = winDoc.exists ? winDoc.data().winnerIds || [] : [];
    if(isAdd) winners.push(id.toString());
    else winners = winners.filter(w => w !== id.toString());
    await db.collection("winners").doc("list").set({ winnerIds: winners });
    loadResults();
}

async function publishPosters() {
    await db.collection("quiz_settings").doc("status").update({ showPosters: true });
    alert("വിജയികളുടെ പോസ്റ്ററുകൾ പബ്ലിഷ് ചെയ്തു!");
}

async function resetQuiz() {
    if(!confirm("ശ്രദ്ധിക്കുക! എല്ലാ ഡാറ്റയും എന്നെന്നേക്കുമായി ഡിലീറ്റ് ചെയ്യപ്പെടും. തുടരണോ?")) return;
    const collections = ['questions', 'results', 'winners'];
    for (const col of collections) {
        const snap = await db.collection(col).get();
        const batch = db.batch();
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
    }
    await db.collection("quiz_settings").doc("status").set({ published: false, closed: false, showPosters: false });
    alert("റീസെറ്റ് പൂർത്തിയായി!");
    location.reload();
}

async function checkQuizStatus() {
    const s = await db.collection("quiz_settings").doc("status").get();
    if(s.exists && s.data().closed) loadResults();
}

loadAddedQuestions();
</script>
</body>
</html>