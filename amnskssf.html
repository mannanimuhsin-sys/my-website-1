<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding-bottom: 50px; }
        .nav { background: #004d00; color: white; padding: 15px; text-align: center; font-weight: bold; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-red { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #004d00; color: white; }
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-result { background: #e8f5e9; padding: 15px; border-radius: 8px; display: none; border: 1px solid #2e7d32; }
    </style>
</head>
<body>

<div class="nav">SKSSF QUIZ ADMIN PANEL</div>

<div class="container">
    <div class="card">
        <h3>പങ്കെടുക്കുന്നയാളെ കണ്ടെത്തുക (Search)</h3>
        <div class="search-box">
            <input type="number" id="searchId" placeholder="രജിസ്റ്റർ നമ്പർ നൽകുക...">
            <button class="btn btn-blue" onclick="searchUser()">SEARCH</button>
        </div>
        <div id="searchRes" class="search-result"></div>
    </div>

    <div class="card">
        <h3>ക്വിസ് കൺട്രോൾ</h3>
        <input type="datetime-local" id="startTime">
        <button class="btn btn-blue" onclick="updateStatus('time')">SET TIME</button>
        <button class="btn btn-green" onclick="updateStatus('live')">LIVE</button>
        <button class="btn btn-red" onclick="updateStatus('stop')">STOP</button>
        <button class="btn" style="background:#f1c40f; color:#000" onclick="updateStatus('poster')">PUBLISH POSTER</button>
    </div>

    <div class="card">
        <h3>റാങ്ക് ലിസ്റ്റ്</h3>
        <button class="btn btn-blue" onclick="loadResults()">REFRESH LIST</button>
        <table>
            <thead><tr><th>Rank</th><th>ID</th><th>Name</th><th>Branch</th><th>Score</th><th>Action</th></tr></thead>
            <tbody id="resBody"></tbody>
        </table>
    </div>

    <div class="card" style="border: 2px solid red;">
        <h3>Danger Zone</h3>
        <button class="btn btn-red" onclick="resetSystem('results')">RESET RESULTS</button>
        <button class="btn btn-red" style="background:black" onclick="resetSystem('full')">FULL RESET</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function searchUser() {
    const id = document.getElementById('searchId').value;
    const resDiv = document.getElementById('searchRes');
    if(!id) return;
    const doc = await db.collection("participants").doc(id).get();
    if(doc.exists) {
        const d = doc.data();
        resDiv.style.display = 'block';
        resDiv.innerHTML = `<strong>പേര്:</strong> ${d.name}<br><strong>ഐഡി:</strong> ${d.regId}<br><strong>ശാഖ:</strong> ${d.branch}<br><strong>മൊബൈൽ:</strong> ${d.mobile}`;
    } else {
        alert("ഈ ഐഡി നിലവിലില്ല!");
        resDiv.style.display = 'none';
    }
}

async function updateStatus(t) {
    const ref = db.collection("quiz_settings").doc("status");
    if(t==='time') await ref.set({ startTime: document.getElementById('startTime').value }, {merge:true});
    if(t==='live') await ref.update({ published: true, closed: false });
    if(t==='stop') await ref.update({ closed: true, published: false });
    if(t==='poster') await ref.update({ showPosters: true });
    alert("Updated!");
}

async function loadResults() {
    const qSnap = await db.collection("questions").get();
    let correctMap = {}; qSnap.forEach(d => correctMap[d.id] = d.data().correct);
    const rSnap = await db.collection("results").get();
    let res = [];
    rSnap.forEach(doc => {
        let s = 0; const d = doc.data();
        for(let qid in correctMap) { if(d.answers && d.answers[qid] == correctMap[qid]) s++; }
        res.push({...d, score: s, time: d.submitTime ? d.submitTime.toDate().getTime() : 0});
    });
    res.sort((a,b) => b.score - a.score || a.time - b.time);
    const winSnap = await db.collection("winners").doc("list").get();
    const winIds = winSnap.exists ? winSnap.data().winnerIds || [] : [];
    let h = "";
    res.forEach((r, i) => {
        const isW = winIds.includes(r.regId.toString());
        h += `<tr ${isW?'style="background:#fff9c4"':''}><td>${i+1}</td><td>${r.regId}</td><td>${r.name}</td><td>${r.branch}</td><td>${r.score}</td>
        <td><button onclick="toggleWinner('${r.regId}')">${isW?'Unselect':'Select'}</button></td></tr>`;
    });
    document.getElementById("resBody").innerHTML = h;
}

async function toggleWinner(id) {
    const doc = await db.collection("winners").doc("list").get();
    let list = doc.exists ? doc.data().winnerIds || [] : [];
    id = id.toString();
    list = list.includes(id) ? list.filter(l => l !== id) : [...list, id];
    await db.collection("winners").doc("list").set({ winnerIds: list });
    loadResults();
}

async function resetSystem(m) {
    if(!confirm("Are you sure?")) return;
    const cols = m==='results' ? ['results', 'winners'] : ['results', 'winners', 'questions', 'participants'];
    for(const c of cols) {
        const snap = await db.collection(c).get();
        const batch = db.batch();
        snap.docs.forEach(d => batch.delete(d.ref));
        await batch.commit();
    }
    alert("Reset Done!");
}
</script>
</body>
</html>