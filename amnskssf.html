<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSSF Admin Panel - 100% Perfect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --red: #c0392b; --blue: #2980b9; --purple: #8e44ad; }
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; margin: 0; padding: 15px; }
        .admin-container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid var(--primary); }
        h2 { color: var(--primary); font-size: 19px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white !important; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: var(--purple); color: white; }

        /* User Finder Box */
        .info-display { background: #fffde7; border: 2px dashed var(--blue); padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        
        /* Rank Selection */
        .rank-grid { display: flex; gap: 15px; margin-bottom: 20px; }
        .rank-btn { flex: 1; padding: 20px 10px; border: 2px solid #ddd; border-radius: 15px; background: white; cursor: pointer; text-align: center; }
        .rank-btn.active { border-color: var(--gold); background: #fffde7; transform: scale(1.03); border-width: 3px; }

        /* Results Table */
        .table-area { overflow-x: auto; max-height: 450px; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f8f9fa; padding: 15px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; line-height: 1.5; }
        
        .score-badge { background: #27ae60; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .q-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1 style="text-align:center; color: var(--primary); font-weight: 800; letter-spacing: 1px;">SKSSF QUIZ ADMIN CONTROL</h1>

    <div class="card" style="border-top-color: var(--blue);">
        <h2><i class="fa fa-id-card"></i> ‡¥Ø‡µÇ‡¥∏‡µº ‡¥ü‡µç‡¥∞‡¥æ‡¥ï‡µç‡¥ï‡µº (Search by ID)</h2>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="trackId" placeholder="ID ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï..." style="margin:0;">
            <button class="btn btn-blue" onclick="findUser()" style="width: 120px;">FIND</button>
        </div>
        <div id="userInfoBox" class="info-display">
            <div id="uDetailContent" style="font-size: 15px;"></div>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-pencil-alt"></i> ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï</h2>
        <textarea id="qText" placeholder="‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..."></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="opt0" placeholder="Option 1">
            <input type="text" id="opt1" placeholder="Option 2">
            <input type="text" id="opt2" placeholder="Option 3">
            <input type="text" id="opt3" placeholder="Option 4">
        </div>
        <select id="correctOpt">
            <option value="0">Option 1 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="1">Option 2 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="2">Option 3 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
            <option value="3">Option 4 ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç</option>
        </select>
        <button class="btn btn-green" onclick="addQuestion()">ADD QUESTION</button>
        
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" onclick="publishQuizToUsers()"><i class="fa fa-paper-plane"></i> PUBLISH QUESTIONS</button>
            <div id="questionsList" style="margin-top:15px; font-size: 13px;"></div>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-clock"></i> ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ</h2>
        <label style="font-size: 12px; font-weight: bold;">‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡µá‡¥£‡µç‡¥ü ‡¥∏‡¥Æ‡¥Ø‡¥Ç:</label>
        <input type="datetime-local" id="quizTime">
        <button class="btn btn-green" onclick="updateTime()">PUBLISH TIMER</button>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-red" onclick="toggleQuiz(true)"><i class="fa fa-stop-circle"></i> STOP QUIZ</button>
            <button class="btn" style="background:#2ecc71; color:white;" onclick="toggleQuiz(false)">RESUME QUIZ</button>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-trophy"></i> ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç & ‡¥±‡¥æ‡¥ô‡µç‡¥ï‡µç</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="search" onkeyup="searchResult()" placeholder="‡¥™‡µá‡¥∞‡µç, ‡¥¨‡µç‡¥∞‡¥æ‡¥û‡µç‡¥ö‡µç, ‡¥ê‡¥°‡¥ø ‡¥∏‡µÜ‡µº‡¥ö‡µç‡¥ö‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..." style="margin:0;">
            <button class="btn btn-red" onclick="resetEntireQuiz()" style="width: 180px; font-size: 11px; background: #6c5ce7 !important;"><i class="fa fa-refresh"></i> RESET ALL DATA</button>
        </div>
        
        <div class="rank-grid">
            <div id="rb1" class="rank-btn" onclick="setRank(1)">ü•á<br><b>1st PRIZE</b></div>
            <div id="rb2" class="rank-btn" onclick="setRank(2)">ü•à<br><b>2nd PRIZE</b></div>
            <div id="rb3" class="rank-btn" onclick="setRank(3)">ü•â<br><b>3rd PRIZE</b></div>
        </div>

        <div class="table-area">
            <table>
                <thead>
                    <tr><th>ID & Name</th><th>Mobile & Branch</th><th>Score</th><th>Pick</th></tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>

        <div style="margin-top:20px; padding:20px; background:#fffde7; border-radius:15px; border: 2px solid var(--gold);">
            <div id="wList" style="font-size:15px; font-weight:bold; color:var(--red); line-height: 1.8;">
                üèÜ 1st: <span id="s1">-</span><br>
                üèÜ 2nd: <span id="s2">-</span><br>
                üèÜ 3rd: <span id="s3">-</span>
            </div>
            <button class="btn btn-gold" style="margin-top:10px;" onclick="publishWinners()">PUBLISH WINNERS POSTER (WITH ID)</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pickRank = 0; let winners = { 1: null, 2: null, 3: null };

// 1. RESET ALL DATA
async function resetEntireQuiz() {
    if(confirm("‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï! ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µÅ‡¥Ç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥Ç ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥Ç. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) {
        const qSnap = await db.collection("questions").get();
        qSnap.forEach(doc => doc.ref.delete());
        const rSnap = await db.collection("results").get();
        rSnap.forEach(doc => doc.ref.delete());
        alert("‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥ï‡µç‡¥≤‡¥ø‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ.");
        location.reload();
    }
}

// 2. FIND USER
async function findUser() {
    const id = document.getElementById('trackId').value;
    const doc = await db.collection("participants").doc(id).get();
    const box = document.getElementById('userInfoBox');
    if(doc.exists) {
        const d = doc.data();
        document.getElementById('uDetailContent').innerHTML = `<b>‡¥™‡µá‡¥∞‡µç:</b> ${d.name}<br><b>‡¥Æ‡µä‡¥¨‡µà‡µΩ:</b> ${d.mobile}<br><b>‡¥∂‡¥æ‡¥ñ:</b> ${d.branch}<br><b>ID:</b> ${d.regId}`;
        box.style.display = 'block';
    } else { alert("‡¥à ‡¥ê‡¥°‡¥ø ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡¥ø‡¥≤‡µç‡¥≤!"); box.style.display = 'none'; }
}

// 3. QUESTIONS
async function addQuestion() {
    const text = document.getElementById('qText').value;
    const options = [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value, document.getElementById('opt3').value];
    const correct = parseInt(document.getElementById('correctOpt').value);
    if(!text || options.includes("")) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");
    await db.collection("questions").add({ text, options, correct, createdAt: new Date() });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ!");
    document.getElementById('qText').value = "";
    document.querySelectorAll('input[placeholder^="Option"]').forEach(i => i.value = "");
}

db.collection("questions").orderBy("createdAt", "desc").onSnapshot(snap => {
    let h = ""; snap.forEach(doc => { h += `<div class="q-item"><span>${doc.data().text}</span><i class="fa fa-trash" style="color:red; cursor:pointer;" onclick="deleteQ('${doc.id}')"></i></div>`; });
    document.getElementById('questionsList').innerHTML = h;
});

async function deleteQ(id) { if(confirm("‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) await db.collection("questions").doc(id).delete(); }

async function publishQuizToUsers() {
    await db.collection("quiz_settings").doc("status").update({ questionsPublished: true });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
}

// 4. TIMER & STOP
async function updateTime() {
    const t = document.getElementById('quizTime').value;
    if(!t) return alert("‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
    await db.collection("quiz_settings").doc("status").set({ startTime: t, closed: false, showPosters: false }, {merge:true});
    alert("Timer Published!");
}

async function toggleQuiz(st) { 
    await db.collection("quiz_settings").doc("status").update({ closed: st }); 
    alert(st ? "Quiz Stopped" : "Quiz Resumed");
}

// 5. RESULTS (STRICT VERIFICATION)
db.collection("results").onSnapshot(snap => {
    let res = []; snap.forEach(doc => res.push(doc.data()));
    res.sort((a,b) => b.score - a.score || a.time - b.time);
    let h = "";
    res.forEach(d => {
        h += `<tr>
            <td><b style="color:var(--blue)">#${d.regId}</b><br>${d.name}</td>
            <td>${d.mobile || 'N/A'}<br><small>${d.branch || 'N/A'}</small></td>
            <td><span class="score-badge">${d.score !== undefined ? d.score : 0}</span></td>
            <td><button class="btn btn-green" style="padding:5px 10px; font-size:10px;" onclick="confirmWinner('${d.regId}','${d.name}')">PICK</button></td>
        </tr>`;
    });
    document.getElementById('resultBody').innerHTML = h;
});

function setRank(r) { pickRank = r; document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('active')); document.getElementById('rb'+r).classList.add('active'); }
function confirmWinner(id, name) { if(pickRank===0) return alert("Rank ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï!"); winners[pickRank]=id; document.getElementById('s'+pickRank).innerText=`${name} (ID: ${id})`; }
async function publishWinners() { 
    if(!winners[1] || !winners[2] || !winners[3]) return alert("3 ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÜ‡¥Ø‡µÅ‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡¥£‡¥Ç!");
    await db.collection("winners").doc("list").set({ ranks: winners }); 
    await db.collection("quiz_settings").doc("status").update({ showPosters: true, closed: true }); 
    alert("‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÜ ‡¥™‡µç‡¥∞‡¥ñ‡µç‡¥Ø‡¥æ‡¥™‡¥ø‡¥ö‡µç‡¥ö‡µÅ!"); 
}

function searchResult() {
    let input = document.getElementById("search").value.toUpperCase();
    let rows = document.getElementById("resultBody").getElementsByTagName("tr");
    for (let row of rows) { row.style.display = row.textContent.toUpperCase().includes(input) ? "" : "none"; }
}
</script>
</body>
</html>