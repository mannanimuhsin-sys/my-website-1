<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSSF Admin Panel - Final Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --red: #c0392b; --blue: #2980b9; --dark: #1a1a1a; }
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; margin: 0; padding: 15px; }
        .admin-container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid var(--primary); }
        h2 { color: var(--primary); font-size: 19px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-dark { background: var(--dark); color: white; }

        .info-display { background: #fffde7; border: 1px dashed var(--blue); padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        
        .rank-grid { display: flex; gap: 15px; margin-bottom: 20px; }
        .rank-btn { flex: 1; padding: 20px 10px; border: 2px solid #ddd; border-radius: 15px; background: white; cursor: pointer; text-align: center; }
        .rank-btn.active { border-color: var(--gold); background: #fffde7; transform: scale(1.03); }

        .table-area { overflow-x: auto; max-height: 450px; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th { background: #f8f9fa; padding: 15px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        
        .score-badge { background: #2ecc71; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .q-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1 style="text-align:center; color: var(--primary); font-weight: 800;">SKSSF ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ ‡¥™‡¥æ‡¥®‡µΩ</h1>

    <div class="card" style="border-top-color: var(--blue);">
        <h2><i class="fa fa-id-card"></i> ‡¥Ø‡µÇ‡¥∏‡µº ‡¥∏‡µÜ‡µº‡¥ö‡µç‡¥ö‡µç (ID)</h2>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="trackId" placeholder="ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï (eg: 1001)" style="margin:0;">
            <button class="btn btn-blue" onclick="findUser()" style="width: 120px;">FIND</button>
        </div>
        <div id="userInfoBox" class="info-display">
            <div id="uDetailContent"></div>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-pencil-alt"></i> ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥Æ‡¥æ‡¥®‡µá‡¥ú‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</h2>
        <textarea id="qText" placeholder="‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..."></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="opt0" placeholder="Option 1">
            <input type="text" id="opt1" placeholder="Option 2">
            <input type="text" id="opt2" placeholder="Option 3">
            <input type="text" id="opt3" placeholder="Option 4">
        </div>
        <select id="correctOpt">
            <option value="0">Option 1 ‡¥∂‡¥∞‡¥ø</option>
            <option value="1">Option 2 ‡¥∂‡¥∞‡¥ø</option>
            <option value="2">Option 3 ‡¥∂‡¥∞‡¥ø</option>
            <option value="3">Option 4 ‡¥∂‡¥∞‡¥ø</option>
        </select>
        <button class="btn btn-green" onclick="addQuestion()">ADD QUESTION</button>
        
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-dark" onclick="publishQuizToUsers()"><i class="fa fa-paper-plane"></i> PUBLISH QUESTIONS TO USERS</button>
            <div id="questionsList" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-clock"></i> ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ</h2>
        <input type="datetime-local" id="quizTime">
        <button class="btn btn-green" onclick="updateTime()">SET TIMER</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-red" onclick="toggleQuiz(true)"><i class="fa fa-stop-circle"></i> STOP QUIZ NOW</button>
            <button class="btn btn-green" style="background:#27ae60" onclick="toggleQuiz(false)">RESUME QUIZ</button>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa fa-trophy"></i> ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç & ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="search" onkeyup="searchResult()" placeholder="‡¥™‡µá‡¥∞‡µç, ‡¥¨‡µç‡¥∞‡¥æ‡¥û‡µç‡¥ö‡µç, ‡¥ê‡¥°‡¥ø ‡¥∏‡µÜ‡µº‡¥ö‡µç‡¥ö‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..." style="margin:0;">
            <button class="btn btn-red" onclick="resetEntireQuiz()" style="width: 180px; font-size: 12px; background: #8e44ad;"><i class="fa fa-refresh"></i> RESET ALL DATA</button>
        </div>
        
        <div class="rank-grid">
            <div id="rb1" class="rank-btn" onclick="setRank(1)">ü•á<br>1st PRIZE</div>
            <div id="rb2" class="rank-btn" onclick="setRank(2)">ü•à<br>2nd PRIZE</div>
            <div id="rb3" class="rank-btn" onclick="setRank(3)">ü•â<br>3rd PRIZE</div>
        </div>

        <div class="table-area">
            <table>
                <thead>
                    <tr><th>ID/Name</th><th>Mobile/Branch</th><th>Score</th><th>Action</th></tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>

        <div style="margin-top:20px; padding:20px; background:#fffde7; border-radius:15px; border: 2px solid var(--gold);">
            <b>‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ:</b>
            <div id="wList" style="padding:10px 0; color:var(--red); font-weight:bold; font-size: 15px;">
                1st: <span id="s1">-</span> | 2nd: <span id="s2">-</span> | 3rd: <span id="s3">-</span>
            </div>
            <button class="btn btn-gold" onclick="publishWinners()">PUBLISH WINNERS POSTER</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let pickRank = 0; let winners = { 1: null, 2: null, 3: null };

// RESET FUNCTION (‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µÅ‡¥Ç ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥æ‡µª)
async function resetEntireQuiz() {
    if(confirm("‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï! ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥≥‡µç‡¥≥ ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µÅ‡¥Ç ‡¥°‡¥æ‡¥±‡µç‡¥±‡¥æ‡¥¨‡µá‡¥∏‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥Ç ‡¥Æ‡¥æ‡¥û‡µç‡¥û‡µÅ‡¥™‡µã‡¥ï‡µÅ‡¥Ç. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) {
        const qSnap = await db.collection("questions").get();
        qSnap.forEach(doc => doc.ref.delete());
        const rSnap = await db.collection("results").get();
        rSnap.forEach(doc => doc.ref.delete());
        alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥°‡¥æ‡¥±‡µç‡¥±‡¥Ø‡µÅ‡¥Ç ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ.");
        location.reload();
    }
}

// PUBLISH QUESTIONS
async function publishQuizToUsers() {
    await db.collection("quiz_settings").doc("status").update({ questionsPublished: true });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥Ø‡µÇ‡¥∏‡µº‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø!");
}

// FIND USER
async function findUser() {
    const id = document.getElementById('trackId').value;
    const doc = await db.collection("participants").doc(id).get();
    const box = document.getElementById('userInfoBox');
    if(doc.exists) {
        const d = doc.data();
        document.getElementById('uDetailContent').innerHTML = `<b>‡¥™‡µá‡¥∞‡µç:</b> ${d.name}<br><b>‡¥Æ‡µä‡¥¨‡µà‡µΩ:</b> ${d.mobile}<br><b>‡¥∂‡¥æ‡¥ñ:</b> ${d.branch}<br><b>ID:</b> ${d.regId}`;
        box.style.display = 'block';
    } else { alert("‡¥à ‡¥ê‡¥°‡¥ø ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡¥ø‡¥≤‡µç‡¥≤!"); box.style.display = 'none'; }
}

// ADD QUESTION
async function addQuestion() {
    const text = document.getElementById('qText').value;
    const options = [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value, document.getElementById('opt3').value];
    const correct = parseInt(document.getElementById('correctOpt').value);
    if(!text || options.includes("")) return alert("‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");
    await db.collection("questions").add({ text, options, correct, createdAt: new Date() });
    alert("‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥Ç ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
    document.querySelectorAll('input, textarea').forEach(i => { if(i.id != "quizTime") i.value = ""; });
}

db.collection("questions").orderBy("createdAt", "desc").onSnapshot(snap => {
    let h = ""; snap.forEach(doc => { h += `<div class="q-item"><span>${doc.data().text}</span><i class="fa fa-trash" style="color:red; cursor:pointer;" onclick="deleteQ('${doc.id}')"></i></div>`; });
    document.getElementById('questionsList').innerHTML = h;
});

async function deleteQ(id) { if(confirm("‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) await db.collection("questions").doc(id).delete(); }

// TIMER & STOP
async function updateTime() {
    const t = document.getElementById('quizTime').value;
    await db.collection("quiz_settings").doc("status").set({ startTime: t, closed: false, showPosters: false }, {merge:true});
    alert("‡¥ü‡µà‡¥Æ‡µº ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
}

async function toggleQuiz(st) { 
    await db.collection("quiz_settings").doc("status").update({ closed: st }); 
    alert(st ? "‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ö‡µç‡¥ö‡µÅ. ‡¥Ø‡µÇ‡¥∏‡µº‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥∏‡¥®‡µç‡¥¶‡µá‡¥∂‡¥Ç ‡¥≤‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç." : "‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥™‡µÅ‡¥®‡¥∞‡¥æ‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ.");
}

// RESULTS
db.collection("results").onSnapshot(snap => {
    let res = []; snap.forEach(doc => res.push(doc.data()));
    res.sort((a,b) => b.score - a.score || a.time - b.time);
    let h = "";
    res.forEach(d => {
        h += `<tr>
            <td><b>#${d.regId}</b><br>${d.name}</td>
            <td>${d.mobile}<br><small>${d.branch}</small></td>
            <td><span class="score-badge">${d.score || 0}</span></td>
            <td><button class="btn btn-green" style="padding:5px 10px; font-size:10px;" onclick="confirmWinner('${d.regId}','${d.name}')">PICK</button></td>
        </tr>`;
    });
    document.getElementById('resultBody').innerHTML = h;
});

function setRank(r) { pickRank = r; document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('active')); document.getElementById('rb'+r).classList.add('active'); }
function confirmWinner(id, name) { if(pickRank===0) return alert("Rank ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï!"); winners[pickRank]=id; document.getElementById('s'+pickRank).innerText=`${name} (#${id})`; }
async function publishWinners() { await db.collection("winners").doc("list").set({ ranks: winners }); await db.collection("quiz_settings").doc("status").update({ showPosters: true, closed: true }); alert("‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡¥≥‡µÜ ‡¥™‡µç‡¥∞‡¥ñ‡µç‡¥Ø‡¥æ‡¥™‡¥ø‡¥ö‡µç‡¥ö‡µÅ!"); }

function searchResult() {
    let input = document.getElementById("search").value.toUpperCase();
    let rows = document.getElementById("resultBody").getElementsByTagName("tr");
    for (let row of rows) { row.style.display = row.textContent.toUpperCase().includes(input) ? "" : "none"; }
}
</script>
</body>
</html>