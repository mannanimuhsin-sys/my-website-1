<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Board - Misbahul Uloom</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Manjari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --green: #00ff88; --bg: #000; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Manjari', sans-serif; background: var(--bg); color: white; padding: 8px; display: flex; justify-content: center; }
        .board { width: 100%; max-width: 450px; background: #050505; border-radius: 25px; border: 1.5px solid #222; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }

        /* രാവുകൾ */
        .nights-row { display: flex; background: #111; border-bottom: 2.5px solid var(--gold); }
        .night-card { flex: 1; text-align: center; padding: 12px 5px; border-right: 1px solid #222; }
        .night-card b { color: var(--gold); font-size: 13px; display: block; margin-bottom: 3px; }
        .night-card span { font-size: 13px; font-weight: bold; color: #fff; display: block; line-height: 1.3; }

        /* നോട്ടീസ് ബോർഡ് - മനോഹരമായ ഡിസൈൻ */
        #noticeBox { display: none; padding: 18px; margin: 12px; background: linear-gradient(145deg, #1a1a00, #000); border: 1.5px solid var(--gold); border-radius: 20px; text-align: center; animation: glow 2s infinite alternate; }
        @keyframes glow { from { border-color: #554400; box-shadow: 0 0 5px #554400; } to { border-color: var(--gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); } }
        #noticeTitle { color: var(--gold); font-size: 22px; font-weight: 800; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        #noticeText { font-size: 16px; color: #ddd; line-height: 1.5; white-space: pre-wrap; }

        .header { padding: 20px 10px; text-align: center; }
        .hijri-lg { font-size: 26px; font-weight: 800; color: var(--gold); }
        .eng-sm { font-size: 15px; color: #777; margin-top: 5px; font-weight: bold; }

        .p-list { padding: 0 12px 15px 12px; }
        .p-row { display: flex; align-items: center; background: #111; padding: 20px 15px; border-radius: 20px; margin-bottom: 12px; border: 1.5px solid #222; position: relative; }
        .active-now { border: 2.5px solid var(--green) !important; background: #001a0d !important; box-shadow: 0 0 20px rgba(0,255,136,0.2); }
        .p-name { flex: 1.2; font-size: 26px; font-weight: 800; color: #fff; }
        .t-group { flex: 3; display: flex; justify-content: space-around; text-align: center; }
        .t-box small { display: block; font-size: 10px; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        .t-val { font-family: 'Orbitron', sans-serif; font-size: 20px; font-weight: bold; color: #fff; }
        .iq-color { color: var(--green); }
    </style>
</head>
<body>

<div class="board">
    <div class="nights-row">
        <div class="night-card"><b>പതിനൊന്നാം രാവ്</b><span id="n11">...</span></div>
        <div class="night-card" style="border-right:none;"><b>പന്ത്രണ്ടാം രാവ്</b><span id="n12">...</span></div>
    </div>

    <div id="noticeBox">
        <div id="noticeTitle"></div>
        <div id="noticeText"></div>
    </div>

    <div class="header">
        <div class="hijri-lg" id="hijri">-- - --- - ----</div>
        <div class="eng-sm" id="eng">-- --- ----</div>
    </div>

    <div id="pList" class="p-list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
    apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId: "misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();

const monthsML = { "Muharram": "മുഹറം", "Safar": "സഫർ", "Rabi' al-awwal": "റബീഉൽ അവ്വൽ", "Rabi' ath-thani": "റബീഉൽ ആഖിർ", "Jumada al-ula": "ജുമാദൽ ഊല", "Jumada al-akhira": "ജുമാദൽ ആഖിറ", "Rajab": "റജബ്", "Sha'ban": "ശഅ്ബാൻ", "Ramadan": "റമദാൻ", "Shawwal": "ശവ്വാൽ", "Dhu al-Qi'dah": "ദുൽ ഖഅ്ദ്", "Dhu al-Hijjah": "ദുൽ ഹിജ്ജ" };
const daysML = ["ഞായർ", "തിങ്കൾ", "ചൊവ്വ", "ബുധൻ", "വ്യാഴം", "വെള്ളി", "ശനി"];
const monthsEngML = ["ജനുവരി", "ഫെബ്രുവരി", "മാർച്ച്", "ഏപ്രിൽ", "മേയ്", "ജൂൺ", "ജൂലൈ", "ഓഗസ്റ്റ്", "സെപ്റ്റംബർ", "ഒക്ടോബർ", "നവംബർ", "ഡിസംബർ"];

async function run() {
    try {
        const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=Kannur&country=India&method=1`);
        const data = await res.json();
        if(!data || !data.data) return;

        const timings = data.data.timings;
        const h = data.data.date.hijri;
        const g = data.data.date.gregorian;

        // ശഅ്ബാൻ ഉൾപ്പെടെയുള്ള മാസങ്ങൾ മലയാളത്തിലാക്കുന്നു
        const malMonth = monthsML[h.month.en] || h.month.en;
        document.getElementById('hijri').innerText = h.day + " - " + malMonth + " - " + h.year;
        document.getElementById('eng').innerText = data.data.date.readable;

        // രാവുകൾ കണക്കാക്കുന്നു
        calcNights(h.day, g.day, g.month.number, g.year);

        // ഫയർബേസ് നോട്ടീസും പ്രെയർ സെറ്റിംഗും
        db.collection("settings").doc("prayer_master").onSnapshot(doc => {
            if(doc.exists) {
                const conf = doc.data();
                renderList(timings, conf.tuning, conf.delays);
                updateNotice(conf.noticeTitle, conf.noticeText);
            }
        });
    } catch(err) { console.log("Error loading data"); }
}

function calcNights(hDay, gDay, gMonth, gYear) {
    const today = new Date(gYear, gMonth-1, parseInt(gDay));
    const hNum = parseInt(hDay);
    
    // 10-ാം രാവും 11-ാം രാവും അടിസ്ഥാനമാക്കി സിസ്റ്റം തീയതി കണ്ടെത്തുന്നു
    const d10 = new Date(today); d10.setDate(today.getDate() + (10 - hNum));
    const d11 = new Date(today); d11.setDate(today.getDate() + (11 - hNum));

    document.getElementById('n11').innerHTML = monthsEngML[d10.getMonth()] + " " + d10.getDate() + "<br>" + daysML[d10.getDay()];
    document.getElementById('n12').innerHTML = monthsEngML[d11.getMonth()] + " " + d11.getDate() + "<br>" + daysML[d11.getDay()];
}

function updateNotice(title, text) {
    const box = document.getElementById('noticeBox');
    if(title && title.trim() !== "") {
        box.style.display = "block";
        document.getElementById('noticeTitle').innerText = title;
        document.getElementById('noticeText').innerText = text || "";
    } else {
        box.style.display = "none";
    }
}

function renderList(timings, tuning, delays) {
    const prayers = [{k:'Fajr', m:'സുബ്ഹി'}, {k:'Dhuhr', m:'ളുഹർ'}, {k:'Asr', m:'അസർ'}, {k:'Maghrib', m:'മഗ്‌രിബ്'}, {k:'Isha', m:'ഇശാ'}];
    const now = new Date();
    const curMin = now.getHours() * 60 + now.getMinutes();
    let nextIdx = -1;

    for(let i=0; i<prayers.length; i++) {
        const adhan = adjust(timings[prayers[i].k], tuning[prayers[i].k]);
        const [hr, min] = adhan.split(':').map(Number);
        if((hr * 60 + min) > curMin) { nextIdx = i; break; }
    }
    if(nextIdx === -1) nextIdx = 0;

    const html = prayers.map((p, idx) => {
        const adhan = adjust(timings[p.k], tuning[p.k]);
        const iqamah = adjust(adhan, delays[p.k]);
        return `
            <div class="p-row ${idx === nextIdx ? 'active-now' : ''}">
                <div class="p-name">${p.m}</div>
                <div class="t-group">
                    <div class="t-box"><small>ബാങ്ക്</small><div class="t-val">${format(adhan)}</div></div>
                    <div class="t-box"><small>ഇക്കാമത്ത്</small><div class="t-val iq-color">${format(iqamah)}</div></div>
                </div>
            </div>`;
    }).join('');
    document.getElementById('pList').innerHTML = html;
}

function adjust(time, mins) {
    let [h, m] = time.split(':').map(Number);
    let d = new Date(); d.setHours(h, m + (parseInt(mins) || 0));
    return d.getHours() + ":" + d.getMinutes();
}

function format(time) {
    let [h, m] = time.split(':').map(Number);
    let ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return h + ":" + m.toString().padStart(2, '0') + " " + ampm;
}

run();
setInterval(run, 60000);
</script>
</body>
</html>