<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Panel | Misbahul Uloom</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; font-family: 'Poppins', sans-serif; }
        .navbar { background: #198754; color: white; border-radius: 0; border: none; }
        .student-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; position: relative; }
        .student-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #198754; margin-right: 20px; }
        .student-info { flex-grow: 1; }
        .student-info h4 { margin: 0; font-weight: 600; color: #333; }
        .action-btns { position: absolute; right: 15px; top: 15px; }
        .btn-edit { color: #f0ad4e; margin-right: 10px; cursor: pointer; font-size: 18px; }
        .btn-delete { color: #d9534f; cursor: pointer; font-size: 18px; }
        .modal-content { border-radius: 20px; }
    </style>
</head>
<body>

<nav class="navbar text-center">
    <h3>Admin Dashboard - Misbahul Uloom</h3>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <h4 class="text-muted">Registered Students</h4>
            <hr>
            <div id="studentContainer">Loading list...</div>
        </div>
    </div>
</div>

<div id="editModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Edit Details</h4>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <label>Name:</label><input type="text" id="editName" class="form-control"><br>
        <label>Class:</label><input type="text" id="editClass" class="form-control"><br>
        <label>Phone:</label><input type="tel" id="editPhone" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="updateStudent()">Update</button>
      </div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
  authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.com",
  projectId: "misbahul-uloom-madrasa-4830c",
  appId: "1:370558703441:web:dc68dbdbd685c9d07ea570"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Fetch Data
db.collection("students").orderBy("time", "desc").onSnapshot(snapshot => {
    const container = document.getElementById("studentContainer");
    container.innerHTML = "";
    if (snapshot.empty) container.innerHTML = "No students registered yet.";
    
    snapshot.forEach(doc => {
        const s = doc.data();
        const id = doc.id;
        container.innerHTML += `
            <div class="student-card">
                <img src="${s.photo}">
                <div class="student-info">
                    <h4>${s.name}</h4>
                    <small>Class: ${s.class} | Mobile: ${s.phone}</small><br>
                    <small>Password: <b>${s.password}</b></small>
                </div>
                <div class="action-btns">
                    <i class="fas fa-edit btn-edit" onclick="openEdit('${id}', '${s.name}', '${s.class}', '${s.phone}')"></i>
                    <i class="fas fa-trash btn-delete" onclick="deleteStudent('${id}')"></i>
                </div>
            </div>`;
    });
});

// Delete Logic
async function deleteStudent(id) {
    if(confirm("ഈ വിദ്യാർത്ഥിയുടെ വിവരങ്ങൾ ഒഴിവാക്കട്ടെ?")) {
        await db.collection("students").doc(id).delete();
        alert("Deleted Successfully!");
    }
}

// Edit Logic
function openEdit(id, name, cls, ph) {
    document.getElementById("editId").value = id;
    document.getElementById("editName").value = name;
    document.getElementById("editClass").value = cls;
    document.getElementById("editPhone").value = ph;
    $('#editModal').modal('show');
}

async function updateStudent() {
    const id = document.getElementById("editId").value;
    await db.collection("students").doc(id).update({
        name: document.getElementById("editName").value,
        class: document.getElementById("editClass").value,
        phone: document.getElementById("editPhone").value
    });
    $('#editModal').modal('hide');
    alert("Updated Successfully!");
}
</script>
</body>
</html>