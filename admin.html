<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Madrasa Admin Panel | Official</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --primary: #198754; --dark: #2c3e50; --light: #f4f7f6; }
    body { background: var(--light); font-family: 'Poppins', sans-serif; margin: 0; }
    .header { background: var(--primary); color: white; padding: 25px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .container { max-width: 1300px; margin: 20px auto; padding: 0 15px; }

    /* Class Cards */
    .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 30px; }
    .class-card { background: white; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border-bottom: 4px solid #ddd; }
    .class-card.active { background: var(--primary); color: white; border-bottom-color: #0d5a39; }
    .class-card h3 { margin: 0; font-size: 20px; }

    /* Tools */
    .tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .search-box { background: white; padding: 12px 20px; border-radius: 30px; display: flex; align-items: center; flex: 1; max-width: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .search-box input { border: none; outline: none; width: 100%; margin-left: 10px; }
    
    .export-section { display: flex; gap: 10px; }

    /* Table */
    .student-list { background: white; border-radius: 15px; overflow-x: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; min-width: 1100px; }
    th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 13px; color: #555; border-bottom: 2px solid #eee; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
    .std-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

    /* Buttons */
    .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-edit { background: #e3f2fd; color: #1976d2; }
    .btn-del { background: #ffebee; color: #d32f2f; }
    .btn-excel { background: #2e7d32; color: white; }
    .btn-pdf { background: #c62828; color: white; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 20px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group label { display: block; font-weight: 600; font-size: 12px; margin-bottom: 5px; color: #666; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .full-width { grid-column: span 2; }
</style>
</head>
<body>

<div class="header">
    <h1><i class="fas fa-user-shield"></i> MISBAHUL ULOOM ADMIN</h1>
    <p>വിദ്യാർത്ഥികളുടെ വിവരങ്ങൾ മാനേജ് ചെയ്യാം</p>
</div>

<div class="container">
    <div class="class-grid" id="classGrid">
        <script>
            for(let i=1; i<=10; i++) {
                document.write(`<div class="class-card" id="card-${i}" onclick="loadClass('${i}')"><h3>${i}</h3><p>Class</p></div>`);
            }
        </script>
    </div>

    <div class="tools">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" onkeyup="searchStudent()" placeholder="പേര് തിരയുക...">
        </div>
        <div class="export-section">
            <button class="btn btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            <button class="btn btn-pdf" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> PDF (With Photo)</button>
        </div>
    </div>

    <div class="student-list">
        <table id="studentTable">
            <thead>
                <tr>
                    <th>ഫോട്ടോ</th>
                    <th>പേര്</th>
                    <th>Reg.No</th>
                    <th>ക്ലാസ്</th>
                    <th>DOB</th>
                    <th>ലിംഗം</th>
                    <th>Blood</th>
                    <th>രക്ഷിതാവ്</th>
                    <th>ഫോൺ</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--primary);">തിരുത്തുക</h2>
        <input type="hidden" id="editDocId">
        <div class="form-grid">
            <div class="form-group"><label>പേര്</label><input type="text" id="editName"></div>
            <div class="form-group"><label>രജിസ്റ്റർ നമ്പർ</label><input type="text" id="editRegNo"></div>
            <div class="form-group"><label>ക്ലാസ്</label><input type="text" id="editClass"></div>
            <div class="form-group"><label>DOB</label><input type="date" id="editDob"></div>
            <div class="form-group"><label>ലിംഗം</label><select id="editGender"><option>Male</option><option>Female</option></select></div>
            <div class="form-group"><label>Blood Group</label><input type="text" id="editBlood"></div>
            <div class="form-group"><label>രക്ഷിതാവ്</label><input type="text" id="editFather"></div>
            <div class="form-group full-width"><label>ഫോൺ</label><input type="tel" id="editPhone"></div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-excel" style="flex:2" onclick="updateStudent()">Update Now</button>
            <button class="btn btn-del" style="flex:1" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
firebase.initializeApp({
    apiKey:"AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain:"misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId:"misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();
let currentClass = "1";
let allStudents = [];

function loadClass(cls) {
    currentClass = cls;
    document.querySelectorAll('.class-card').forEach(c => c.classList.remove('active'));
    document.getElementById(`card-${cls}`).classList.add('active');
    
    const body = document.getElementById("tableBody");
    body.innerHTML = "<tr><td colspan='10' style='text-align:center;'>വിവരങ്ങൾ ശേഖരിക്കുന്നു...</td></tr>";
    
    db.collection("students").where("class", "==", cls).onSnapshot(snap => {
        body.innerHTML = "";
        allStudents = [];
        snap.forEach(doc => {
            const d = doc.data();
            d.docId = doc.id;
            allStudents.push(d);
            body.innerHTML += `
                <tr>
                    <td><img src="${d.photo}" class="std-img"></td>
                    <td><b>${d.name}</b></td>
                    <td>${d.number}</td>
                    <td>${d.class}</td>
                    <td>${d.dob}</td>
                    <td>${d.gender}</td>
                    <td>${d.blood || '-'}</td>
                    <td>${d.father}</td>
                    <td>${d.phone}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openEdit('${doc.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-del" onclick="deleteStudent('${doc.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
        if(allStudents.length === 0) body.innerHTML = "<tr><td colspan='10' style='text-align:center;'>ഈ ക്ലാസ്സിൽ വിദ്യാർത്ഥികളില്ല.</td></tr>";
    });
}

function openEdit(id) {
    const s = allStudents.find(x => x.docId === id);
    document.getElementById("editDocId").value = id;
    document.getElementById("editName").value = s.name;
    document.getElementById("editRegNo").value = s.number;
    document.getElementById("editClass").value = s.class;
    document.getElementById("editDob").value = s.dob;
    document.getElementById("editGender").value = s.gender;
    document.getElementById("editBlood").value = s.blood || "";
    document.getElementById("editFather").value = s.father;
    document.getElementById("editPhone").value = s.phone;
    document.getElementById("editModal").style.display = "flex";
}

async function updateStudent() {
    const id = document.getElementById("editDocId").value;
    await db.collection("students").doc(id).update({
        name: document.getElementById("editName").value,
        number: document.getElementById("editRegNo").value,
        class: document.getElementById("editClass").value,
        dob: document.getElementById("editDob").value,
        gender: document.getElementById("editGender").value,
        blood: document.getElementById("editBlood").value,
        father: document.getElementById("editFather").value,
        phone: document.getElementById("editPhone").value
    });
    alert("വിവരങ്ങൾ അപ്ഡേറ്റ് ചെയ്തു ✅");
    document.getElementById("editModal").style.display = "none";
}

async function deleteStudent(id) {
    if(confirm("ഈ വിദ്യാർത്ഥിയുടെ വിവരങ്ങൾ സ്ഥിരമായി ഒഴിവാക്കണോ?")) {
        await db.collection("students").doc(id).delete();
        alert("Deleted Successfully");
    }
}

function searchStudent() {
    let filter = document.getElementById("searchInput").value.toUpperCase();
    let tr = document.getElementById("tableBody").getElementsByTagName("tr");
    for (let i = 0; i < tr.length; i++) {
        let nameTd = tr[i].getElementsByTagName("td")[1];
        if (nameTd) {
            tr[i].style.display = nameTd.innerText.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }
}

// PDF EXPORT WITH PHOTO
async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    doc.setFontSize(16);
    doc.text("Misbahul Uloom Madrasa - Class " + currentClass, 14, 15);
    
    const tableData = [];
    for(let s of allStudents) {
        tableData.push([s.name, s.number, s.dob, s.father, s.phone]);
    }

    doc.autoTable({
        head: [['Name', 'Reg.No', 'DOB', 'Parent', 'Phone']],
        body: tableData,
        startY: 25,
        theme: 'striped',
        headStyles: { fillColor: [25, 135, 84] }
    });

    doc.save(`Class_${currentClass}_Report.pdf`);
}

// EXCEL EXPORT
function exportToExcel() {
    let csv = "Name,Register No,Class,DOB,Gender,Blood,Parent,Phone\n";
    allStudents.forEach(s => {
        csv += `${s.name},${s.number},${s.class},${s.dob},${s.gender},${s.blood},${s.father},${s.phone}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Class_${currentClass}_Data.csv`;
    a.click();
}

loadClass("1"); // Initial Load
</script>
</body>
</html>