<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Quiz Admin - Misbahul Uloom</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #198754; --danger: #dc3545; --warning: #ffc107; --dark: #2c3e50; }
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; margin: 0; padding: 20px; }
        .admin-box { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 22px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1; min-width: 150px; }
        
        .btn-start { background: var(--primary); color: white; }
        .btn-pause { background: var(--warning); color: #000; }
        .btn-delete { background: var(--danger); color: white; }
        .btn-winner { background: #6f42c1; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 30px; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .open { background: #d1fae5; color: #065f46; }
        .paused { background: #fef3c7; color: #92400e; }
        .closed { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="admin-box">
    <h2>üöÄ Quiz Control Center</h2>

    <div class="form-group">
        <label>Weekly Question</label>
        <input type="text" id="adminQ" placeholder="‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ï‡µç‡¥µ‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥Ø‡µª ‡¥π‡¥ø‡¥Ø‡µº...">
    </div>

    <div class="form-group">
        <label>Options (‡¥®‡¥æ‡¥≤‡µç ‡¥ì‡¥™‡µç‡¥∑‡¥®‡µÅ‡¥ï‡µæ ‡¥®‡¥ø‡µº‡¥¨‡¥®‡µç‡¥ß‡¥Ç)</label>
        <div class="opt-grid">
            <input type="text" id="opt1" placeholder="Option 1">
            <input type="text" id="opt2" placeholder="Option 2">
            <input type="text" id="opt3" placeholder="Option 3">
            <input type="text" id="opt4" placeholder="Option 4">
        </div>
    </div>

    <div class="form-group">
        <label>Next Quiz Date & Time</label>
        <input type="datetime-local" id="nextQuizTime">
    </div>

    <div class="btn-group">
        <button class="btn btn-start" onclick="updateStatus('open')">Publish Quiz</button>
        <button class="btn btn-pause" onclick="updateStatus('paused')">Pause Quiz</button>
        <button class="btn btn-delete" onclick="resetQuizData()">Delete & Reset</button>
    </div>

    <div style="margin-top: 20px; font-size: 14px;">
        <strong>Current Status:</strong> <span id="currentStatus" class="status-pill">...</span>
    </div>

    <hr style="margin: 40px 0;">

    <h2>üì• Live Responses</h2>
    <table id="responseTable">
        <thead>
            <tr>
                <th>Time</th>
                <th>Student</th>
                <th>Answer</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="resBody"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain:"misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId:"misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();

// ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡µª
async function updateStatus(status) {
    const q = document.getElementById("adminQ").value;
    const o1 = document.getElementById("opt1").value;
    const o2 = document.getElementById("opt2").value;
    const o3 = document.getElementById("opt3").value;
    const o4 = document.getElementById("opt4").value;
    const nextT = document.getElementById("nextQuizTime").value;

    if(status === 'open' && (!q || !o1 || !o2 || !o3 || !o4)) {
        alert("‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥µ‡µÅ‡¥Ç 4 ‡¥ì‡¥™‡µç‡¥∑‡¥®‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
        return;
    }

    await db.collection("quiz_config").doc("current").set({
        question: q,
        options: [o1, o2, o3, o4],
        status: status,
        winnerId: "",
        nextDate: nextT ? new Date(nextT).toLocaleString() : "TBA"
    }, { merge: true });
    
    alert("Status Updated to: " + status);
}

// ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç ‡¥≤‡µà‡¥µ‡µç ‡¥Ü‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥æ‡µª
db.collection("quiz_config").doc("current").onSnapshot(doc => {
    const data = doc.data();
    const s = document.getElementById("currentStatus");
    s.innerText = data.status;
    s.className = "status-pill " + data.status;
});

// ‡¥â‡¥§‡µç‡¥§‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª
db.collection("quiz_responses").orderBy("time", "asc").onSnapshot(snap => {
    let html = "";
    snap.forEach(doc => {
        const d = doc.data();
        const time = d.time ? d.time.toDate().toLocaleTimeString() : "...";
        html += `<tr>
            <td>${time}</td>
            <td>${d.name} (${d.regNo})</td>
            <td>${d.answer}</td>
            <td><button class="btn btn-winner" style="padding:5px 10px; font-size:11px;" onclick="declareWinner('${d.regNo}')">Declare Winner</button></td>
        </tr>`;
    });
    document.getElementById("resBody").innerHTML = html;
});

async function declareWinner(id) {
    if(confirm("‡¥à ‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥Ø‡µÜ ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø ‡¥™‡µç‡¥∞‡¥ñ‡µç‡¥Ø‡¥æ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥ü‡µç‡¥ü‡µÜ?")) {
        await db.collection("quiz_config").doc("current").update({
            status: "closed",
            winnerId: id
        });
        alert("Winner Announced!");
    }
}

async function resetQuizData() {
    if(confirm("‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï! ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥â‡¥§‡µç‡¥§‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥Ü‡¥ï‡µÅ‡¥Ç. ‡¥§‡µÅ‡¥ü‡¥∞‡¥ü‡µç‡¥ü‡µÜ?")) {
        const snap = await db.collection("quiz_responses").get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        await db.collection("quiz_config").doc("current").update({ status: 'ready', winnerId: "" });
        alert("Data Cleared!");
    }
}
</script>
</body>
</html>