<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <title>Quiz Master - Admin Panel (With Time)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --green: #198754; --red: #dc3545; --blue: #0d6efd; --orange: #fd7e14; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .admin-card { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .control-bar { display: flex; gap: 15px; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .q-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        input[type="text"], input[type="datetime-local"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .opt-row { display: flex; align-items: center; gap: 10px; background: #f1f3f5; padding: 8px; border-radius: 8px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-save { background: var(--green); }
        .btn-reset { background: var(--orange); }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        th, td { padding: 15px; border: 1px solid #eee; text-align: left; font-size: 14px; }
        th { background: #343a40; color: white; }
        .score-badge { background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 6px; font-weight: bold; }
        .time-text { color: #555; font-weight: 600; font-family: monospace; }
    </style>
</head>
<body>

<div class="admin-card">
    <div class="top-nav">
        <h2 style="color: var(--green); margin:0;">Quiz Admin Panel</h2>
        <button class="btn btn-reset" onclick="resetFullQuiz()">RESET & NEW QUIZ</button>
    </div>

    <div class="control-bar">
        <div style="flex: 1;">
            <label>Start Time:</label>
            <input type="datetime-local" id="startTime">
        </div>
        <div style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn" style="background: var(--green);" onclick="updateStatus('active')">SET ACTIVE</button>
            <button class="btn" style="background: var(--red);" onclick="updateStatus('off')">OFF</button>
        </div>
    </div>

    <div id="qContainer"></div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="background: var(--blue);" onclick="addNewQuestionUI()">+ Add Question</button>
        <button class="btn btn-save" onclick="saveQuizToDB()">SAVE & PUBLISH</button>
    </div>

    <h3 style="margin-top: 40px;">Student Marks & Submission Time</h3>
    <table>
        <thead>
            <tr>
                <th>Submitted Time</th> <th>Student Name</th>
                <th>ID</th>
                <th>Score</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="resList"></tbody>
    </table>
</div>

<script>
firebase.initializeApp({
    apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId: "misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();
let qCount = 0;
let correctAnswers = [];

window.onload = async () => {
    const doc = await db.collection("quiz_config").doc("current").get();
    if (doc.exists) {
        const data = doc.data();
        document.getElementById('startTime').value = data.startTime || "";
        if (data.questions) {
            data.questions.forEach(q => addNewQuestionUI(q));
            correctAnswers = data.questions.map(q => q.correct);
        }
        loadResponses();
    } else { addNewQuestionUI(); }
};

function addNewQuestionUI(data = null) {
    qCount++;
    const qText = data ? data.text : "";
    const opts = data ? data.options : ["", "", "", ""];
    const corIdx = data ? opts.indexOf(data.correct) : 0;
    const html = `<div class="q-card">
        <h4>Question ${qCount}</h4>
        <input type="text" class="q-txt" value="${qText}" placeholder="Type Question...">
        <div class="opt-grid">
            ${opts.map((opt, i) => `<div class="opt-row">
                <input type="radio" name="ans-${qCount}" value="${i}" ${i===corIdx?'checked':''}>
                <input type="text" class="opt" value="${opt}" placeholder="Option ${i+1}">
            </div>`).join('')}
        </div>
    </div>`;
    document.getElementById('qContainer').insertAdjacentHTML('beforeend', html);
}

async function saveQuizToDB() {
    let qData = [];
    document.querySelectorAll('.q-card').forEach((card, idx) => {
        const text = card.querySelector('.q-txt').value;
        const opts = Array.from(card.querySelectorAll('.opt')).map(i => i.value);
        const cor = card.querySelector(`input[name="ans-${idx+1}"]:checked`);
        if(text && cor) qData.push({ text: text, options: opts, correct: opts[parseInt(cor.value)] });
    });
    await db.collection("quiz_config").doc("current").set({
        startTime: document.getElementById('startTime').value,
        questions: qData, status: "active"
    });
    alert("Quiz Saved!");
    location.reload();
}

async function resetFullQuiz() {
    if(confirm("പഴയ ചോദ്യങ്ങളും മാർക്കുകളും ഡിലീറ്റ് ചെയ്യണോ?")) {
        const resSnap = await db.collection("quiz_responses").get();
        const batch = db.batch();
        resSnap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        await db.collection("quiz_config").doc("current").delete();
        location.reload();
    }
}

async function updateStatus(s) {
    await db.collection("quiz_config").doc("current").update({ status: s });
    alert("Status Updated: " + s);
}

function loadResponses() {
    // സമയം അനുസരിച്ച് സോർട്ട് ചെയ്യുന്നു (ആദ്യം സബ്മിറ്റ് ചെയ്തവർ ആദ്യം വരും)
    db.collection("quiz_responses").orderBy("timestamp", "asc").onSnapshot(snap => {
        const list = document.getElementById('resList');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            let score = 0;
            if (d.answers) Object.keys(d.answers).forEach(i => { if (d.answers[i] === correctAnswers[i]) score++; });
            
            // സമയം ഫോർമാറ്റ് ചെയ്യുന്നു
            const time = d.timestamp ? d.timestamp.toDate().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "---";

            list.innerHTML += `<tr>
                <td class="time-text">${time}</td>
                <td>${d.studentName}</td>
                <td>${d.studentId}</td>
                <td><span class="score-badge">${score} / ${correctAnswers.length}</span></td>
                <td><button onclick="setWinner('${d.studentId}')" style="background:orange; border:none; color:white; padding:8px; border-radius:5px; cursor:pointer;">Winner</button></td>
            </tr>`;
        });
    });
}

async function setWinner(id) {
    await db.collection("quiz_config").doc("current").update({ status: "winner", winnerId: id });
    alert("Winner Declared!");
}
</script>
</body>
</html>