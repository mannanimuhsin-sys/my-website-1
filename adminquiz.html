<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Admin - Fast Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .admin-container { max-width: 850px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #198754; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        label { font-weight: 600; display: block; margin-top: 15px; font-size: 14px; color: #444; }
        input, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; margin-top: 5px; font-family: inherit; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .btn-update { background: #198754; }
        .btn-close { background: #d9534f; }
        .btn:active { transform: scale(0.98); }
        
        /* Fast Response List Styles */
        .response-item { 
            background: #fff; border-radius: 15px; padding: 12px 15px; margin-bottom: 10px; 
            display: flex; align-items: center; justify-content: space-between;
            border-left: 5px solid #198754; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .res-info { display: flex; align-items: center; gap: 12px; }
        .res-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #eee; }
        .winner-tag { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; margin-left: 5px; }
        
        .select-win-btn { background: #ffc107; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; min-width: 100px; }
        .select-win-btn.active { background: #198754; color: white; }
        
        .loading-text { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="card">
        <h2><i class="fas fa-bolt"></i> ക്വിസ് കൺട്രോൾ</h2>
        
        <label>Quiz Number (ID)</label>
        <input type="number" id="quizId" placeholder="ഉദാ: 5">

        <label>ചോദ്യം</label>
        <textarea id="question" rows="2" placeholder="ചോദ്യം ഇവിടെ ടൈപ്പ് ചെയ്യുക"></textarea>

        <label>ഓപ്ഷനുകൾ</label>
        <div class="opt-grid">
            <input type="text" id="opt1" placeholder="Option 1">
            <input type="text" id="opt2" placeholder="Option 2">
            <input type="text" id="opt3" placeholder="Option 3">
            <input type="text" id="opt4" placeholder="Option 4">
        </div>

        <label>അടുത്ത ക്വിസ് തീയതി & സമയം</label>
        <input type="datetime-local" id="nextDate">

        <div class="btn-group">
            <button class="btn btn-update" onclick="saveQuiz('open')">Update & Open Quiz</button>
            <button class="btn btn-close" onclick="saveQuiz('closed')">Close & Show Winner</button>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-reply-all"></i> ഉത്തരങ്ങൾ (തത്സമയം)</h3>
        <div id="responseList" class="loading-text">ഉത്തരങ്ങൾക്കായി കാത്തിരിക്കുന്നു...</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId: "misbahul-uloom-madrasa-4830c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentWinnerId = "";
let lastQuizId = "";

// 1. ഫയർബേസിൽ നിന്ന് ക്വിസ് വിവരങ്ങൾ എടുക്കുന്നു
db.collection("quiz_config").doc("current").onSnapshot((doc) => {
    const data = doc.data();
    if (data) {
        document.getElementById("quizId").value = data.quizId || "";
        document.getElementById("question").value = data.question || "";
        document.getElementById("opt1").value = data.options[0] || "";
        document.getElementById("opt2").value = data.options[1] || "";
        document.getElementById("opt3").value = data.options[2] || "";
        document.getElementById("opt4").value = data.options[3] || "";
        document.getElementById("nextDate").value = data.nextDate || "";
        currentWinnerId = data.winnerId;

        // Quiz ID മാറിയാൽ മാത്രം ലിസ്റ്റ് റിഫ്രഷ് ചെയ്യുക (സ്പീഡ് കൂട്ടാൻ)
        if (data.quizId !== lastQuizId) {
            lastQuizId = data.quizId;
            loadResponses(data.quizId);
        } else {
            updateWinnerUI(); // വിന്നറെ മാത്രം ഹൈലൈറ്റ് ചെയ്യുക
        }
    }
}, (error) => { console.error("Config Load Error:", error); });

// 2. തത്സമയ ഉത്തരങ്ങൾ ലോഡ് ചെയ്യുന്നു (High Speed Listener)
function loadResponses(qId) {
    const list = document.getElementById("responseList");
    
    db.collection("quiz_responses")
      .where("quizId", "==", qId)
      .orderBy("time", "asc")
      .onSnapshot((snap) => {
        if(snap.empty) { 
            list.innerHTML = "<div class='loading-text'>ഈ ക്വിസ്സിൽ ഇതുവരെ ആരും പങ്കെടുത്തിട്ടില്ല.</div>"; 
            return; 
        }

        let html = "";
        snap.forEach((doc) => {
            const res = doc.data();
            const isWinner = res.regNo === currentWinnerId;
            const timeStr = res.time ? new Date(res.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : "അയക്കുന്നു...";

            html += `
                <div class="response-item ${isWinner ? 'is-winner' : ''}" id="res-${res.regNo}">
                    <div class="res-info">
                        <img src="${res.photo}" class="res-img" loading="lazy">
                        <div>
                            <p style="margin:0; font-weight:700; font-size:14px;">${res.name} ${isWinner ? '<span class="winner-tag">WINNER</span>' : ''}</p>
                            <p style="margin:0; font-size:12px; color:#198754; font-weight:600;">Ans: ${res.answer}</p>
                            <p style="margin:0; font-size:10px; color:#999;">Time: ${timeStr}</p>
                        </div>
                    </div>
                    <button class="select-win-btn ${isWinner ? 'active' : ''}" onclick="markAsWinner('${res.regNo}')">
                        ${isWinner ? '<i class="fas fa-check"></i> Selected' : 'Select Winner'}
                    </button>
                </div>
            `;
        });
        list.innerHTML = html;
    });
}

// 3. വിന്നറെ ഹൈലൈറ്റ് ചെയ്യുക (പേജ് മൊത്തം മാറാതെ)
function updateWinnerUI() {
    document.querySelectorAll('.response-item').forEach(item => {
        const regId = item.id.replace('res-', '');
        const btn = item.querySelector('.select-win-btn');
        if (regId === currentWinnerId) {
            item.classList.add('is-winner');
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-check"></i> Selected';
        } else {
            item.classList.remove('is-winner');
            btn.classList.remove('active');
            btn.innerHTML = 'Select Winner';
        }
    });
}

// 4. വിന്നറെ തിരഞ്ഞെടുക്കുന്നു
async function markAsWinner(regId) {
    currentWinnerId = regId;
    try {
        await db.collection("quiz_config").doc("current").update({ winnerId: regId });
    } catch(e) { alert("Error choosing winner"); }
}

// 5. ക്വിസ് സേവ് ചെയ്യുന്നു
async function saveQuiz(status) {
    const qId = document.getElementById("quizId").value;
    if(!qId) { alert("Quiz Number നൽകുക!"); return; }

    const data = {
        quizId: qId,
        question: document.getElementById("question").value,
        options: [
            document.getElementById("opt1").value,
            document.getElementById("opt2").value,
            document.getElementById("opt3").value,
            document.getElementById("opt4").value
        ],
        nextDate: document.getElementById("nextDate").value,
        status: status,
        winnerId: currentWinnerId
    };
    
    try {
        await db.collection("quiz_config").doc("current").set(data, { merge: true });
        alert("ക്വിസ് അപ്‌ഡേറ്റ് ചെയ്തു: " + status.toUpperCase());
    } catch(e) { alert("അപ്‌ഡേറ്റ് പരാജയപ്പെട്ടു!"); }
}
</script>
</body>
</html>