<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <title>Master Admin - Live Control & Reports</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --green: #0b5d1e; --red: #d63031; --blue: #0984e3; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .main-container { max-width: 1100px; margin: auto; }
        .control-box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 25px; border-top: 5px solid var(--green); }
        input { padding: 12px; margin: 10px; border-radius: 8px; border: 1px solid #ddd; width: 200px; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; margin: 5px; }
        .btn-start { background: var(--green); }
        .btn-stop { background: var(--red); }
        .live-section { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .prog-header { color: var(--green); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        #liveFeed { max-height: 500px; overflow-y: auto; padding: 10px; }
        .stu-row { display: flex; align-items: center; padding: 12px; background: #fff; border: 1px solid #eee; margin-bottom: 8px; border-radius: 10px; transition: 0.3s; }
        .stu-row img { width: 55px; height: 55px; border-radius: 50%; margin-right: 15px; border: 2px solid var(--green); object-fit: cover; }
        .stu-info { flex-grow: 1; }
        .stu-time { color: #666; font-family: monospace; font-size: 13px; font-weight: bold; text-align: right; }
        .report-box { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; }
        .btn-ex { background: #27ae60; font-size: 12px; }
        .btn-pd { background: #e74c3c; font-size: 12px; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="control-box">
        <h2>PROGRAM CONTROL HUB</h2>
        <div id="statusTag">Status: <span style="color:red">Offline</span></div>
        <input type="text" id="progName" placeholder="Program Name">
        <input type="date" id="progDate">
        <br>
        <button class="btn btn-start" onclick="updateScanner(true)">START PROGRAM</button>
        <button class="btn btn-stop" onclick="updateScanner(false)">STOP & BLOCK</button>
    </div>

    <div class="live-section">
        <div class="prog-header">
            <h3 id="activeProgTitle">Live Feed: No Active Program</h3>
            <span id="liveCount" style="background:var(--green); color:white; padding:5px 12px; border-radius:20px; font-size:14px;">Total: 0</span>
        </div>
        <div id="liveFeed">
            <p style="text-align:center; color:#999;">സ്കാൻ ചെയ്യുന്ന വിവരങ്ങൾ ഇവിടെ ലൈവായി കാണാം...</p>
        </div>
    </div>

    <div class="report-box">
        <h3>Class-wise Reports & Downloads</h3>
        <div class="filter-bar">
            <select id="classFilter" onchange="filterReport()">
                <option value="All">All Classes</option>
                <option value="1">Class 1</option><option value="2">Class 2</option>
                <option value="3">Class 3</option><option value="4">Class 4</option>
                <option value="5">Class 5</option><option value="6">Class 6</option>
                <option value="7">Class 7</option><option value="8">Class 8</option>
                <option value="9">Class 9</option><option value="10">Class 10</option>
            </select>
            <button class="btn btn-ex" onclick="downloadExcel()">DOWNLOAD EXCEL</button>
            <button class="btn btn-pd" onclick="downloadPDF()">DOWNLOAD PDF</button>
        </div>
        <div id="reportDisplay"></div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCe98Gw-si7idO0m8y5xbLLG8Z2HC3RCKE",
    authDomain: "mum-new-id.firebaseapp.com",
    projectId: "mum-new-id",
    storageBucket: "mum-new-id.firebasestorage.app",
    messagingSenderId: "794343464244",
    appId: "1:794343464244:web:f9083036490e3609bf1961"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentProg = "";
let currentDate = "";
let attendanceData = [];
let unsub = null;

async function updateScanner(status) {
    const name = document.getElementById('progName').value;
    const date = document.getElementById('progDate').value;
    if(status && (!name || !date)) { alert("പ്രോഗ്രാം വിവരങ്ങൾ നൽകുക!"); return; }
    await db.collection("settings").doc("scanner_control").set({
        isActive: status, progName: name, progDate: date, lastUpdated: new Date()
    });
}

db.collection("settings").doc("scanner_control").onSnapshot(doc => {
    const data = doc.data();
    if(data && data.isActive) {
        currentProg = data.progName;
        currentDate = data.progDate;
        document.getElementById('statusTag').innerHTML = `Status: <span style="color:green">LIVE - ${currentProg}</span>`;
        document.getElementById('activeProgTitle').innerText = `Live Feed: ${currentProg}`;
        listenToAttendance();
    } else {
        document.getElementById('statusTag').innerHTML = `Status: <span style="color:red">OFFLINE</span>`;
        document.getElementById('activeProgTitle').innerText = `Live Feed: No Active Program`;
    }
});

function listenToAttendance() {
    if(unsub) unsub();
    // orderBy നീക്കം ചെയ്തു, പകരം ക്ലയന്റ് സൈഡിൽ സോർട്ട് ചെയ്യുന്നു (ഡാറ്റ മിസ് ആകാതിരിക്കാൻ)
    unsub = db.collection("attendance")
        .where("progName", "==", currentProg)
        .where("progDate", "==", currentDate)
        .onSnapshot(snap => {
            attendanceData = [];
            snap.forEach(doc => {
                let d = doc.data();
                d.id = doc.id;
                attendanceData.push(d);
            });
            
            // സമയം അനുസരിച്ച് സോർട്ട് ചെയ്യുന്നു (പുതിയത് മുകളിൽ)
            attendanceData.sort((a, b) => b.time.toDate() - a.time.toDate());
            
            renderLiveFeed();
            filterReport();
        });
}

function renderLiveFeed() {
    const feed = document.getElementById('liveFeed');
    feed.innerHTML = "";
    attendanceData.forEach(s => {
        const t = s.time.toDate();
        const timeStr = `${t.getHours().toString().padStart(2,'0')}:${t.getMinutes().toString().padStart(2,'0')}:${t.getSeconds().toString().padStart(2,'0')}.${t.getMilliseconds()}`;
        feed.innerHTML += `
            <div class="stu-row">
                <img src="${s.photo}">
                <div class="stu-info">
                    <b>${s.name}</b><br>
                    <small>ID: ${s.number} | Class: ${s.class}</small>
                </div>
                <div class="stu-time">${timeStr} <br> <span style="color:red; cursor:pointer;" onclick="deleteEntry('${s.id}')">✕</span></div>
            </div>`;
    });
    document.getElementById('liveCount').innerText = `Total: ${attendanceData.length}`;
}

async function deleteEntry(id) {
    if(confirm("ഡിലീറ്റ് ചെയ്യണോ?")) await db.collection("attendance").doc(id).delete();
}

function filterReport() {
    const cls = document.getElementById('classFilter').value;
    const display = document.getElementById('reportDisplay');
    let filtered = (cls === "All") ? attendanceData : attendanceData.filter(d => d.class == cls);
    
    let html = `<table border="1" style="width:100%; border-collapse:collapse; margin-top:10px; background:white;">
                <tr style="background:#eee;"><th>ID</th><th>Name</th><th>Class</th><th>Time</th></tr>`;
    filtered.forEach(d => {
        html += `<tr style="text-align:center;"><td>${d.number}</td><td>${d.name}</td><td>${d.class}</td><td>${d.time.toDate().toLocaleTimeString()}</td></tr>`;
    });
    display.innerHTML = filtered.length > 0 ? html + `</table>` : "<p>ഡാറ്റ ലഭ്യമല്ല.</p>";
}

function downloadExcel() {
    const cls = document.getElementById('classFilter').value;
    let exportData = (cls === "All") ? attendanceData : attendanceData.filter(d => d.class == cls);
    const ws = XLSX.utils.json_to_sheet(exportData.map(d => ({ "ID": d.number, "Name": d.name, "Class": d.class, "Time": d.time.toDate().toLocaleString() })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, `${currentProg}_Class_${cls}.xlsx`);
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const cls = document.getElementById('classFilter').value;
    let exportData = (cls === "All") ? attendanceData : attendanceData.filter(d => d.class == cls);
    doc.text(`Attendance: ${currentProg} - Class: ${cls}`, 14, 15);
    const rows = exportData.map(d => [d.number, d.name, d.class, d.time.toDate().toLocaleString()]);
    doc.autoTable({ head: [['ID', 'Name', 'Class', 'Time']], body: rows, startY: 20 });
    doc.save(`${currentProg}_Report.pdf`);
}
</script>
</body>
</html>