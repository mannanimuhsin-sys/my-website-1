<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <title>Master Admin - Control Center</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --green: #0b5d1e; --red: #d63031; }
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .control-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        input, select { padding: 12px; margin: 10px; border-radius: 5px; border: 1px solid #ddd; width: 250px; }
        button { padding: 12px 25px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-start { background: var(--green); }
        .btn-stop { background: var(--red); }
        .status-active { color: var(--green); font-weight: bold; }
        .status-off { color: var(--red); font-weight: bold; }
        .attendance-list { background: white; padding: 15px; border-radius: 12px; }
        .stu-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .stu-row img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid var(--green); }
        .time { margin-left: auto; color: #666; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>

<div class="control-box">
    <h2>PROGRAM CONTROL CENTER</h2>
    <div id="statusIndicator">Status: <span class="status-off">Offline</span></div>
    <input type="text" id="progName" placeholder="Program Name">
    <input type="date" id="progDate">
    <br>
    <button class="btn-start" onclick="updateStatus(true)">START SCANNING</button>
    <button class="btn-stop" onclick="updateStatus(false)">STOP & BLOCK</button>
</div>

<div class="attendance-list">
    <h3 id="listTitle">Live Attendance (Latest on Top)</h3>
    <div id="liveFeed"></div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCe98Gw-si7idO0m8y5xbLLG8Z2HC3RCKE",
    authDomain: "mum-new-id.firebaseapp.com",
    projectId: "mum-new-id",
    storageBucket: "mum-new-id.firebasestorage.app",
    messagingSenderId: "794343464244",
    appId: "1:794343464244:web:f9083036490e3609bf1961"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// സ്റ്റാറ്റസ് മാറ്റാൻ
async function updateStatus(isActive) {
    const name = document.getElementById('progName').value;
    const date = document.getElementById('progDate').value;
    if(isActive && (!name || !date)) { alert("പ്രോഗ്രാം വിവരങ്ങൾ നൽകുക"); return; }
    
    await db.collection("settings").doc("scanner_control").set({
        isActive: isActive,
        progName: name,
        progDate: date,
        lastUpdated: new Date()
    });
    alert(isActive ? "സ്കാനിംഗ് ആരംഭിച്ചു!" : "സ്കാനിംഗ് ബ്ലോക്ക് ചെയ്തു!");
}

// അഡ്മിൻ പാനലിലെ ലൈവ് ഫീഡ്
db.collection("settings").doc("scanner_control").onSnapshot(doc => {
    const data = doc.data();
    const statusSpan = document.getElementById('statusIndicator');
    if(data && data.isActive) {
        statusSpan.innerHTML = `Status: <span class="status-active">Scanning Open (${data.progName})</span>`;
        loadLiveAttendance(data.progName, data.progDate);
    } else {
        statusSpan.innerHTML = `Status: <span class="status-off">Blocked / Offline</span>`;
    }
});

let currentUnsub = null;
function loadLiveAttendance(pName, pDate) {
    if(currentUnsub) currentUnsub();
    currentUnsub = db.collection("attendance")
        .where("progName", "==", pName)
        .where("progDate", "==", pDate)
        .orderBy("time", "desc") // പുതിയത് മുകളിൽ വരാൻ
        .onSnapshot(snap => {
            const feed = document.getElementById('liveFeed');
            feed.innerHTML = "";
            snap.forEach(doc => {
                const s = doc.data();
                const t = s.time.toDate();
                const ts = `${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}.${t.getMilliseconds()}`;
                feed.innerHTML += `
                    <div class="stu-row">
                        <img src="${s.photo}">
                        <div><b>${s.name}</b><br><small>Class: ${s.class} | ID: ${s.number}</small></div>
                        <div class="time">${ts}</div>
                    </div>`;
            });
        });
}
</script>
</body>
</html>