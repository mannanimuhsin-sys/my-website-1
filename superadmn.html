<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Control Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --danger: #c0392b; --warning: #f39c12; --success: #27ae60; --info: #2980b9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .admin-container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h2 { color: var(--primary); margin: 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; margin: 2px; font-size: 12px; }
        .btn-approve { background: var(--success); }
        .btn-block { background: var(--warning); }
        .btn-delete { background: var(--danger); }
        .btn-edit-on { background: var(--info); }
        .btn-edit-off { background: #7f8c8d; }
        
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; display: inline-block; margin-top: 5px; }
        .bg-green { background: var(--success); }
        .bg-orange { background: var(--warning); }
        .bg-red { background: var(--danger); }
        .bg-blue { background: var(--info); }
        .bg-gray { background: #7f8c8d; }

        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .madrasa-info b { font-size: 16px; color: #333; }
        .madrasa-info span { color: #666; font-size: 12px; }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="header">
        <h2><i class="fa fa-user-shield"></i> ‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ ‡¥™‡¥æ‡¥®‡µΩ</h2>
        <div id="stats" style="font-weight: bold; color: var(--primary);">‡¥Ü‡¥ï‡µÜ ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥ï‡µæ: 0</div>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï..." onkeyup="filterTable()">

    <div style="overflow-x: auto;">
        <table id="mTable">
            <thead>
                <tr>
                    <th>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ & ‡¥∏‡µç‡¥•‡¥≤‡¥Ç</th>
                    <th>‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡µº</th>
                    <th>‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç</th>
                    <th>‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡¥ø‡¥Ç‡¥ó‡µç ‡¥Ö‡¥®‡µÅ‡¥Æ‡¥§‡¥ø</th>
                    <th>‡¥®‡¥ø‡¥Ø‡¥®‡µç‡¥§‡µç‡¥∞‡¥£‡¥ô‡µç‡¥ô‡µæ (Actions)</th>
                </tr>
            </thead>
            <tbody id="mList">
                </tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // Updated Firebase Config (result-mark)
    const firebaseConfig = { 
        apiKey: "AIzaSyASIPf0V5arZgV0R_2P_0uTq9SVpCWkwUg", 
        authDomain: "result-mark.firebaseapp.com", 
        projectId: "result-mark", 
        storageBucket: "result-mark.firebasestorage.app", 
        messagingSenderId: "425031976316",
        appId: "1:425031976316:web:1a557491b8ecda09c990f9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Listen for Realtime Updates
    db.collection("madrasa_data").onSnapshot(snapshot => {
        const list = document.getElementById('mList');
        list.innerHTML = "";
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            count++;
            
            // Determine Status HTML
            let statusHTML = '';
            if (data.isBlocked) {
                statusHTML = '<span class="status-pill bg-red">Blocked üö´</span>';
            } else if (data.isApproved) {
                statusHTML = '<span class="status-pill bg-green">Live ‚úÖ</span>';
            } else if (data.isPublished) {
                statusHTML = '<span class="status-pill bg-orange">Pending Approval ‚è≥</span>';
            } else {
                statusHTML = '<span class="status-pill bg-gray">Not Published</span>';
            }

            // Editing Permission Status
            const canEdit = data.isPublished === false; // If not published, can edit
            const editBtnHTML = canEdit 
                ? `<button class="btn btn-edit-off" onclick="toggleEdit('${doc.id}', true)">Lock Edit</button>` 
                : `<button class="btn btn-edit-on" onclick="toggleEdit('${doc.id}', false)">Allow Edit</button>`;

            const row = `
                <tr>
                    <td class="madrasa-info">
                        <b>${data.info.name}</b><br>
                        <span><i class="fa fa-map-marker-alt"></i> ${data.info.place || 'Not set'}</span>
                    </td>
                    <td><a href="tel:${data.info.phone}" style="text-decoration:none; color:inherit;">${data.info.phone}</a></td>
                    <td>${statusHTML}</td>
                    <td>
                        ${data.isPublished ? editBtnHTML : '<span class="status-pill bg-blue">Currently Editing</span>'}
                    </td>
                    <td>
                        ${(!data.isApproved && data.isPublished && !data.isBlocked) ? `<button class="btn btn-approve" onclick="updateStatus('${doc.id}', 'approve')">Approve</button>` : ''}
                        ${(data.isApproved && !data.isBlocked) ? `<button class="btn btn-block" onclick="updateStatus('${doc.id}', 'block')">Block Link</button>` : ''}
                        ${(data.isBlocked) ? `<button class="btn btn-approve" onclick="updateStatus('${doc.id}', 'unblock')">Unblock</button>` : ''}
                        <button class="btn btn-delete" onclick="deleteMadrasa('${doc.id}')" title="Delete Permanent"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            list.innerHTML += row;
        });
        document.getElementById('stats').innerText = "‡¥Ü‡¥ï‡µÜ ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥ï‡µæ: " + count;
    });

    // Toggle Edit Permission
    async function toggleEdit(phone, lockValue) {
        const msg = lockValue ? "‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡¥ø‡¥Ç‡¥ó‡µç ‡¥≤‡µã‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?" : "‡¥Ö‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥Ö‡¥®‡µÅ‡¥Æ‡¥§‡¥ø ‡¥®‡µΩ‡¥ï‡¥ü‡µç‡¥ü‡µÜ? (‡¥á‡¥§‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§ ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥§‡¥æ‡¥≤‡µç‡¥ï‡¥æ‡¥≤‡¥ø‡¥ï‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥Æ‡¥±‡¥Ø‡µÅ‡¥Ç)";
        if (confirm(msg)) {
            await db.collection("madrasa_data").doc(phone).update({
                isPublished: !lockValue, // false means they can edit
                isApproved: false // reset approval if they need to edit
            });
        }
    }

    // Approve/Block/Unblock Functions
    async function updateStatus(phone, action) {
        const ref = db.collection("madrasa_data").doc(phone);
        if (action === 'approve') {
            if(confirm("‡¥à ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) {
                await ref.update({ isApproved: true, isBlocked: false });
            }
        } else if (action === 'block') {
            if(confirm("‡¥à ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥¨‡µç‡¥≤‡µã‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) {
                await ref.update({ isApproved: false, isBlocked: true });
            }
        } else if (action === 'unblock') {
            await ref.update({ isApproved: true, isBlocked: false });
        }
    }

    // Delete Permanently
    async function deleteMadrasa(phone) {
        if (confirm("‡¥Æ‡µÅ‡¥®‡µç‡¥®‡¥±‡¥ø‡¥Ø‡¥ø‡¥™‡µç‡¥™‡µç! ‡¥à ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç (‡¥µ‡¥ø‡¥¶‡µç‡¥Ø‡¥æ‡µº‡¥§‡µç‡¥•‡¥ø‡¥ï‡µæ, ‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥â‡µæ‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÜ) ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥Ç. ‡¥à ‡¥®‡¥ü‡¥™‡¥ü‡¥ø ‡¥§‡¥ø‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µÅ‡¥™‡¥ø‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡¥æ‡¥µ‡¥ø‡¥≤‡µç‡¥≤. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) {
            await db.collection("madrasa_data").doc(phone).delete();
            alert("‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ.");
        }
    }

    // Search Filter
    function filterTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll("#mList tr");
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        });
    }
</script>

</body>
</html>