<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Madrasa Control Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --danger: #c0392b; --warning: #f39c12; --success: #27ae60; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .admin-container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h2 { color: var(--primary); margin: 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; margin: 2px; }
        .btn-approve { background: var(--success); }
        .btn-block { background: var(--warning); }
        .btn-delete { background: var(--danger); }
        
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        .bg-green { background: var(--success); }
        .bg-orange { background: var(--warning); }
        .bg-red { background: var(--danger); }
        .bg-gray { background: #7f8c8d; }

        .search-box { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="header">
        <h2><i class="fa fa-user-shield"></i> ‡¥∏‡µÇ‡¥™‡µç‡¥™‡µº ‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥ï‡µ∫‡¥ü‡µç‡¥∞‡µã‡µæ ‡¥™‡¥æ‡¥®‡µΩ</h2>
        <div id="stats"></div>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï..." onkeyup="filterTable()">

    <table id="mTable">
        <thead>
            <tr>
                <th>‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ</th>
                <th>‡¥´‡µã‡µ∫</th>
                <th>‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥ê‡¥°‡¥ø</th>
                <th>‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥µ‡¥∏‡µç‡¥•</th>
                <th>‡¥®‡¥ø‡¥Ø‡¥®‡µç‡¥§‡µç‡¥∞‡¥£‡¥ô‡µç‡¥ô‡µæ (Actions)</th>
            </tr>
        </thead>
        <tbody id="mList">
            </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Ö‡¥§‡µá Firebase Config ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ‡¥Ø‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.com", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        storageBucket: "misbahul-uloom-madrasa-4830c.firebasestorage.app", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥®‡¥ø‡¥∞‡µÄ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    db.collection("madrasa_data").onSnapshot(snapshot => {
        const list = document.getElementById('mList');
        list.innerHTML = "";
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            count++;
            
            // ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ
            let statusHTML = '';
            if (!data.isPublished) statusHTML = '<span class="status-pill bg-gray">Not Published</span>';
            else if (data.isPublished && !data.isApproved) statusHTML = '<span class="status-pill bg-orange">Pending Approval ‚è≥</span>';
            else if (data.isApproved) statusHTML = '<span class="status-pill bg-green">Live ‚úÖ</span>';
            if (data.isBlocked) statusHTML = '<span class="status-pill bg-red">Blocked üö´</span>';

            const row = `
                <tr>
                    <td><strong>${data.info.name}</strong><br><small>${data.info.place}</small></td>
                    <td>${data.info.phone}</td>
                    <td><code>${data.secretID || 'N/A'}</code></td>
                    <td>${statusHTML}</td>
                    <td>
                        ${(!data.isApproved && data.isPublished) ? `<button class="btn btn-approve" onclick="updateStatus('${doc.id}', 'approve')">Approve</button>` : ''}
                        ${(data.isApproved && !data.isBlocked) ? `<button class="btn btn-block" onclick="updateStatus('${doc.id}', 'block')">Block Link</button>` : ''}
                        ${(data.isBlocked) ? `<button class="btn btn-approve" onclick="updateStatus('${doc.id}', 'unblock')">Unblock</button>` : ''}
                        <button class="btn btn-delete" onclick="deleteMadrasa('${doc.id}', '${data.secretID}')"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            list.innerHTML += row;
        });
        document.getElementById('stats').innerText = "‡¥Ü‡¥ï‡µÜ ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥ï‡µæ: " + count;
    });

    // ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡µª (Approve/Block/Unblock)
    async function updateStatus(phone, action) {
        const ref = db.collection("madrasa_data").doc(phone);
        if (action === 'approve') {
            if(confirm("‡¥à ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏ ‡¥Ö‡¥™‡µç‡¥∞‡µÇ‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ? ‡¥Ö‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥≤‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç.")) {
                await ref.update({ isApproved: true, isBlocked: false });
            }
        } else if (action === 'block') {
            if(confirm("‡¥à ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥¨‡µç‡¥≤‡µã‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ? ‡¥∞‡¥ï‡µç‡¥∑‡¥ø‡¥§‡¥æ‡¥ï‡µç‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥ï‡¥æ‡¥£‡¥æ‡µª ‡¥ï‡¥¥‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤.")) {
                await ref.update({ isApproved: false, isBlocked: true });
            }
        } else if (action === 'unblock') {
            await ref.update({ isApproved: true, isBlocked: false });
        }
    }

    // ‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥´‡¥Ç‡¥ó‡µç‡¥∑‡µª
    async function deleteMadrasa(phone, secretID) {
        if (confirm("‡¥Æ‡µÅ‡¥®‡µç‡¥®‡¥±‡¥ø‡¥Ø‡¥ø‡¥™‡µç‡¥™‡µç! ‡¥à ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥Ç. ‡¥§‡µÅ‡¥ü‡¥∞‡¥£‡µã?")) {
            await db.collection("madrasa_data").doc(phone).delete();
            if (secretID) {
                await db.collection("published_links").doc(secretID).delete();
            }
            alert("‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ.");
        }
    }

    // ‡¥∏‡µÜ‡µº‡¥ö‡µç‡¥ö‡µç ‡¥´‡¥ø‡µΩ‡¥ü‡µç‡¥ü‡µº
    function filterTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll("#mList tr");
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        });
    }
</script>

</body>
</html>