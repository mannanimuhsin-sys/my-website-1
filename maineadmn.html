<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Result Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #004d00; --accent: #ffcc00; --bg: #f5f5f5; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; }
        .hero { background: var(--primary); padding: 50px 20px; text-align: center; color: white; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .hero h1 { font-size: 26px; margin: 0; letter-spacing: 1px; }
        .hero p { margin-top: 10px; opacity: 0.9; font-size: 14px; }
        .auth-card { max-width: 400px; margin: -30px auto 20px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #777; transition: 0.3s; }
        .tab.active { background: white; color: var(--primary); border-top: 4px solid var(--primary); }
        .tab-content { padding: 25px; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; border-top: 5px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-add { background: #2c3e50; }
        .class-box { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .st-list-table { width: 100%; background: white; border-radius: 8px; overflow: hidden; border-collapse: collapse; margin-top: 10px; }
        .st-list-table th { background: #f1f1f1; color: #333; font-size: 12px; padding: 8px; text-align: left; border-bottom: 2px solid #ddd; }
        .st-list-table td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 14px; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 12px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .m-input { width: 60px; text-align: center; border: 1px solid #ccc; font-weight: bold; padding: 5px; border-radius: 4px; }
        .status-pass { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        .hidden { display: none; }
        .link-card { background: #e8f5e9; padding: 20px; border-radius: 12px; border: 2px dashed var(--primary); text-align: center; }
        .link-card input { width: 100%; background: white; margin-bottom: 10px; text-align: center; font-weight: bold; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="authPanel">
    <div class="hero">
        <h1>മദ്രസ പരീക്ഷാ ഫലം</h1>
        <p>അഡ്മിൻ മാനേജ്‌മെന്റ് പോർട്ടൽ</p>
    </div>
    <div class="auth-card">
        <div class="tabs">
            <div id="loginTab" class="tab active" onclick="switchAuth('login')">LOGIN</div>
            <div id="regTab" class="tab" onclick="switchAuth('register')">REGISTER</div>
        </div>
        <div class="tab-content" id="loginContent">
            <input type="tel" id="loginPhone" placeholder="മൊബൈൽ നമ്പർ നൽകുക">
            <button class="btn btn-primary" onclick="login()">പ്രവേശിക്കുക</button>
        </div>
        <div class="tab-content hidden" id="regContent">
            <input type="text" id="regMName" placeholder="മദ്രസയുടെ പേര്">
            <input type="text" id="regPlace" placeholder="സ്ഥലം">
            <input type="text" id="regSadr" placeholder="സദർ മുഅല്ലിം"> 
            <input type="tel" id="regPhone" placeholder="മൊബൈൽ നമ്പർ">
            <button class="btn btn-primary" onclick="register()">രജിസ്റ്റർ ചെയ്യുക</button>
        </div>
    </div>
</div>

<div id="statusUI" class="container hidden">
    <div class="section" style="text-align:center; padding:40px;">
        <i class="fa fa-check-circle" style="font-size:60px; color:var(--primary); margin-bottom:20px;"></i>
        <h2>റിസൾട്ട് പബ്ലിഷ് ചെയ്തു!</h2>
        <div id="approvalSection" style="margin-top:20px;"></div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="mInfoDisplay"></div>
            <button class="btn btn-add" onclick="syncWithCloud()"><i class="fa fa-cloud-upload"></i> SAVE ALL DATA</button>
        </div>
    </div>

    <div class="section">
        <h3><i class="fa fa-user-plus"></i> വിദ്യാർത്ഥികളെ ചേർക്കുക</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <select id="stClass"></select>
            <input type="number" id="stRegNo" placeholder="രജി. നമ്പർ">
            <input type="text" id="stName" placeholder="പേര്">
            <button class="btn btn-add" onclick="addStudent()">ADD STUDENT</button>
        </div>
        <div id="studentListArea" style="margin-top:20px;"></div>
    </div>

    <div class="section">
        <h3><i class="fa fa-book"></i> വിഷയങ്ങൾ & ഹാജർ</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <select id="subClass" onchange="loadSubjects()"></select>
            <input type="number" id="classAtt" placeholder="ആകെ ഹാജർ">
            <div style="display:flex; gap:5px;">
                <input type="text" id="newSub" placeholder="വിഷയം">
                <button class="btn btn-add" onclick="addSubject()">ADD</button>
            </div>
        </div>
        <div id="subjectChips" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;"></div>
    </div>

    <div class="section">
        <h3><i class="fa fa-table"></i> മാർക്ക് എൻട്രി</h3>
        <div style="display:flex; gap:10px; max-width: 400px;">
            <select id="markClass"></select>
            <button class="btn btn-primary" onclick="loadMarkTable()">LOAD TABLE</button>
        </div>
        <div id="tableWrapper" class="hidden">
            <div class="table-container">
                <table id="mainTable"><thead id="tHead"></thead><tbody id="tBody"></tbody></table>
            </div>
            <button class="btn" style="background: #27ae60; margin-top:15px;" onclick="exportExcel()"><i class="fa fa-file-excel"></i> DOWNLOAD EXCEL</button>
        </div>
    </div>

    <button class="btn" style="background: #c0392b; width:100%; padding:20px; font-size:18px; margin-top:20px;" onclick="publishResult()">PUBLISH ALL RESULTS</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        storageBucket: "misbahul-uloom-madrasa-4830c.firebasestorage.app", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = {};
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 6", "Class 8", "Class 9", "Class 10", "Class +1", "Class +2"];

    window.onload = () => {
        ["stClass", "subClass", "markClass"].forEach(id => {
            let el = document.getElementById(id);
            el.innerHTML = '<option value="">ക്ലാസ് തിരഞ്ഞെടുക്കുക</option>';
            classes.forEach(c => el.innerHTML += `<option value="${c}">${c}</option>`);
        });
    };

    function switchAuth(type) {
        document.getElementById('loginContent').classList.toggle('hidden', type === 'register');
        document.getElementById('regContent').classList.toggle('hidden', type === 'login');
        document.getElementById('loginTab').classList.toggle('active', type === 'login');
        document.getElementById('regTab').classList.toggle('active', type === 'register');
    }

    async function login() {
        const phone = document.getElementById('loginPhone').value.trim();
        if(!phone) return alert("മൊബൈൽ നമ്പർ നൽകുക");
        try {
            const doc = await db.collection("madrasa_data").doc(phone).get();
            if (doc.exists) {
                mData = doc.data();
                if(mData.isPublished) {
                    document.getElementById('authPanel').classList.add('hidden');
                    showStatusUI();
                } else {
                    document.getElementById('authPanel').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('mInfoDisplay').innerHTML = `<h2>${mData.info.name}</h2><p>${mData.info.place}</p>`;
                    refreshStudentDisplay();
                }
            } else { alert("ഈ നമ്പറിൽ രജിസ്ട്രേഷൻ ലഭ്യമല്ല!"); }
        } catch (error) { alert("ലോഗിൻ ചെയ്യുന്നതിൽ പിശക്!"); }
    }

    async function register() {
        const phone = document.getElementById('regPhone').value.trim();
        const name = document.getElementById('regMName').value.trim();
        const place = document.getElementById('regPlace').value.trim();
        const sadr = document.getElementById('regSadr').value.trim();
        if(!phone || !name || !sadr) return alert("ദയവായി എല്ലാ വിവരങ്ങളും പൂരിപ്പിക്കുക");
        const uID = 'MD' + Math.floor(1000 + Math.random() * 9000);
        const docData = {
            uID: uID,
            info: { name: name, phone: phone, place: place, headmaster: sadr },
            isPublished: false,
            isApproved: false,
            students: {},
            subjects: {},
            results: {},
            classAtt: {}
        };
        try {
            await db.collection("madrasa_data").doc(phone).set(docData);
            alert("രജിസ്ട്രേഷൻ വിജയകരം! ഇനി ലോഗിൻ ചെയ്യാം.");
            location.reload(); 
        } catch (error) { alert("രജിസ്ട്രേഷനിൽ തടസ്സം നേരിട്ടു."); }
    }

    function showStatusUI() {
        document.getElementById('statusUI').classList.remove('hidden');
        const baseURL = "https://mannanimuhsin-sys.github.io/my-website/view.html"; 
        const myUniqueLink = `${baseURL}?id=${mData.uID}`;
        document.getElementById('approvalSection').innerHTML = mData.isApproved ? 
        `<div class="link-card"><p style="color:#004d00; font-weight:bold;">റിസൾട്ട് ലിങ്ക് തയ്യാർ!</p><input type="text" readonly value="${myUniqueLink}" id="resL"><button class="btn btn-primary" onclick="copyMyLink()">COPY LINK</button></div>` : 
        `<p>അഡ്മിൻ അപ്രൂവലിനായി കാത്തിരിക്കുന്നു...</p>`;
    }

    function copyMyLink() {
        const copyText = document.getElementById("resL"); copyText.select();
        navigator.clipboard.writeText(copyText.value); alert("Link Copied!");
    }

    function addStudent() {
        const cls = document.getElementById('stClass').value;
        const reg = document.getElementById('stRegNo').value;
        const name = document.getElementById('stName').value;
        if(!cls || !reg || !name) return alert("എല്ലാം പൂരിപ്പിക്കുക");
        if(!mData.students) mData.students = {};
        if(!mData.students[cls]) mData.students[cls] = {};
        mData.students[cls][reg] = name;
        document.getElementById('stRegNo').value = "";
        document.getElementById('stName').value = "";
        refreshStudentDisplay();
    }

   function refreshStudentDisplay() {
    const area = document.getElementById('studentListArea'); 
    area.innerHTML = "";
    for(let cls in mData.students) {
        let html = `<div class="class-box"><strong>${cls}</strong>
            <table class="st-list-table">
                <thead><tr><th>Reg No</th><th>Name</th><th>Action</th></tr></thead>
                <tbody>`;
        
        for(let reg in mData.students[cls]) { 
            html += `<tr>
                <td><input type="number" value="${reg}" onchange="editStudentReg('${cls}', '${reg}', this.value)" style="width:70px; border:1px solid #ddd; padding:4px;"></td>
                <td><input type="text" value="${mData.students[cls][reg]}" onchange="editStudentName('${cls}', '${reg}', this.value)" style="width:90%; border:1px solid #ddd; padding:4px;"></td>
                <td><i class="fa fa-trash" style="color:#c0392b; cursor:pointer;" onclick="deleteStudent('${cls}', '${reg}')"></i></td>
            </tr>`; 
        }
        area.innerHTML += html + `</tbody></table></div>`;
    }
}

    function deleteStudent(cls, reg) { if(confirm("Delete Student?")) { delete mData.students[cls][reg]; refreshStudentDisplay(); } }
    // പേര് മാറ്റം വരുത്താൻ
function editStudentName(cls, reg, newName) {
    if(newName.trim() === "") return alert("പേര് ഒഴിച്ചിടരുത്!");
    mData.students[cls][reg] = newName.trim();
}

// രജിസ്റ്റർ നമ്പർ മാറ്റം വരുത്താൻ
function editStudentReg(cls, oldReg, newReg) {
    if(newReg.trim() === "" || oldReg === newReg) return;
    
    // പുതിയ നമ്പർ നിലവിൽ ഉണ്ടോ എന്ന് പരിശോധിക്കുന്നു
    if(mData.students[cls][newReg]) {
        alert("ഈ നമ്പർ നിലവിൽ വേറെ വിദ്യാർത്ഥിക്കുണ്ട്!");
        refreshStudentDisplay();
        return;
    }
    
    // വിവരങ്ങൾ പുതിയ നമ്പറിലേക്ക് മാറ്റുന്നു
    mData.students[cls][newReg] = mData.students[cls][oldReg];
    delete mData.students[cls][oldReg];
    
    // റിസൾട്ടിലും മാറ്റം വരുത്തുന്നു
    if(mData.results && mData.results[cls] && mData.results[cls][oldReg]) {
        mData.results[cls][newReg] = mData.results[cls][oldReg];
        delete mData.results[cls][oldReg];
    }
    refreshStudentDisplay();
}

   function addSubject() {
    const cls = document.getElementById('subClass').value;
    const sub = document.getElementById('newSub').value.trim();
    if(!cls || !sub) return alert("ക്ലാസ്സും വിഷയവും നൽകുക");
    if(!mData.subjects) mData.subjects = {};
    if(!mData.subjects[cls]) mData.subjects[cls] = [];
    
    if(mData.subjects[cls].includes(sub)) return alert("ഈ വിഷയം നിലവിൽ ഉണ്ട്");
    
    mData.subjects[cls].push(sub);
    document.getElementById('newSub').value = ""; 
    loadSubjects();
}

function loadSubjects() {
    const cls = document.getElementById('subClass').value;
    const area = document.getElementById('subjectChips'); 
    area.innerHTML = "";
    
    if(mData.subjects && mData.subjects[cls]) {
        let html = `<table class="st-list-table" style="margin-top:10px;">
            <thead><tr><th>Subject Name</th><th style="width:50px; text-align:center;">Action</th></tr></thead>
            <tbody>`;
        
        mData.subjects[cls].forEach((s, index) => {
            html += `<tr>
                <td>
                    <input type="text" value="${s}" 
                    onchange="editSubjectName('${cls}', ${index}, this.value)" 
                    style="width:95%; border:1px solid #ddd; padding:6px; border-radius:4px;">
                </td>
                <td style="text-align:center;">
                    <i class="fa fa-trash" style="color:#c0392b; cursor:pointer;" onclick="deleteSubject('${cls}', ${index})"></i>
                </td>
            </tr>`;
        });
        area.innerHTML = html + `</tbody></table>`;
    }
}

function editSubjectName(cls, index, newName) {
    if(newName.trim() === "") return alert("വിഷയത്തിന്റെ പേര് ഒഴിച്ചിടരുത്!");
    const oldName = mData.subjects[cls][index];
    mData.subjects[cls][index] = newName.trim();
    
    if(mData.results && mData.results[cls]) {
        for(let reg in mData.results[cls]) {
            if(mData.results[cls][reg].marks && mData.results[cls][reg].marks[oldName]) {
                mData.results[cls][reg].marks[newName.trim()] = mData.results[cls][reg].marks[oldName];
                delete mData.results[cls][reg].marks[oldName];
            }
        }
    }
}

function deleteSubject(cls, index) {
    if(confirm("ഈ വിഷയം നീക്കം ചെയ്യട്ടെ? ഈ വിഷയത്തിലെ മാർക്കുകളും നീക്കം ചെയ്യപ്പെടും.")) {
        const subName = mData.subjects[cls][index];
        mData.subjects[cls].splice(index, 1);
        
        if(mData.results && mData.results[cls]) {
            for(let reg in mData.results[cls]) {
                if(mData.results[cls][reg].marks) {
                    delete mData.results[cls][reg].marks[subName];
                }
            }
        }
        loadSubjects();
    }
}
   function loadMarkTable() {
    const cls = document.getElementById('markClass').value;
    if (!cls) return alert("ക്ലാസ് തിരഞ്ഞെടുക്കുക");
    const subs = mData.subjects[cls] || [];
    const studs = mData.students[cls] || {};
    
    if(mData.classAtt && mData.classAtt[cls]) {
        document.getElementById('classAtt').value = mData.classAtt[cls];
    }

    // ഘട്ടം A: ഹെഡർ (ഇത് നിങ്ങൾ ഇപ്പോൾ മാറ്റിയത് പോലെ തന്നെ)
    let h = `<tr><th>Reg</th><th>Name</th><th>ഹാജർ</th>`;
    subs.forEach(s => h += `<th>${s}</th>`);
    h += `<th>Total</th><th>Status</th><th>Rank</th></tr>`;
    document.getElementById('tHead').innerHTML = h;

    let b = "";
    for(let reg in studs) {
        const oldRes = (mData.results && mData.results[cls] && mData.results[cls][reg]) ? mData.results[cls][reg] : {};
        
        // വരി തുടങ്ങുന്നു - രജിസ്റ്റർ നമ്പർ, പേര്, ഹാജർ
        b += `<tr data-reg="${reg}">
                <td>${reg}</td>
                <td>${studs[reg]}</td>
                <td><input type="number" class="m-input s-att" value="${oldRes.att || ""}" oninput="autoSave()"></td>`;

        // ഓരോ വിഷയത്തിന്റെയും മാർക്ക് ബോക്സുകൾ
        subs.forEach(s => {
            const oldMark = (oldRes.marks && oldRes.marks[s]) ? oldRes.marks[s] : "";
            b += `<td><input type="number" class="m-input s-mark" data-sub="${s}" value="${oldMark}" oninput="calcStatus(this)"></td>`;
        });

        // ഘട്ടം B: ടോട്ടൽ, സ്റ്റാറ്റസ്, റാങ്ക് (ഇവിടെയാണ് മാറ്റം വേണ്ടത്)
        b += `<td class="r-tot">${oldRes.total || "0"}</td>
            <td style="width: 130px;"> 
                <select class="r-sts-select" onchange="manualStatusChange(this)" style="padding:6px; border-radius:4px; font-weight:bold; border:1px solid #ccc; width:100%; cursor:pointer; color: ${oldRes.status === 'Passed' ? 'green' : (oldRes.status === 'Promoted' ? 'blue' : 'red')}">
                    <option value="Passed" ${oldRes.status === 'Passed' ? 'selected' : ''}>Passed</option>
                    <option value="Failed" ${oldRes.status === 'Failed' ? 'selected' : ''}>Failed</option>
                    <option value="Promoted" ${oldRes.status === 'Promoted' ? 'selected' : ''}>Promoted</option>
                </select>
            </td>
            <td>
                <input type="text" class="m-input r-rank" value="${oldRes.rank || ""}" oninput="autoSave()" placeholder="Rank" style="width:60px; text-align:center; border:1px solid #ccc; background:white;">
            </td>
        </tr>`;
    }
    
    document.getElementById('tBody').innerHTML = b;
    document.getElementById('tableWrapper').classList.remove('hidden');
}

    function calcStatus(input) {
    const row = input.closest('tr');
    let total = 0, isFailed = false, hasValue = false;
    row.querySelectorAll('.s-mark').forEach(i => {
        if(i.value !== "") {
            hasValue = true;
            let val = parseFloat(i.value) || 0;
            total += val;
            if(val < 18) isFailed = true; 
        }
    });
    if(!hasValue) return;
    row.querySelector('.r-tot').innerText = total;
    
    const stsSelect = row.querySelector('.r-sts-select');
    if(isFailed) { 
        stsSelect.value = "Failed"; 
        stsSelect.style.color = "red";
    } else { 
        stsSelect.value = "Passed"; 
        stsSelect.style.color = "green";
    }
    autoSave();
}

function manualStatusChange(select) {
    if(select.value === "Passed") select.style.color = "green";
    else if(select.value === "Promoted") select.style.color = "blue";
    else select.style.color = "red";
    autoSave();
}
   function calculateRanks() {
    // ഓട്ടോമാറ്റിക് റാങ്ക് വേണ്ടെന്ന് വെച്ചു. 
    // ഇനി മുതൽ ഉസ്താദുമാർ നേരിട്ട് ടൈപ്പ് ചെയ്യുന്നത് റാങ്ക് ആയി സേവ് ആകും.
}

    function autoSave() {
        const cls = document.getElementById('markClass').value;
        if (!cls) return;
        if (!mData.results) mData.results = {};
        if (!mData.results[cls]) mData.results[cls] = {};
        if (!mData.classAtt) mData.classAtt = {};
        mData.classAtt[cls] = document.getElementById('classAtt').value;
        document.querySelectorAll('#tBody tr').forEach(row => {
            const reg = row.getAttribute('data-reg');
            let marks = {};
            row.querySelectorAll('.s-mark').forEach(input => { marks[input.getAttribute('data-sub')] = input.value; });
            mData.results[cls][reg] = {
                att: row.querySelector('.s-att').value,
                marks: marks,
                total: row.querySelector('.r-tot').innerText,
              status: row.querySelector('.r-sts-select').value,
              rank: row.querySelector('.r-rank').value
            };
        });
    }

    async function syncWithCloud() { 
        if(!mData.info || !mData.info.phone) return alert("ലോഗിൻ വിവരങ്ങൾ ലഭ്യമല്ല");
        autoSave(); // ഉറപ്പാക്കാൻ ഒരിക്കൽ കൂടി സേവ് ചെയ്യുന്നു
        await db.collection("madrasa_data").doc(mData.info.phone).set(mData); 
        alert("Data Saved Successfully!"); 
    }
    
    async function publishResult() { 
        if(confirm("എല്ലാ റിസൾട്ടുകളും പബ്ലിഷ് ചെയ്യട്ടെ?")) { 
            mData.isPublished = true; await syncWithCloud(); location.reload(); 
        } 
    }
    function exportExcel() {
    const cls = document.getElementById('markClass').value;
    const table = document.getElementById("mainTable");
    if (!table) return alert("ആദ്യം ടേബിൾ ലോഡ് ചെയ്യുക!");

    let data = [];
    
    // 1. ഹെഡർ (തലക്കെട്ടുകൾ) എടുക്കുന്നു
    let headers = [];
    table.querySelectorAll("thead th").forEach(th => {
        headers.push(th.innerText);
    });
    data.push(headers);

    // 2. ഓരോ വരിയിലെയും മാർക്കുകൾ എടുക്കുന്നു
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
        let rowData = [];
        const cells = row.querySelectorAll("td");
        
        cells.forEach((cell) => {
            const input = cell.querySelector("input");
            const select = cell.querySelector("select");
            
            if (input) {
                // മാർക്ക് അല്ലെങ്കിൽ റാങ്ക് വാല്യൂ എടുക്കുന്നു
                rowData.push(input.value || "0");
            } else if (select) {
                // സ്റ്റാറ്റസ് (Passed/Failed) എടുക്കുന്നു
                rowData.push(select.value);
            } else {
                // പേരും നമ്പറും എടുക്കുന്നു
                rowData.push(cell.innerText);
            }
        });
        data.push(rowData);
    });

    // 3. എക്സൽ ഫയൽ നിർമ്മിക്കുന്നു
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Result");

    // 4. ഡൗൺലോഡ്
    XLSX.writeFile(workbook, `Result_${cls}.xlsx`);
}
function exportToPDF() {
    try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            alert("PDF ലൈബ്രറി ലോഡ് ആയിട്ടില്ല. ഇന്റർനെറ്റ് ഉണ്ടെന്ന് ഉറപ്പാക്കുക.");
            return;
        }

        const doc = new jsPDF('l', 'pt', 'a4'); // Landscape മോഡ്
        const cls = document.getElementById('markClass').value;
        const table = document.getElementById("mainTable");

        if (!table) return alert("ആദ്യം ടേബിൾ ലോഡ് ചെയ്യുക!");

        // 1. തലക്കെട്ടുകൾ ശേഖരിക്കുന്നു (വിഷയങ്ങൾ ഉൾപ്പെടെ)
        let headers = [];
        table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText));

        // 2. മാർക്കുകളും മറ്റ് വിവരങ്ങളും ശേഖരിക്കുന്നു
        let body = [];
        table.querySelectorAll("tbody tr").forEach(row => {
            let rowData = [];
            row.querySelectorAll("td").forEach(td => {
                const input = td.querySelector("input");
                const select = td.querySelector("select");
                
                if (input) {
                    rowData.push(input.value || "0"); // മാർക്ക്/റാങ്ക് എടുക്കുന്നു
                } else if (select) {
                    rowData.push(select.value); // സ്റ്റാറ്റസ് എടുക്കുന്നു
                } else {
                    rowData.push(td.innerText); // പേര്, റോൾ നമ്പർ
                }
            });
            body.push(rowData);
        });

        // 3. PDF ഡിസൈൻ
        doc.setFontSize(18);
        doc.setTextColor(0, 77, 0);
        doc.text(mData.info.name, 40, 40);
        
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Class: ${cls} | Place: ${mData.info.place}`, 40, 60);

        // 4. ഓട്ടോ ടേബിൾ നിർമ്മാണം
        doc.autoTable({
            head: [headers],
            body: body,
            startY: 80,
            theme: 'grid',
            styles: { fontSize: 8, halign: 'center' },
            headStyles: { fillColor: [0, 77, 0], textColor: [255, 255, 255] }
        });

        // 5. ഡൗൺലോഡ്
        doc.save(`Result_${mData.info.name}_${cls}.pdf`);

    } catch (err) {
        console.error("PDF Error: ", err);
        alert("PDF നിർമ്മിക്കുന്നതിൽ തടസ്സം നേരിട്ടു.");
    }
}
</script>
</body>
</html>