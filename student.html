<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Official Student ID System</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>
:root{--green:#0b5d1e;--orange:#f39c12}
body{margin:0;background:#e9ecef;font-family:Roboto}
.container{max-width:430px;margin:auto;padding:15px}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.15)}
.tabs{display:flex;margin-bottom:15px}
.tabs button{flex:1;padding:12px;border:none;font-weight:bold;cursor:pointer}
.tabs .active{background:var(--green);color:#fff}
input,select{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;display:block}
label{font-size:12px;font-weight:bold;color:var(--green);margin-top:10px;display:block}
button{width:100%;padding:14px;margin-top:15px;border:none;border-radius:10px;background:var(--green);color:#fff;font-weight:bold;cursor:pointer}

/* ID CARD */
#idArea{display:none;text-align:center;padding:20px 10px}
#idCard{
 width:280px;background:#fff;margin:auto;border-radius:12px;
 overflow:hidden;box-shadow:0 20px 45px rgba(0,0,0,.4);border:2px solid #ddd;
 position:relative;
}
.header{background:var(--green);color:#fff;padding:10px}
.header h1{margin:0;font-size:18px}
.header p{margin:4px 0 0;font-size:13px}
.ribbon{background:var(--orange);color:#fff;font-weight:900;width:80%;margin:10px auto;padding:6px;border-radius:20px;position:relative;z-index:2;display:block}
.photoBox{width:100px;height:130px;margin:5px auto;border-radius:14px;overflow:hidden;border:4px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.2)}
.photoBox img{width:100%;height:100%;object-fit:cover}
.details{padding:15px;text-align:left;font-size:11px}
.row{display:flex;border-bottom:1px solid #eee;padding:3px 0}
.row span:first-child{width:90px;color:#666;font-weight:bold}
.row span:last-child{font-weight:bold;color:#111}
.footer{display:flex;justify-content:space-between;align-items:center;padding:5px 15px 10px}
.footer img#qr{width:60px;height:60px}
.sign{text-align:center;font-size:11px}
#signImg{width:70px;height:auto;display:block;margin:0 auto -6px;filter:grayscale(1) contrast(1.5);}
.sign div{border-top:2px solid #333;width:90px;margin:4px auto 0}

/* Cropper Modal */
#cropBox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 10px;
}

.crop-container {
  background: #fff;
  padding: 10px;
  border-radius: 14px;
  width: 95%;
  max-width: 320px; /* ബോക്സ് ഒതുക്കി നിർത്തി */
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#cropImg {
  display: block;
  max-width: 100%;
  max-height: 350px; /* ഫോട്ടോയുടെ നീളം കുറച്ചു, അപ്പോൾ ബട്ടൺ താഴെ കാണാം */
}

.crop-btn {
  background: var(--green);
  color: #fff;
  border: none;
  padding: 14px;
  width: 100%;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
}
/* QR PREVIEW PAGE */
#qrPage{display:none;min-height:100vh;background:#f4f6f8;align-items:center;justify-content:center}
.qrCard{background:#fff;padding:25px;border-radius:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.qrCard img{width:150px;height:200px;object-fit:cover;border-radius:12px}
</style>
</head>

<body>

<div class="container" id="panel">
 <div class="card">
  <div class="tabs">
   <button id="tReg" class="active" onclick="showTab('reg')">REGISTER</button>
   <button id="tLog" onclick="showTab('log')">LOGIN</button>
  </div>

  <div id="regTab">
   <input id="name" placeholder="Full Name">
   <input id="regno" placeholder="Register Number">
   <input id="classN" placeholder="Class">
   <input id="father" placeholder="Father Name">
   <input id="mentor" placeholder="Mentor Name">
   <input id="phone" placeholder="Phone Number">

   <select id="gender">
    <option value="">Select Gender</option>
    <option>Male</option>
    <option>Female</option>
   </select>

   <select id="blood">
    <option value="">Select Blood Group</option>
    <option>A+</option><option>B+</option><option>O+</option><option>AB+</option>
    <option>A-</option><option>B-</option><option>O-</option><option>AB-</option>
   </select>

   <label>Select Date of Birth</label>
   <input type="date" id="dob">
   
   <label>Upload & Crop Photo</label>
   <input type="file" id="photoInp" accept="image/*">
   
   <button onclick="saveStudent()">SAVE & GENERATE ID CARD</button>
  </div>

  <div id="logTab" style="display:none">
   <input id="loginReg" placeholder="Enter Register Number">
   <button onclick="login()">VIEW ID CARD</button>
  </div>
 </div>
</div>

<div id="idArea">
 <div id="idCard">
  <div class="header">
   <h1>MISBAHUL ULOOM</h1>
   <p>MADRASA - PERUVANA | REG.NO: 4224</p>
  </div>
  <div class="ribbon">STUDENT IDENTITY CARD</div>

  <div class="photoBox"><img id="pImg"></div>

  <div class="details">
   <div class="row"><span>Name</span><span id="pName"></span></div>
   <div class="row"><span>Father</span><span id="pFather"></span></div>
   <div class="row"><span>Class</span><span id="pClass"></span></div>
   <div class="row"><span>Mentor</span><span id="pMentor"></span></div>
   <div class="row"><span>Blood</span><span id="pBlood"></span></div>
   <div class="row"><span>Phone</span><span id="pPhone"></span></div>
   <div class="row"><span>DOB</span><span id="pDob"></span></div>
   <div class="row"><span>ID No</span><span id="pReg"></span></div>
  </div>

  <div class="footer">
    <img id="qr" src="">
    <div class="sign">
      <img src="signature.png" id="signImg">
      <div></div>
      Sadar Muallim
    </div>
  </div>
 </div>

 <div style="max-width:360px; margin:20px auto;">
  <button onclick="downloadID()">DOWNLOAD ID (PNG)</button>
  <button onclick="location.reload()" style="background:#555">GO BACK</button>
 </div>
</div>

<div id="cropBox">
 <div class="crop-container">
  <img id="cropImg">
  <button class="crop-btn" onclick="applyCrop()">CROP & APPLY PHOTO</button>
 </div>
</div>

<div id="qrPage">
 <div class="qrCard">
  <img id="qrPhoto">
  <h2 id="qrName"></h2>
  <p id="qrClass"></p>
 </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
let cropper, photoData;

// ഫയർബേസ് കണക്ഷൻ ഇവിടെ ചേർക്കുന്നു
firebase.initializeApp({
  apiKey: "AIzaSyCe98Gw-si7idO0m8y5xbLLG8Z2HC3RCKE",
  authDomain: "mum-new-id.firebaseapp.com",
  projectId: "mum-new-id",
  storageBucket: "mum-new-id.firebasestorage.app",
  messagingSenderId: "794343464244",
  appId: "1:794343464244:web:f9083036490e3609bf1961"
});
const db = firebase.firestore();

function showTab(t){
 regTab.style.display=t=="reg"?"block":"none";
 logTab.style.display=t=="log"?"block":"none";
 tReg.classList.toggle("active",t=="reg");
 tLog.classList.toggle("active",t=="log");
}

photoInp.onchange=e=>{
 const file = e.target.files[0];
 if (file) {
  const r = new FileReader();
  r.onload = () => {
   cropImg.src = r.result;
   cropBox.style.display = "flex";
   if (cropper) cropper.destroy();
   cropper = new Cropper(cropImg, {
    aspectRatio: 3/4,
    viewMode: 1
   });
  };
  r.readAsDataURL(file);
 }
}

function applyCrop(){
 photoData = cropper.getCroppedCanvas({ width: 300, height: 400 }).toDataURL("image/jpeg");
 cropBox.style.display = "none";
 alert("ഫോട്ടോ ക്രോപ്പ് ചെയ്ത് അറ്റാച്ച് ചെയ്തിരിക്കുന്നു ✅");
}

async function saveStudent(){
 // 1. ഫോട്ടോയും നമ്പറും ഉണ്ടെന്ന് ഉറപ്പുവരുത്തുന്നു
 if(!photoData) { alert("ദയവായി ഫോട്ടോ അപ്‌ലോഡ് ചെയ്ത് ക്രോപ്പ് ചെയ്യുക!"); return; }
 if(!regno.value) { alert("രജിസ്റ്റർ നമ്പർ നിർബന്ധമാണ്!"); return; }

 // 2. വിവരങ്ങൾ ഒരുമിച്ച് ചേർക്കുന്നു (ഇവിടെയാണ് name, number എന്നിവയുള്ളത്)
 const s = {
  name: name.value,     // വിദ്യാർത്ഥിയുടെ പേര്
  number: regno.value,  // രജിസ്റ്റർ നമ്പർ (അഡ്മിൻ പാനലിൽ കാണാൻ 'number' എന്ന് തന്നെ വേണം)
  class: classN.value,  // ക്ലാസ്സ്
  father: father.value, // രക്ഷിതാവ്
  mentor: mentor.value, // മെന്റർ
  phone: phone.value,   // ഫോൺ നമ്പർ
  gender: gender.value, // ലിംഗം
  blood: blood.value,   // ബ്ലഡ് ഗ്രൂപ്പ്
  dob: dob.value,       // ജനനത്തീയതി
  photo: photoData      // ക്രോപ്പ് ചെയ്ത ഫോട്ടോ
 };
 
 try {
  // 3. ഫയർബേസ് ഡാറ്റാബേസിലേക്ക് അയക്കുന്നു (ഓൺലൈൻ സേവ്)
  await db.collection("students").add(s);
  
  // 4. ബാക്കപ്പിന് വേണ്ടി ഫോണിലും സേവ് ചെയ്യുന്നു
  localStorage.setItem("STU_"+s.number, JSON.stringify(s));
  
  alert("വിവരങ്ങൾ അഡ്മിൻ പാനലിലേക്ക് വിജയകരമായി സേവ് ചെയ്തു ✅");
  
  // 5. ഐഡി കാർഡ് സ്ക്രീനിൽ കാണിക്കുന്നു
  renderID(s); 
  
 } catch (e) {
  console.error("Error adding document: ", e);
  alert("Error: വിവരങ്ങൾ സേവ് ചെയ്യാൻ കഴിഞ്ഞില്ല. ഇന്റർനെറ്റ് ഉണ്ടെന്ന് ഉറപ്പുവരുത്തുക!");
 }
}

function login(){
 const d = localStorage.getItem("STU_"+loginReg.value);
 if(!d){ alert("ഈ രജിസ്റ്റർ നമ്പറിൽ വിദ്യാർത്ഥിയെ കണ്ടെത്തിയില്ല!"); return; }
 renderID(JSON.parse(d));
}

function renderID(s){
 pName.innerText = s.name;
 pFather.innerText = s.father;
 pClass.innerText = s.class;
 pMentor.innerText = s.mentor;
 pBlood.innerText = s.blood;
 pPhone.innerText = s.phone;
 pDob.innerText = s.dob.split("-").reverse().join("-");
 pReg.innerText = s.number;
 pImg.src = s.photo;

 const qrInfo = encodeURIComponent(JSON.stringify({
  name: s.name,
  class: s.class,
  photo: s.photo
 }));
 
 qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${location.href.split("#")[0]}#QR=${qrInfo}`;

 panel.style.display = "none";
 idArea.style.display = "block";
}

function downloadID(){
 html2canvas(document.querySelector("#idCard"), {
  scale: 3, 
  useCORS: true,
  allowTaint: true
 }).then(c => {
  let a = document.createElement("a");
  a.href = c.toDataURL("image/png");
  a.download = `ID_CARD_${pReg.innerText}.png`;
  a.click();
 });
}

// Handling QR Scan View
if(location.hash.startsWith("#QR=")){
 document.body.innerHTML = "";
 document.body.style.display = "flex";
 document.body.style.alignItems = "center";
 document.body.style.justifyContent = "center";
 document.body.style.minHeight = "100vh";
 document.body.style.background = "#f0f2f5";
 
 const qrDataRaw = decodeURIComponent(location.hash.replace("#QR=", ""));
 const d = JSON.parse(qrDataRaw);
 
 const qrHtml = `
  <div style="background:#fff; padding:30px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.1); max-width:300px">
   <img src="${d.photo}" style="width:150px; height:200px; object-fit:cover; border-radius:12px; border:4px solid var(--green)">
   <h2 style="margin:15px 0 5px; color:#111">${d.name}</h2>
   <p style="margin:0; font-weight:bold; color:var(--green)">Class: ${d.class}</p>
   <p style="margin-top:10px; font-size:12px; color:#666">Verified Student Identity</p>
  </div>
 `;
 document.body.innerHTML = qrHtml;
}
</script>

</body>
</html>