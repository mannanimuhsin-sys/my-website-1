<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Result Admin | Exam 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #004d00; --accent: #ffcc00; --bg: #f5f5f5; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; }
        .hero { background: var(--primary); padding: 50px 20px; text-align: center; color: white; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .hero h1 { font-size: 26px; margin: 0; letter-spacing: 1px; }
        .auth-card { max-width: 400px; margin: -30px auto 20px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #777; }
        .tab.active { background: white; color: var(--primary); border-top: 4px solid var(--primary); }
        .tab-content { padding: 25px; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; border-top: 5px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-add { background: #2c3e50; }
        .st-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .st-list-table th { background: #f1f1f1; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        .st-list-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .hidden { display: none; }
        .link-card { background: #fff3cd; padding: 20px; border-radius: 12px; border: 2px dashed #856404; text-align: center; margin-top: 10px; }
        .photo-status { font-size: 18px; }
    </style>
</head>
<body>

<div id="authPanel">
    <div class="hero"><h1>മദ്രസ പരീക്ഷാ ഫലം</h1><p>അഡ്മിൻ മാനേജ്‌മെന്റ് പോർട്ടൽ</p></div>
    <div class="auth-card">
        <div class="tabs">
            <div id="loginTab" class="tab active" onclick="switchAuth('login')">LOGIN</div>
            <div id="regTab" class="tab" onclick="switchAuth('register')">REGISTER</div>
        </div>
        <div class="tab-content" id="loginContent">
            <input type="tel" id="loginPhone" placeholder="മൊബൈൽ നമ്പർ നൽകുക">
            <button class="btn btn-primary" onclick="login()">പ്രവേശിക്കുക</button>
        </div>
        <div class="tab-content hidden" id="regContent">
            <input type="text" id="regMName" placeholder="മദ്രസയുടെ പേര്">
            <input type="text" id="regPlace" placeholder="സ്ഥലം">
            <input type="text" id="regSadr" placeholder="സദർ മുഅല്ലിം"> 
            <input type="tel" id="regPhone" placeholder="മൊബൈൽ നമ്പർ">
            <button class="btn btn-primary" onclick="register()">രജിസ്റ്റർ ചെയ്യുക</button>
        </div>
    </div>
</div>

<div id="adminPanel" class="container hidden">
    <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="mInfoDisplay"></div>
            <button class="btn btn-add" onclick="syncWithCloud()"><i class="fa fa-save"></i> SAVE ALL DATA</button>
        </div>
    </div>

    <div class="section">
        <h3><i class="fa fa-user-plus"></i> വിദ്യാർത്ഥികളെ ചേർക്കുക</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <select id="stClass"></select>
            <input type="number" id="stRegNo" placeholder="രജി. നമ്പർ">
            <input type="text" id="stName" placeholder="പേര്">
            <button class="btn btn-add" onclick="addStudent()">ADD STUDENT</button>
        </div>
        <div id="studentListArea" style="margin-top:20px;"></div>
    </div>

    <div class="section">
        <h3><i class="fa fa-book"></i> വിഷയങ്ങൾ</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <select id="subClass" onchange="loadSubjects()"></select>
            <div style="display:flex; gap:5px;"><input type="text" id="newSub" placeholder="വിഷയം"><button class="btn btn-add" onclick="addSubject()">ADD</button></div>
        </div>
        <div id="subjectChips" style="margin-top:15px;"></div>
    </div>

    <div class="section">
        <h3><i class="fa fa-table"></i> മാർക്ക് എൻട്രി</h3>
        <div style="display:flex; gap:10px; max-width: 400px;"><select id="markClass"></select><button class="btn btn-primary" onclick="loadMarkTable()">LOAD TABLE</button></div>
        <div id="tableWrapper" class="hidden">
            <div style="overflow-x:auto;"><table id="mainTable"><thead id="tHead"></thead><tbody id="tBody"></tbody></table></div>
        </div>
    </div>

    <button id="preSubmitBtn" class="btn" style="background: #2980b9; width:100%; padding:20px; font-size:18px;" onclick="initPhotoPhase()">SUBMIT FOR PHOTO COLLECTION</button>

    <div id="photoLinkSection" class="section hidden">
        <h3><i class="fa fa-camera"></i> ഫോട്ടോ അപ്‌ലോഡ് ഘട്ടം</h3>
        <div class="link-card">
            <p>രക്ഷിതാക്കൾക്ക് ഫോട്ടോ അപ്‌ലോഡ് ചെയ്യാൻ ഈ ലിങ്ക് നൽകുക:</p>
            <input type="text" readonly id="photoUploadURL" style="text-align:center; font-weight:bold;">
            <button class="btn btn-primary" onclick="copyLink()">COPY LINK</button>
        </div>
        <div id="photoStatusList" style="margin-top:20px;"></div>
        <button class="btn" style="background: #c0392b; width:100%; padding:20px; margin-top:20px;" onclick="publishResult()">PUBLISH FINAL RESULTS</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ", 
        authDomain: "misbahul-uloom-madrasa-4830c.firebaseapp.app", 
        projectId: "misbahul-uloom-madrasa-4830c", 
        storageBucket: "misbahul-uloom-madrasa-4830c.firebasestorage.app", 
        appId: "1:370558703441:web:dc68dbdbd685c9d07ea570" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let mData = {};
    const classes = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 6", "Class 8", "Class 9", "Class 10", "Class +1", "Class +2"];

    window.onload = () => {
        ["stClass", "subClass", "markClass"].forEach(id => {
            let el = document.getElementById(id);
            classes.forEach(c => el.innerHTML += `<option value="${c}">${c}</option>`);
        });
    };

    async function login() {
        const phone = document.getElementById('loginPhone').value.trim();
        const doc = await db.collection("madrasa_data").doc(phone).get();
        if (doc.exists) {
            mData = doc.data();
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('mInfoDisplay').innerHTML = `<h2>${mData.info.name}</h2>`;
            refreshStudentDisplay();
            if(mData.isPhotoPhase) initPhotoPhase(true);
        } else { alert("Not Found"); }
    }

    function initPhotoPhase(isAuto = false) {
        if(!isAuto && !confirm("സബ്മിറ്റ് ചെയ്യട്ടെ? ഇതിന് ശേഷം ഫോട്ടോകൾ ശേഖരിക്കാം.")) return;
        mData.isPhotoPhase = true;
        document.getElementById('preSubmitBtn').classList.add('hidden');
        document.getElementById('photoLinkSection').classList.remove('hidden');
        
        // ഫോട്ടോ അപ്‌ലോഡ് പേജിന്റെ ലിങ്ക് ജനറേറ്റ് ചെയ്യുന്നു
        const baseURL = window.location.href.replace('exam.html', 'photo_upload.html');
        document.getElementById('photoUploadURL').value = `${baseURL}?id=${mData.uID}`;
        renderPhotoStatus();
    }

    function renderPhotoStatus() {
        let html = "";
        for(let cls in mData.students) {
            html += `<div class="class-box"><h4>${cls}</h4><table class="st-list-table">`;
            for(let reg in mData.students[cls]) {
                const hasPhoto = (mData.photos && mData.photos[reg]) ? '<span style="color:green">✅ Uploaded</span>' : '<span style="color:red">❌ No Photo</span>';
                html += `<tr><td>${reg}</td><td>${mData.students[cls][reg]}</td><td>${hasPhoto}</td><td><i class="fa fa-refresh" onclick="resetPhoto('${reg}')"></i></td></tr>`;
            }
            html += `</table></div>`;
        }
        document.getElementById('photoStatusList').innerHTML = html;
    }

    // --- പഴയ എല്ലാ ഫംഗ്ഷനുകളും (addStudent, addSubject, loadMarkTable etc.) താഴെ മാറ്റമില്ലാതെ തുടരും ---
    // (സ്ഥലം പരിമിതമായതിനാൽ ചുരുക്കുന്നു, നിങ്ങളുടെ പഴയ ഫംഗ്ഷനുകൾ ഇവിടെ പേസ്റ്റ് ചെയ്യുക)
    
    function addStudent() {
        const cls = document.getElementById('stClass').value;
        const reg = document.getElementById('stRegNo').value;
        const name = document.getElementById('stName').value;
        if(!mData.students) mData.students = {};
        if(!mData.students[cls]) mData.students[cls] = {};
        mData.students[cls][reg] = name;
        refreshStudentDisplay();
    }

    function refreshStudentDisplay() {
        const area = document.getElementById('studentListArea'); area.innerHTML = "";
        for(let cls in mData.students) {
            let h = `<h4>${cls}</h4><table class="st-list-table">`;
            for(let reg in mData.students[cls]) {
                h += `<tr><td>${reg}</td><td>${mData.students[cls][reg]}</td></tr>`;
            }
            area.innerHTML += h + `</table>`;
        }
    }

    async function syncWithCloud() { 
        await db.collection("madrasa_data").doc(mData.info.phone).set(mData); 
        alert("Saved!"); 
    }

    async function publishResult() {
        if(confirm("പബ്ലിഷ് ചെയ്യട്ടെ? രക്ഷിതാക്കൾക്ക് റിസൾട്ട് കാണാം.")) {
            mData.isPublished = true;
            await syncWithCloud();
            alert("Published Successfully!");
        }
    }
    
    function copyLink() {
        const copyText = document.getElementById("photoUploadURL"); copyText.select();
        navigator.clipboard.writeText(copyText.value); alert("Link Copied!");
    }
</script>
</body>
</html>