<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Online Quiz Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #198754; --bg: #f4f7f6; --gold: #D4AF37; --white: #ffffff; --dark: #1a1a1a; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 450px; margin: auto; }
        .card { background: var(--white); border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* HD Poster Layout - Fixed for full capture */
        #downloadArea { 
            width: 1000px; 
            height: 1100px; 
            background: #fff; 
            position: absolute; 
            top: -5000px; /* സ്ക്രീനിൽ നിന്ന് വശത്തേക്ക് മാറ്റിവെച്ചു */
            left: 0;
            display: flex;
            flex-direction: column;
            border: 15px solid var(--dark);
        }

        .poster-top-header { background: var(--dark); padding: 50px 20px; text-align: center; border-bottom: 5px solid var(--gold); }
        .p-madrassa { color: #fff; font-size: 52px; font-weight: 700; margin: 0; letter-spacing: 2px; text-transform: uppercase; }
        .p-quiz-title { color: var(--gold); font-size: 38px; margin: 10px 0 0; font-weight: 600; letter-spacing: 5px; }

        .weekly-banner-hd { background: #333; padding: 25px; text-align: center; }
        .weekly-text { color: #fff; font-size: 35px; font-weight: 700; letter-spacing: 10px; margin: 0; }

        .poster-body { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; background: #fff; }
        .winner-img-hd { width: 420px; height: 420px; border-radius: 50%; border: 15px solid #fff; box-shadow: 0 15px 40px rgba(0,0,0,0.2); object-fit: cover; margin-bottom: 30px; }
        .winner-name-hd { font-size: 75px; color: var(--dark); font-weight: 800; margin: 0; text-transform: uppercase; }
        
        .info-group-hd { margin-top: 15px; text-align: center; width: 100%; }
        .id-badge-hd { font-size: 45px; color: #d32f2f; font-weight: 700; margin-bottom: 15px; }
        .stats-row-hd { font-size: 35px; color: #444; font-weight: 500; display: flex; justify-content: center; gap: 30px; border-top: 2px solid #eee; padding-top: 25px; width: 85%; margin: 10px auto; }
        .congrats-text-hd { margin-top: 45px; color: var(--gold); font-weight: 800; font-size: 60px; font-style: italic; }

        /* Preview Display (Mobile) */
        .preview-top { background: var(--dark); padding: 15px; color: #fff; text-align: center; }
        .preview-banner { background: #333; padding: 12px; color: var(--gold); text-align: center; font-weight: 800; letter-spacing: 3px; border-bottom: 2px solid var(--gold); }
        .preview-body { padding: 30px 20px; text-align: center; }
        .preview-img { width: 170px; height: 170px; border-radius: 50%; border: 5px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.1); object-fit: cover; }

        .download-btn { background: #007bff; color: white; padding: 16px; border-radius: 15px; border: none; width: calc(100% - 40px); margin: 0 20px 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; }
        .timer-box { background: #1a1a1a; color: white; padding: 25px; border-radius: 25px; margin: 20px; text-align: center; }
        .timer-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .t-val { font-size: 26px; font-weight: 700; color: var(--gold); display: block; }
        .t-lbl { font-size: 10px; opacity: 0.7; }

        .hidden { display: none; }
        .btn { width: 100%; padding: 18px; border-radius: 15px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; }
        .opt-btn { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #ddd; background: white; margin-bottom: 12px; font-weight: 600; cursor: pointer; }
        .opt-btn.selected { background: var(--primary) !important; color: white !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        
        <div id="winnerSection" class="hidden">
            <div id="downloadArea">
                <div class="poster-top-header">
                    <p class="p-madrassa">MISBAHUL ULOOM MADRASA</p>
                    <p class="p-quiz-title">ONLINE QUIZ - PERUVANA</p>
                </div>
                <div class="weekly-banner-hd">
                    <p class="weekly-text">WEEKLY WINNER</p>
                </div>
                <div class="poster-body">
                    <img id="wPhoto" class="winner-img-hd" src="" crossorigin="anonymous">
                    <p class="winner-name-hd" id="wName"></p>
                    <div class="info-group-hd">
                        <p class="id-badge-hd" id="wReg"></p>
                        <div class="stats-row-hd">
                            <span id="wClass"></span>
                            <span style="color:var(--gold)">|</span>
                            <span id="wMentor"></span>
                        </div>
                    </div>
                    <div class="congrats-text-hd">CONGRATULATIONS!</div>
                </div>
            </div>

            <div class="preview-top">
                <p style="margin:0; font-weight:700; font-size: 18px;">MISBAHUL ULOOM MADRASA PERUVANA</p>
                <p style="margin:0; font-size:12px; color:var(--gold); font-weight: 800;">RAMZAN SPECIAL ONLINE QUIZ</p>
            </div>
            <div class="preview-banner">WEEKLY WINNER</div>
            <div class="preview-body">
                <img id="wPhotoPreview" class="preview-img" src="">
                <h2 id="wNamePreview" style="margin:15px 0 8px; font-size: 28px; color: var(--dark);"></h2>
                <p id="wInfoPreview" style="color:#d32f2f; font-weight: 700; font-size:16px; margin:0;"></p>
                <p id="wSubInfoPreview" style="color:#666; font-size:14px; margin-top:5px;"></p>
            </div>

            <button class="download-btn" onclick="downloadPoster()"><i class="fa-solid fa-download"></i> Download Poster (HD)</button>
            
            <div class="timer-box">
                <p style="font-size:13px; opacity:0.9; margin:0; font-weight: 600;">Next Quiz Starts In:</p>
                <div class="timer-grid">
                    <div><span class="t-val" id="days">00</span><span class="t-lbl">DAYS</span></div>
                    <div><span class="t-val" id="hours">00</span><span class="t-lbl">HRS</span></div>
                    <div><span class="t-val" id="mins">00</span><span class="t-lbl">MINS</span></div>
                </div>
            </div>
        </div>

        <div id="quizSection" style="padding: 30px 20px;">
            <div style="text-align:center; margin-bottom: 30px;">
                <h1 style="color: var(--primary); margin:0; font-size:26px;">Online Quiz</h1>
                <p style="color: #666; font-size: 13px;">Misbahul Uloom Madrasa, Peruvana</p>
            </div>
            
            <div id="loginStep">
                <input type="text" id="regInput" placeholder="Enter Registration ID" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px; box-sizing:border-box;">
                <button class="btn" id="loginBtn" onclick="checkID()">Continue</button>
            </div>

            <div id="confirmStep" class="hidden" style="text-align:center;">
                <img id="sPhoto" style="width:150px; height:150px; border-radius:50%; border:5px solid #fff; box-shadow:0 10px 20px rgba(0,0,0,0.1); margin-bottom:15px; object-fit:cover;">
                <h3 id="sName" style="color:var(--dark); margin:0; font-size: 22px;"></h3>
                <p id="sInfo" style="color:#666; margin-bottom:25px; font-size: 15px;"></p>
                <button class="btn" onclick="showQuizArea()">Start Quiz Now</button>
            </div>

            <div id="questionStep" class="hidden">
                <h3 id="displayQ" style="line-height:1.6; margin-bottom:20px;"></h3>
                <div id="options"></div>
                <div id="submitArea" style="display:none; margin-top:20px;">
                    <button class="btn" id="finalSubmitBtn" onclick="finalSubmit()">Submit Answer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain:"misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId:"misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();
let userData = null;
let currentQuizID = "";
let selectedOption = null;

db.collection("quiz_config").doc("current").onSnapshot(async (doc) => {
    const quiz = doc.data();
    if(!quiz) return;
    currentQuizID = quiz.quizId || "1";
    if (quiz.status === "closed") {
        document.getElementById("quizSection").classList.add("hidden");
        document.getElementById("winnerSection").classList.remove("hidden");
        loadWinnerData(quiz.winnerId);
        startCountdown(quiz.nextDate);
    } else {
        document.getElementById("quizSection").classList.remove("hidden");
        document.getElementById("winnerSection").classList.add("hidden");
        document.getElementById("displayQ").innerText = quiz.question;
        renderOptions(quiz.options);
    }
});

function renderOptions(options) {
    let html = "";
    options.forEach(opt => { html += `<button class="opt-btn" onclick="selectOption(this, '${opt}')">${opt}</button>`; });
    document.getElementById("options").innerHTML = html;
}

function selectOption(btn, val) {
    document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedOption = val;
    document.getElementById("submitArea").style.display = "block";
}

async function checkID() {
    const id = document.getElementById("regInput").value.trim();
    if(!id) return;
    const btn = document.getElementById("loginBtn");
    btn.innerText = "Checking..."; btn.disabled = true;
    const resSnap = await db.collection("quiz_responses").where("regNo", "==", id).where("quizId", "==", currentQuizID).get();
    if(!resSnap.empty) { alert("Already participated!"); btn.innerText = "Continue"; btn.disabled = false; return; }
    const snap = await db.collection("students").where("number", "==", id).limit(1).get();
    if(snap.empty) { alert("ID Error!"); btn.innerText = "Continue"; btn.disabled = false; return; }
    userData = snap.docs[0].data();
    document.getElementById("loginStep").classList.add("hidden");
    document.getElementById("confirmStep").classList.remove("hidden");
    document.getElementById("sPhoto").src = userData.photo;
    document.getElementById("sName").innerText = userData.name;
    document.getElementById("sInfo").innerText = `Class: ${userData.class} | Mentor: ${userData.mentor}`;
}

function showQuizArea() {
    document.getElementById("confirmStep").classList.add("hidden");
    document.getElementById("questionStep").classList.remove("hidden");
}

async function finalSubmit() {
    if(!selectedOption) return;
    const sBtn = document.getElementById("finalSubmitBtn");
    sBtn.innerText = "Submitting..."; sBtn.disabled = true;
    try {
        await db.collection("quiz_responses").add({
            name: userData.name, regNo: userData.number, mentor: userData.mentor,
            photo: userData.photo, answer: selectedOption, quizId: currentQuizID,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Submitted!"); location.reload();
    } catch(e) { alert("Error!"); sBtn.innerText = "Submit Answer"; sBtn.disabled = false; }
}

async function loadWinnerData(wID) {
    if(!wID) return;
    const sSnap = await db.collection("students").where("number", "==", wID).limit(1).get();
    if(!sSnap.empty) {
        const w = sSnap.docs[0].data();
        document.getElementById("wPhotoPreview").src = w.photo;
        document.getElementById("wNamePreview").innerText = w.name;
        document.getElementById("wInfoPreview").innerText = `ID: ${w.number}`;
        document.getElementById("wSubInfoPreview").innerText = `Class: ${w.class} | Mentor: ${w.mentor}`;
        
        document.getElementById("wPhoto").src = w.photo;
        document.getElementById("wName").innerText = w.name;
        document.getElementById("wReg").innerText = "ID: " + w.number;
        document.getElementById("wClass").innerText = "Class: " + w.class;
        document.getElementById("wMentor").innerText = "Mentor: " + w.mentor;
    }
}

// FULL CAPTURE DOWNLOAD FUNCTION
function downloadPoster() {
    const area = document.getElementById('downloadArea');
    const dbBtn = document.querySelector('.download-btn');
    dbBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Preparing Poster...';
    
    // പോസ്റ്റർ ഏരിയ സ്ക്രോൾ പൊസിഷൻ ബാധിക്കാതെ ക്യാപ്‌ചർ ചെയ്യാൻ താഴെ പറയുന്ന ഓപ്ഷനുകൾ നൽകുന്നു
    html2canvas(area, { 
        useCORS: true, 
        backgroundColor: "#ffffff",
        scale: 2, // HD ക്വാളിറ്റിക്ക്
        logging: false,
        allowTaint: true,
        scrollX: 0,
        scrollY: -window.scrollY, // സ്ക്രോൾ വാല്യൂ അഡ്ജസ്റ്റ്മെന്റ്
        windowWidth: 1000,
        windowHeight: 1100
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Weekly_Winner_${document.getElementById('wName').innerText}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        dbBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download Poster (HD)';
    }).catch(err => {
        console.error(err);
        alert("Download Failed! Try again.");
        dbBtn.innerHTML = '<i class="fa-solid fa-download"></i> Download Poster (HD)';
    });
}

function startCountdown(endTime) {
    const destination = new Date(endTime).getTime();
    setInterval(() => {
        const diff = destination - new Date().getTime();
        if (diff <= 0) return;
        document.getElementById("days").innerText = Math.floor(diff / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
        document.getElementById("hours").innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
        document.getElementById("mins").innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
    }, 1000);
}
</script>
</body>
</html>