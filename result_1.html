<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Portal - Entry</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --p: #004d40; --bg: #f5f5f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding: 10px; }
        .box { max-width: 600px; margin: auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .hidden { display: none; }
        .info-tab { background: #e0f2f1; padding: 15px; border-radius: 8px; border-left: 5px solid var(--p); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="box" id="authBox">
    <h2 id="authTitle" style="text-align:center; color:var(--p)">Madrasa Login</h2>
    <div id="regFields">
        <input type="text" id="mName" placeholder="മദ്രസയുടെ പേര്">
        <input type="text" id="mPlace" placeholder="സ്ഥലം">
        <input type="text" id="sadrName" placeholder="സദർ മുഅല്ലിം">
    </div>
    <input type="number" id="mPhone" placeholder="മൊബൈൽ നമ്പർ">
    <button onclick="authAction()" id="actionBtn">രജിസ്റ്റർ ചെയ്യുക</button>
    <p style="text-align:center; cursor:pointer; color:blue;" onclick="toggleAuth()" id="toggleMsg">അക്കൗണ്ട് ഉണ്ടോ? ലോഗിൻ ചെയ്യുക</p>
</div>

<div class="box hidden" id="dashBox" style="max-width: 800px;">
    <div class="info-tab">
        <h2 id="dispName" style="margin:0"></h2>
        <p id="dispPlace" style="margin:5px 0"></p>
        <div id="statMsg" style="font-weight:bold; margin-top:10px; color:orange;"></div>
    </div>

    <div id="entryArea">
        <div class="grid">
            <select id="cls" onchange="resetEntry()">
                <option value="">ക്ലാസ് തിരഞ്ഞെടുക്കുക</option>
                <option value="1">Class 1</option><option value="4">Class 4</option>
                <option value="7">Class 7</option><option value="10">Class 10</option>
            </select>
            <input type="number" id="totAtt" placeholder="Total Attendance">
        </div>
        
        <div style="display:flex; gap:5px;">
            <input type="text" id="subInp" placeholder="വിഷയം ചേർക്കുക (FIQH)">
            <button style="width:auto" onclick="addSub()">ADD</button>
        </div>
        <div id="subTags" style="margin:5px 0; color:#555"></div>

        <div id="studInput" class="hidden">
            <input type="text" id="sName" placeholder="വിദ്യാർത്ഥിയുടെ പേര്">
            <div id="mFields" class="grid"></div>
            <input type="number" id="sAtt" placeholder="പ്രസന്റ് ഹാജർ (Present Attendance)">
            <button onclick="addStud()" style="background:#2e7d32">വിദ്യാർത്ഥിയെ ചേർക്കുക</button>
        </div>
    </div>
    <button id="pubBtn" onclick="sendToPub()" style="background:#ef6c00; margin-top:20px;">PUBLISH REQUEST</button>
    <button onclick="location.reload()" style="background:#666">Logout</button>
</div>

<script>
const firebaseConfig = { databaseURL: "https://madrasa-result-829d0-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let isLogin = false; let currentID = ""; let setup = { subjects: {}, students: {}, totAtt: 0 };

function toggleAuth() {
    isLogin = !isLogin;
    document.getElementById('regFields').classList.toggle('hidden', isLogin);
    document.getElementById('authTitle').innerText = isLogin ? "Madrasa Login" : "Madrasa Registration";
    document.getElementById('actionBtn').innerText = isLogin ? "Login" : "Register Now";
    document.getElementById('toggleMsg').innerText = isLogin ? "പുതിയ അക്കൗണ്ട് വേണോ? രജിസ്റ്റർ ചെയ്യുക" : "അക്കൗണ്ട് ഉണ്ടോ? ലോഗിൻ ചെയ്യുക";
}

function authAction() {
    const ph = document.getElementById('mPhone').value;
    if(!ph) return alert("ഫോൺ നമ്പർ നൽകുക");

    if(!isLogin) {
        db.ref('madrassas/'+ph).once('value', s => {
            if(s.exists()) return alert("ഈ നമ്പർ നിലവിലുണ്ട്!");
            db.ref('madrassas/'+ph).set({
                mName: document.getElementById('mName').value,
                mPlace: document.getElementById('mPlace').value,
                sadr: document.getElementById('sadrName').value,
                phone: ph, regStat: "pending", pubStat: "none", active: true
            }).then(() => { alert("രജിസ്റ്റർ ചെയ്തു! അപ്രൂവലിനായി കാത്തിരിക്കുക."); toggleAuth(); });
        });
    } else {
        db.ref('madrassas/'+ph).once('value', s => {
            const m = s.val();
            if(!m) return alert("രജിസ്റ്റർ ചെയ്തിട്ടില്ല!");
            if(m.regStat !== "approved") return alert("അപ്രൂവൽ ലഭിച്ചിട്ടില്ല!");
            if(!m.active) return alert("ഈ അക്കൗണ്ട് തടഞ്ഞുവച്ചിരിക്കുകയാണ്!");
            currentID = ph;
            loadDash(m);
        });
    }
}

function loadDash(m) {
    document.getElementById('authBox').classList.add('hidden');
    document.getElementById('dashBox').classList.remove('hidden');
    document.getElementById('dispName').innerText = m.mName;
    document.getElementById('dispPlace').innerText = m.mPlace;
    checkPub(m);
}

function checkPub(m) {
    const msg = document.getElementById('statMsg');
    if(m.pubStat === "pending") {
        msg.innerText = "പബ്ലിഷ് ചെയ്യാനുള്ള അപേക്ഷ പരിഗണനയിലാണ്...";
        document.getElementById('entryArea').classList.add('hidden');
    } else if(m.pubStat === "live") {
        msg.style.color = "green";
        msg.innerText = "ലിങ്ക് ആക്ടീവ് ആണ്!";
        document.getElementById('entryArea').classList.add('hidden');
    }
}

function addSub() {
    let c = document.getElementById('cls').value;
    let s = document.getElementById('subInp').value.toUpperCase().trim();
    if(!c || !s) return;
    if(!setup.subjects[c]) setup.subjects[c] = [];
    setup.subjects[c].push(s);
    document.getElementById('subInp').value = "";
    resetEntry();
}

function resetEntry() {
    let c = document.getElementById('cls').value;
    let tags = document.getElementById('subTags');
    let f = document.getElementById('mFields');
    tags.innerHTML = ""; f.innerHTML = "";
    if(c && setup.subjects[c]) {
        document.getElementById('studInput').classList.remove('hidden');
        setup.subjects[c].forEach(s => {
            tags.innerHTML += ` [${s}] `;
            f.innerHTML += `<input type="number" class="mv" data-s="${s}" placeholder="${s} Mark">`;
        });
    }
}

function addStud() {
    let c = document.getElementById('cls').value;
    let n = document.getElementById('sName').value;
    let marks = {}; let fail = false;
    document.querySelectorAll('.mv').forEach(i => {
        let v = parseInt(i.value) || 0;
        marks[i.dataset.s] = v;
        if(v < 17) fail = true;
    });
    if(!setup.students[c]) setup.students[c] = [];
    setup.students[c].push({ name: n, marks: marks, pAtt: document.getElementById('sAtt').value, res: fail?'FAIL':'PASS' });
    alert(n + " ചേർത്തു!");
}

function sendToPub() {
    setup.totAtt = document.getElementById('totAtt').value;
    db.ref('madrassas/'+currentID).update({ pubStat: "pending", data: setup })
    .then(() => { alert("സബ്മിറ്റ് ചെയ്തു!"); location.reload(); });
}
</script>
</body>
</html>