<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSSF SAMASTHA QUIZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #D4AF37; --bg: #f8f9fa; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; }
        .header { background: linear-gradient(135deg, #004d00, #007d00); color: white; text-align: center; padding: 40px 20px; border-radius: 0 0 40px 40px; }
        .container { max-width: 500px; margin: -30px auto 50px; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--gold); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: var(--primary); margin-top: 10px; transition: 0.3s; }
        .btn:disabled { background: #ccc; }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1.5px solid #ddd; border-radius: 12px; box-sizing: border-box; }
        #countdown { font-size: 35px; font-weight: 800; color: #d32f2f; text-align: center; margin: 20px 0; }
        .q-box { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        #poster-zone { display: none; text-align: center; margin-top: 20px; border: 2px solid var(--gold); padding: 20px; border-radius: 15px; background: #fffdf0; }
        canvas { width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        footer { text-align: center; padding: 20px; font-size: 13px; color: #444; border-top: 1px solid #eee; margin-top: 20px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0; font-size:24px;">SAMASTHA QUIZ PROGRAM</h1>
    <p style="color:var(--gold); margin:5px 0; font-weight:bold;">SKSSF CHAPPARAPPADAV ZONE</p>
</div>

<div class="container">
    <div id="authPanel">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn" onclick="showTab('reg')">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº</button>
            <button class="btn" style="background:#444;" onclick="showTab('log')">‡¥≤‡µã‡¥ó‡¥ø‡µª</button>
        </div>
        
        <div id="regPart">
            <input type="text" id="regName" placeholder="‡¥™‡µá‡¥∞‡µç">
            <input type="number" id="regMobile" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
            <select id="regBranch">
                <option value="">‡¥∂‡¥æ‡¥ñ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>
                <option>KARUVANCHAL</option><option>VILAKKANNOOR</option><option>CHAPPARAPPADAV</option>
                <option>NADUVIL</option><option>PADAPPENGAD</option><option>PERUVANA</option>
                <option>ELAMBERAM PARA</option><option>ERUVATTI</option><option>NHANDUMBALAM</option>
                <option>PERUMALABAD</option><option>MANGARA BADARIYYA</option><option>THADIKKADAV</option>
                <option>SHANTHIGIRI</option><option>NEDUVOODE</option>
            </select>
            <button class="btn" id="regBtn" onclick="handleRegister()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
            <div id="regNumBox" style="display:none; text-align:center; padding:15px; background:#fff9c4; margin-top:15px; border-radius:12px; border: 2px dashed var(--gold);">
                ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥®‡¥Æ‡µç‡¥™‡µº: <h2 id="displayRegNum" style="margin:5px 0; color:#d32f2f; font-size: 40px;"></h2>
                <p style="font-size: 12px; color: #555;">‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥à ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</p>
            </div>
        </div>

        <div id="logPart" style="display:none;">
            <input type="number" id="logId" placeholder="‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï">
            <button class="btn" onclick="handleLogin()">‡¥™‡µç‡¥∞‡¥µ‡µá‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï (Login)</button>
        </div>
    </div>

    <div id="quizView" style="display:none;">
        <div id="userInfo" style="background:#e8f5e9; padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; font-weight:bold; border: 1px solid #c8e6c9;"></div>
        
        <div id="timerDisplay">
            <p style="text-align:center; font-weight:bold; color: #666;">‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥æ‡µª ‡¥á‡¥®‡¥ø:</p>
            <div id="countdown">00:00:00</div>
        </div>

        <div id="quizArea" style="display:none;">
            <div id="questionList"></div>
            <button class="btn" id="submitBtn" onclick="submitQuiz()">‡¥∏‡¥¨‡µç‡¥Æ‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
        </div>

        <div id="poster-zone">
            <h3 style="color:#004d00; font-size: 24px;">‡¥Ö‡¥≠‡¥ø‡¥®‡¥®‡µç‡¥¶‡¥®‡¥ô‡µç‡¥ô‡µæ! üéâ</h3>
            <p style="font-weight: bold;">‡¥§‡¥æ‡¥ô‡µç‡¥ï‡µæ ‡¥à ‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥§‡µç‡¥§‡¥ø‡¥≤‡µÜ ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥Ø‡¥æ‡¥£‡µç.</p>
            <canvas id="winnerCanvas" width="1000" height="1200"></canvas>
            <button class="btn" style="background: #D4AF37; color: black; font-size: 18px;" onclick="downloadPoster()">
                <i class="fa fa-download"></i> POSTER ‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
            </button>
        </div>

        <div id="endMessage" style="display:none; text-align:center; padding:30px;">
            <i class="fa fa-clock-o" style="font-size: 50px; color: #ccc; margin-bottom: 15px;"></i>
            <h3 id="endTitle">‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ!</h3>
            <p id="endDesc">‡¥´‡¥≤‡¥ô‡µç‡¥ô‡µæ‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</p>
        </div>
    </div>
</div>

<footer><b>Developed By: MUHSIN MANNANI</b></footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o",
  authDomain: "skssf-quiz.firebaseapp.com",
  projectId: "skssf-quiz",
  storageBucket: "skssf-quiz.firebasestorage.app",
  messagingSenderId: "999161549501",
  appId: "1:999161549501:web:7be9c98c287b92881a5dd4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;

function showTab(t) {
    document.getElementById('regPart').style.display = (t==='reg')?'block':'none';
    document.getElementById('logPart').style.display = (t==='log')?'block':'none';
}

async function handleRegister() {
    const name = document.getElementById('regName').value.trim();
    const mob = document.getElementById('regMobile').value.trim();
    const branch = document.getElementById('regBranch').value;
    if(!name || !mob || !branch) return alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");

    const btn = document.getElementById('regBtn');
    btn.disabled = true;

    // Mobile Check
    const mobCheck = await db.collection("participants").where("mobile", "==", mob).get();
    if(!mobCheck.empty) {
        alert("‡¥à ‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µÜ ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥§‡¥æ‡¥£‡µç!");
        btn.disabled = false;
        return;
    }

    const snap = await db.collection("participants").get();
    let nextId = 101;
    if(!snap.empty) {
        let ids = snap.docs.map(d => parseInt(d.id));
        nextId = Math.max(...ids) + 1;
    }

    await db.collection("participants").doc(nextId.toString()).set({ name, mobile: mob, branch, regId: nextId });
    document.getElementById('displayRegNum').innerText = nextId;
    document.getElementById('regNumBox').style.display = 'block';
    btn.style.display = 'none';
}

async function handleLogin() {
    const id = document.getElementById('logId').value.trim();
    if(!id) return alert("‡¥ê‡¥°‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
    
    const doc = await db.collection("participants").doc(id).get();
    if(!doc.exists) return alert("‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥Ø ‡¥ê‡¥°‡¥ø!");

    // Check if already submitted
    const resCheck = await db.collection("results").doc(id).get();
    if(resCheck.exists) {
        alert("‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥à ‡¥ê‡¥°‡¥ø ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‡¥™‡µÇ‡µº‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡¥§‡¥æ‡¥£‡µç. ‡¥á‡¥®‡¥ø ‡¥™‡¥ô‡µç‡¥ï‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥∏‡¥æ‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡¥ø‡¥≤‡µç‡¥≤!");
        return;
    }

    currentUser = doc.data();
    document.getElementById('authPanel').style.display = 'none';
    document.getElementById('quizView').style.display = 'block';
    document.getElementById('userInfo').innerText = `‡¥∏‡µç‡¥µ‡¥æ‡¥ó‡¥§‡¥Ç: ${currentUser.name} | ‡¥∂‡¥æ‡¥ñ: ${currentUser.branch}`;

    db.collection("quiz_settings").doc("status").onSnapshot(d => {
        const s = d.data();
        if(s.closed) {
            checkWinnerStatus();
        } else {
            runTimer(s.startTime, s.published);
        }
    });
}

function runTimer(startTime, published) {
    const target = new Date(startTime).getTime();
    const timer = setInterval(() => {
        const now = new Date().getTime();
        const dist = target - now;
        if(dist <= 0) {
            clearInterval(timer);
            document.getElementById('timerDisplay').style.display = 'none';
            if(published) {
                document.getElementById('quizArea').style.display = 'block';
                loadQuestions();
            } else {
                document.getElementById('endMessage').style.display = 'block';
                document.getElementById('endTitle').innerText = "‡¥§‡¥Ø‡µç‡¥Ø‡¥æ‡¥±‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï...";
                document.getElementById('endDesc').innerText = "‡¥Ö‡¥°‡µç‡¥Æ‡¥ø‡µª ‡¥™‡¥¨‡µç‡¥≤‡¥ø‡¥∑‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§ ‡¥∂‡µá‡¥∑‡¥Ç ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡¥æ‡¥£‡¥æ‡¥Ç.";
            }
        } else {
            const h = Math.floor(dist/(1000*60*60));
            const m = Math.floor((dist%(1000*60*60))/(1000*60));
            const s = Math.floor((dist%(1000*60))/1000);
            document.getElementById('countdown').innerHTML = `${h}:${m}:${s}`;
        }
    }, 1000);
}

async function loadQuestions() {
    const snap = await db.collection("questions").get();
    let h = "";
    snap.forEach(doc => {
        const q = doc.data();
        h += `<div class="q-box"><p style="font-weight:bold; margin-top:0;">${q.text}</p>
        ${q.options.map((o,i) => `<label style="display:block; margin:8px 0; cursor:pointer;"><input type="radio" name="q_${doc.id}" value="${i}"> ${o}</label>`).join('')}
        </div>`;
    });
    document.getElementById('questionList').innerHTML = h;
}

async function submitQuiz() {
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "‡¥Ö‡¥Ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...";

    let ans = {};
    const boxes = document.querySelectorAll('.q-box');
    boxes.forEach(box => {
        const sel = box.querySelector('input:checked');
        const qid = box.querySelector('input').name.split('_')[1];
        ans[qid] = sel ? sel.value : null;
    });

    await db.collection("results").doc(currentUser.regId.toString()).set({ 
        ...currentUser, 
        answers: ans, 
        submitTime: firebase.firestore.FieldValue.serverTimestamp() 
    });
    
    alert("‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥â‡¥§‡µç‡¥§‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥∏‡¥¨‡µç‡¥Æ‡¥ø‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
    location.reload();
}

async function checkWinnerStatus() {
    document.getElementById('timerDisplay').style.display = 'none';
    document.getElementById('quizArea').style.display = 'none';
    
    const winDoc = await db.collection("winners").doc("list").get();
    if(winDoc.exists) {
        const winners = winDoc.data().winnerIds || [];
        if(winners.includes(currentUser.regId.toString())) {
            showWinnerPoster();
        } else {
            document.getElementById('endMessage').style.display = 'block';
            document.getElementById('endTitle').innerText = "‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥ø‡¥ö‡µç‡¥ö‡µÅ";
            document.getElementById('endDesc').innerText = "‡¥Æ‡¥±‡µç‡¥±‡µä‡¥∞‡µÅ ‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥ï‡¥æ‡¥£‡¥æ‡¥Ç.";
        }
    } else {
        document.getElementById('endMessage').style.display = 'block';
    }
}

function showWinnerPoster() {
    document.getElementById('poster-zone').style.display = 'block';
    const canvas = document.getElementById('winnerCanvas');
    const ctx = canvas.getContext('2d');
    
    // Gradient Background
    let grad = ctx.createLinearGradient(0,0,0,1200);
    grad.addColorStop(0, "#002b00");
    grad.addColorStop(1, "#004d00");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,1000,1200);
    
    // Golden Frame
    ctx.strokeStyle = "#D4AF37";
    ctx.lineWidth = 25;
    ctx.strokeRect(50,50,900,1100);
    
    // Header
    ctx.fillStyle = "#D4AF37";
    ctx.font = "bold 35px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SKSSF CHAPPARAPPADAV ZONE", 500, 150);
    
    ctx.fillStyle = "white";
    ctx.font = "bold 75px Arial";
    ctx.fillText("SAMASTHA QUIZ", 500, 260);
    
    // Congratulation Text
    ctx.fillStyle = "#D4AF37";
    ctx.font = "italic 45px Arial";
    ctx.fillText("CONGRATULATIONS", 500, 420);
    
    // Winner Name
    ctx.fillStyle = "white";
    ctx.font = "bold 90px Arial";
    ctx.fillText(currentUser.name.toUpperCase(), 500, 580);
    
    // Branch
    ctx.font = "50px Arial";
    ctx.fillText("BRANCH: " + currentUser.branch.toUpperCase(), 500, 680);
    
    // Badge
    ctx.fillStyle = "#D4AF37";
    ctx.beginPath();
    ctx.arc(500, 880, 120, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = "#004d00";
    ctx.font = "bold 50px Arial";
    ctx.fillText("WINNER", 500, 895);
    
    // Footer
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.font = "20px Arial";
    ctx.fillText("Technical Support: Muhsin Mannani", 500, 1150);
}

function downloadPoster() {
    const link = document.createElement('a');
    link.download = `Winner_${currentUser.name}.png`;
    link.href = document.getElementById('winnerCanvas').toDataURL("image/png", 1.0);
    link.click();
}
</script>
</body>
</html>