<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKSSF ADMIN - MASTER</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --red: #c0392b; --blue: #2980b9; --green: #27ae60; }
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .card { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; border-top: 5px solid var(--primary); }
        h3 { color: var(--primary); display: flex; align-items: center; gap: 8px; margin: 0 0 12px; font-size: 15px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        
        .btn { padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; width: 100%; transition: 0.1s; box-shadow: 0 4px #777; text-transform: uppercase; }
        .btn:active { box-shadow: 0 0 #666; transform: translateY(3px); }
        .btn-blue { background: var(--blue); } .btn-green { background: var(--green); } .btn-red { background: var(--red); } .btn-gold { background: var(--gold); color: #000; }
        .selected-rank { border: 3px solid var(--gold) !important; box-shadow: 0 0 12px var(--gold) !important; transform: scale(1.02); }

        input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 8px; box-sizing: border-box; }
        .scroll-table { overflow-x: auto; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; background: white; }
        th { background: var(--primary); color: white; padding: 10px; text-align: left; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 11px; }
    </style>
</head>
<body>

<div class="card">
    <h3><i class="fa fa-clock"></i> QUIZ START TIME</h3>
    <p style="font-size:11px; color:#666;">ടൈമർ സെറ്റ് ചെയ്യുക (ഇതനുസരിച്ചേ ലോഗിൻ വരൂ)</p>
    <input type="datetime-local" id="startTimeInput">
    <button class="btn btn-blue" onclick="saveTime()">SAVE TIME</button>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top:10px;">
        <button class="btn btn-red" onclick="setStatus(true)">STOP QUIZ</button>
        <button class="btn btn-gold" id="posterBtn" onclick="togglePosters()">POSTERS</button>
    </div>
</div>

<div class="card">
    <h3><i class="fa fa-trophy"></i> RANK LIST & SELECTION</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
        <button class="btn btn-gold" id="rBtn1" onclick="setActiveRank(1)">1st PRIZE</button>
        <button class="btn btn-gold" id="rBtn2" onclick="setActiveRank(2)">2nd PRIZE</button>
        <button class="btn btn-gold" id="rBtn3" onclick="setActiveRank(3)">3rd PRIZE</button>
    </div>
    <div class="scroll-table">
        <table>
            <thead><tr><th>#ID</th><th>Name</th><th>Score</th><th>Time</th><th>Select</th></tr></thead>
            <tbody id="resTable"></tbody>
        </table>
    </div>
    <button class="btn btn-green" style="margin-top:12px;" onclick="publishWinners()">PUBLISH WINNERS</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let activeRank = null; let pendingWinners = {}; let correctAnswers = {};

function saveTime() { 
    const t = document.getElementById('startTimeInput').value;
    if(!t) return alert("Select Time!");
    db.collection("quiz_settings").doc("status").update({ startTime: t, closed: false }); 
    alert("Time Updated!"); 
}

function setStatus(isClosed) { 
    db.collection("quiz_settings").doc("status").update({ closed: isClosed }); 
    alert(isClosed ? "Quiz Stopped!" : "Quiz Live!"); 
}

async function togglePosters() {
    const s = await db.collection("quiz_settings").doc("status").get();
    db.collection("quiz_settings").doc("status").update({ showPosters: !s.data().showPosters });
}

// Get Correct Answers
db.collection("questions").onSnapshot(snap => {
    snap.forEach(doc => correctAnswers[doc.id] = doc.data().correct);
});

// Rank List with ID
db.collection("results").orderBy("time", "asc").onSnapshot(snap => {
    let h = "";
    snap.forEach(doc => {
        const d = doc.data();
        let sc = 0;
        if(d.answers) for(let k in d.answers) if(d.answers[k] == correctAnswers[k]) sc++;
        h += `<tr>
            <td>#${d.regId}</td>
            <td>${d.name}</td>
            <td><b>${sc}</b></td>
            <td>${d.time ? d.time.toDate().toLocaleTimeString() : '-'}</td>
            <td><button class="btn btn-gold" onclick="selectWin('${d.regId}','${d.name}')" style="box-shadow:none; padding:5px;">WIN</button></td>
        </tr>`;
    });
    document.getElementById('resTable').innerHTML = h;
});

function setActiveRank(r) {
    activeRank = r;
    document.querySelectorAll('.btn-gold').forEach(b => b.classList.remove('selected-rank'));
    document.getElementById('rBtn'+r).classList.add('selected-rank');
}

function selectWin(id, name) {
    if(!activeRank) return alert("Select Prize Rank First!");
    pendingWinners[activeRank] = id;
    alert(`${name} (#${id}) Selected for ${activeRank} Rank`);
}

async function publishWinners() {
    if(!pendingWinners[1] || !pendingWinners[2] || !pendingWinners[3]) return alert("Select All 3 Winners!");
    await db.collection("winners").doc("list").set({ ranks: pendingWinners });
    await db.collection("quiz_settings").doc("status").update({ showPosters: true });
    alert("Winners Published Successfully!");
}
</script>
</body>
</html>