<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMASTHA ONLINE QUIZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --white: #ffffff; --green: #27ae60; --red: #c0392b; --dark: #002b00; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; padding: 0; color: #333; }
        
        /* Header & Dynamic Timer */
        .header { background: linear-gradient(135deg, #004d00, #002b00); color: white; text-align: center; padding: 45px 20px; border-radius: 0 0 40px 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        .status-label { display: inline-block; margin-top: 10px; padding: 6px 16px; background: rgba(255,255,255,0.1); border-radius: 20px; color: var(--gold); font-size: 13px; border: 1px solid var(--gold); font-weight: 600; }

        .container { max-width: 450px; margin: -30px auto 30px; padding: 0 20px; }
        .card { background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; border-top: 5px solid var(--gold); }
        
        /* Tabs */
        .tab-head { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: 700; cursor: pointer; color: #777; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); background: white; border-bottom: 3px solid var(--primary); }
        .content { padding: 25px; display: none; }
        .content.active { display: block; }

        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #eee; box-sizing: border-box; font-size: 14px; outline: none; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-gold { background: var(--gold); color: black; }

        /* Registration Success Poster */
        #regPoster { text-align: center; background: white; padding: 10px; border-radius: 20px; }
        .poster-badge { background: var(--primary); color: var(--gold); padding: 15px; border-radius: 15px; font-size: 32px; font-weight: 800; margin: 15px 0; border: 2px solid var(--gold); display: block; }

        /* Confirmation Box */
        .confirm-box { text-align: center; padding: 20px; background: #fff8e1; border-radius: 15px; border: 1px dashed var(--primary); margin-bottom: 20px; }

        /* Branch Stats Grid */
        .stats-card { background: white; border-radius: 20px; padding: 20px; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stats-title { font-size: 14px; font-weight: 800; color: var(--primary); margin-bottom: 15px; text-align: center; }
        .branch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .branch-item { background: #f9f9f9; padding: 8px; border-radius: 8px; font-size: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .branch-count { background: var(--gold); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        /* Quiz UI */
        .q-card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .opt-btn { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 10px; text-align: left; background: #fafafa; cursor: pointer; }
        .opt-btn.selected { background: var(--green) !important; color: white !important; font-weight: bold; border-color: var(--green); }

        /* Help Desk & Executive Footer */
        .help-desk { background: #fff; border-radius: 20px; padding: 20px; margin-top: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .help-title { font-size: 13px; font-weight: 700; color: #555; margin-bottom: 10px; }
        .contact-box { display: flex; justify-content: center; gap: 20px; }
        .contact-link { text-decoration: none; font-size: 13px; font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 5px; }
        .whatsapp { color: #25D366; } .call { color: #007AFF; }

        .dev-footer { text-align: center; padding: 30px 10px; color: #888; font-size: 11px; line-height: 1.6; }
        .dev-name { color: var(--dark); font-weight: 800; font-size: 12px; text-transform: uppercase; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="mainTitle">SAMASTHA ONLINE QUIZ</h1>
    <div class="status-label" id="timerDisplay">സിസ്റ്റം ലോഡ് ചെയ്യുന്നു...</div>
</div>

<div class="container">
    <div id="authArea">
        <div class="card">
            <div class="tab-head" id="tabHeader">
                <button class="tab-btn active" onclick="showTab('login')">LOGIN</button>
                <button class="tab-btn" onclick="showTab('register')">REGISTER</button>
            </div>

            <div id="loginTab" class="content active">
                <input type="number" id="loginId" placeholder="Enter Registration ID">
                <button class="btn btn-primary" onclick="checkLogin()">CONTINUE</button>
            </div>

            <div id="registerTab" class="content">
                <input type="text" id="regName" placeholder="Full Name">
                <input type="number" id="regMob" placeholder="Mobile Number">
                <select id="regBranch">
                    <option value="">Select Your Branch</option>
                    <option value="KARUVANCHAL">KARUVANCHAL</option>
                    <option value="VILAKKANNOOR">VILAKKANNOOR</option>
                    <option value="CHAPPARAPPADAV">CHAPPARAPPADAV</option>
                    <option value="NADUVIL">NADUVIL</option>
                    <option value="PADAPPENGAD">PADAPPENGAD</option>
                    <option value="PERUVANA">PERUVANA</option>
                    <option value="ELAMBERAM PARA">ELAMBERAM PARA</option>
                    <option value="ERUVATTI">ERUVATTI</option>
                    <option value="NHANDUMBALAM">NHANDUMBALAM</option>
                    <option value="PERUMALABAD">PERUMALABAD</option>
                    <option value="MANGARA BADARIYYA">MANGARA BADARIYYA</option>
                    <option value="THADIKKADAV">THADIKKADAV</option>
                    <option value="SHANTHIGIRI">SHANTHIGIRI</option>
                    <option value="NEDUVOODE">NEDUVOODE</option>
                </select>
                <button class="btn btn-primary" onclick="handleRegister()">REGISTER NOW</button>
            </div>

            <div id="posterTab" class="content">
                <div id="regPoster">
                    <h3 style="color:var(--primary); margin:0;">REGISTRATION SUCCESS!</h3>
                    <p style="font-size:14px; margin:10px 0;">Name: <b id="pName"></b><br>Branch: <b id="pBranch"></b></p>
                    <div class="poster-badge" id="pId"></div>
                    <button class="btn btn-primary" onclick="showTab('login')">GO TO LOGIN</button>
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-title">പങ്കാളിത്ത ശാഖകൾ (Registrations)</div>
            <div class="branch-grid" id="branchStats"></div>
        </div>
    </div>

    <div id="confirmArea" class="hidden">
        <div class="card" style="padding:25px; text-align:center;">
            <h3 style="color:var(--primary);">Confirm Your Identity</h3>
            <div class="confirm-box">
                <p style="margin:0; font-size:13px;">നിങ്ങൾ തന്നെയാണോ?</p>
                <h2 style="margin:5px 0; color:var(--red);" id="confirmName"></h2>
                <div style="font-size:13px; color:#555;" id="confirmBranch"></div>
            </div>
            <button class="btn btn-primary" onclick="startQuizNow()">YES, START QUIZ</button>
            <button class="btn" style="margin-top:10px; background:#eee;" onclick="location.reload()">NO, LOGOUT</button>
        </div>
    </div>

    <div id="quizArea" class="hidden">
        <div id="questionList"></div>
        <button class="btn btn-gold" onclick="submitFinal()">CONFIRM & SUBMIT</button>
    </div>

    <div id="finalArea" class="hidden">
        <div class="card" style="padding:40px 20px; text-align:center;">
            <i class="fa fa-check-circle fa-4x" style="color:var(--green); margin-bottom:15px;"></i>
            <h2 style="color:var(--primary); margin:0;">പങ്കെടുത്തതിന് നന്ദി!</h2>
            <p style="color:#555; font-size:14px;">നിങ്ങളുടെ ഉത്തരങ്ങൾ റെക്കോർഡ് ചെയ്തു. ഫലങ്ങൾക്കായി കാത്തിരിക്കുക.</p>
            <div style="margin-top:20px; font-weight:800; color:var(--primary); border-top:1px solid #eee; padding-top:15px;">SKSSF ചപ്പാരപ്പടവ് മേഖല</div>
            <button class="btn btn-primary" style="margin-top:20px; background:#f5f5f5; color:#333;" onclick="location.reload()">HOME</button>
        </div>
    </div>

    <div class="help-desk">
        <div class="help-title">മേഖല കമ്മിറ്റി ഹെൽപ്പ് ഡെസ്ക്</div>
        <div class="contact-box">
            <a href="https://wa.me/7559950633" class="contact-link"><i class="fab fa-whatsapp whatsapp"></i> WhatsApp</a>
            <a href="tel:+7559950633" class="contact-link"><i class="fa fa-phone call"></i> Call Now</a>
        </div>
    </div>

    <div class="dev-footer">
        System Designed & Developed by<br>
        <span class="dev-name">Muhsin Mannani</span><br>
        Contact: +91 7559950633
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let userData = null; let userAnswers = {}; let sys = {};
const branches = ["KARUVANCHAL", "VILAKKANNOOR", "CHAPPARAPPADAV", "NADUVIL", "PADAPPENGAD", "PERUVANA", "ELAMBERAM PARA", "ERUVATTI", "NHANDUMBALAM", "PERUMALABAD", "MANGARA BADARIYYA", "THADIKKADAV", "SHANTHIGIRI", "NEDUVOODE"];

// 1. WATCH STATUS & TIMER
db.collection("quiz_settings").doc("status").onSnapshot(doc => {
    sys = doc.data(); if(!sys) return;
    updateTimerUI(sys.startTime);
});

function updateTimerUI(t) {
    if(!t) { document.getElementById('timerDisplay').innerText = "QUIZ LIVE"; return; }
    setInterval(() => {
        const diff = new Date(t).getTime() - new Date().getTime();
        if(diff > 0) {
            const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
            document.getElementById('timerDisplay').innerText = `ആരംഭിക്കാൻ: ${m}m ${s}s`;
            document.getElementById('mainTitle').innerText = "UPCOMING QUIZ";
        } else {
            document.getElementById('timerDisplay').innerText = "QUIZ LIVE";
            document.getElementById('mainTitle').innerText = "LIVE QUIZ";
        }
    }, 1000);
}

// 2. BRANCH STATS
db.collection("participants").onSnapshot(snap => {
    let counts = {}; branches.forEach(b => counts[b] = 0);
    snap.forEach(doc => { if(counts[doc.data().branch] !== undefined) counts[doc.data().branch]++; });
    let h = ""; branches.forEach(b => { h += `<div class="branch-item"><span>${b}</span><span class="branch-count">${counts[b]}</span></div>`; });
    document.getElementById('branchStats').innerHTML = h;
});

// 3. AUTH & REGISTRATION
async function handleRegister() {
    const n = document.getElementById('regName').value;
    const m = document.getElementById('regMob').value;
    const b = document.getElementById('regBranch').value;
    if(!n || m.length < 10 || !b) return alert("വിവരങ്ങൾ പൂർണ്ണമായും നൽകുക!");
    const check = await db.collection("participants").where("mobile", "==", m).get();
    if(!check.empty) return alert("ഈ മൊബൈൽ നമ്പർ ഉപയോഗിച്ചിട്ടുണ്ട്!");
    const last = await db.collection("participants").orderBy("regId", "desc").limit(1).get();
    let id = last.empty ? 1001 : last.docs[0].data().regId + 1;
    await db.collection("participants").doc(id.toString()).set({ regId: id, name: n, mobile: m, branch: b });
    document.getElementById('pName').innerText = n; document.getElementById('pBranch').innerText = b; document.getElementById('pId').innerText = id;
    showTab('poster');
}

async function checkLogin() {
    const id = document.getElementById('loginId').value;
    const uDoc = await db.collection("participants").doc(id).get();
    if(!uDoc.exists) return alert("Invalid ID!");
    const played = await db.collection("results").doc(id).get();
    if(played.exists) return alert("നിങ്ങൾ ക്വിസിൽ പങ്കെടുത്തു കഴിഞ്ഞു!");
    userData = uDoc.data();
    document.getElementById('confirmName').innerText = userData.name;
    document.getElementById('confirmBranch').innerText = "Branch: " + userData.branch;
    showDiv('confirmArea');
}

function startQuizNow() {
    if(!sys.published) return alert("ക്വിസ് ആരംഭിച്ചിട്ടില്ല!");
    showDiv('quizArea'); loadQuestions();
}

// 4. QUIZ LOGIC
function loadQuestions() {
    db.collection("questions").onSnapshot(snap => {
        let h = "";
        snap.forEach(doc => {
            const q = doc.data();
            h += `<div class="q-card" id="q-${doc.id}"><div style="font-weight:800; margin-bottom:12px;">${q.text}</div>`;
            q.options.forEach((o, i) => { h += `<button class="opt-btn" onclick="selectOpt('${doc.id}', ${i}, this)">${o}</button>`; });
            h += `</div>`;
        });
        document.getElementById('questionList').innerHTML = h;
    });
}

function selectOpt(qid, idx, btn) {
    userAnswers[qid] = idx;
    const p = document.getElementById('q-' + qid);
    p.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

async function submitFinal() {
    if(Object.keys(userAnswers).length === 0) return alert("ഉത്തരങ്ങൾ നൽകുക!");
    await db.collection("results").doc(userData.regId.toString()).set({ name: userData.name, answers: userAnswers, time: new Date() });
    showDiv('finalArea');
}

// HELPER FUNCTIONS
function showTab(t) {
    document.querySelectorAll('.tab-btn, .content').forEach(el => el.classList.remove('active'));
    document.getElementById('tabHeader').style.display = (t==='poster') ? 'none' : 'flex';
    if(t === 'login') { document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.getElementById('loginTab').classList.add('active'); }
    else if(t === 'register') { document.querySelectorAll('.tab-btn')[1].classList.add('active'); document.getElementById('registerTab').classList.add('active'); }
    else if(t === 'poster') { document.getElementById('posterTab').classList.add('active'); }
}

function showDiv(id) {
    ['authArea', 'confirmArea', 'quizArea', 'finalArea'].forEach(d => document.getElementById(d).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}
</script>
</body>
</html>