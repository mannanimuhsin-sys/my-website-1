<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¥∏‡¥Æ‡¥∏‡µç‡¥§ ‡¥ì‡µ∫‡¥≤‡µà‡µª ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #004d00; --gold: #f1c40f; --white: #ffffff; --red: #c0392b; }
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        
        .header { background: linear-gradient(135deg, #004d00, #002b00); color: white; text-align: center; padding: 50px 15px; border-radius: 0 0 40px 40px; }
        .header h1 { margin: 5px 0; font-size: 22px; font-weight: 800; }
        .timer-box { margin-top: 15px; background: rgba(255,255,255,0.1); display: inline-block; padding: 12px 30px; border-radius: 50px; border: 2px solid var(--gold); color: var(--gold); font-size: 24px; font-weight: 800; }

        .container { max-width: 500px; margin: 40px auto 20px; padding: 0 15px; } /* Margin ‡¥µ‡µº‡¥¶‡µç‡¥ß‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ö‡µç‡¥ö‡µÅ */
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); overflow: hidden; margin-bottom: 30px; padding: 20px; }
        
        .tab-head { display: flex; background: #f8f9fa; margin: -20px -20px 20px -20px; border-bottom: 1px solid #eee; }
        .tab-btn { flex: 1; padding: 15px; border: none; font-weight: 700; cursor: pointer; color: #888; background: none; }
        .tab-btn.active { color: var(--primary); background: white; border-top: 4px solid var(--primary); }

        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #eee; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .btn-primary { background: var(--primary); color: white; }

        .id-poster { background: #fff; border: 3px double var(--primary); border-radius: 20px; padding: 25px; text-align: center; }
        .id-val { font-size: 45px; font-weight: 800; color: var(--red); margin: 10px 0; }

        .q-card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 6px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .opt-btn { width: 100%; text-align: left; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; cursor: pointer; }

        .footer-mannani { background: #001a00; color: white; text-align: center; padding: 35px 15px; border-radius: 40px 40px 0 0; margin-top: 50px; }
        .dev-name { color: var(--gold); font-size: 20px; font-weight: 800; display: block; margin-bottom: 10px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header">
    <h2>SKSSF ‡¥ö‡¥™‡µç‡¥™‡¥æ‡¥∞‡¥™‡µç‡¥™‡¥ü‡¥µ‡µç ‡¥Æ‡µá‡¥ñ‡¥≤</h2>
    <h1>‡¥∏‡¥Æ‡¥∏‡µç‡¥§ ‡¥ì‡µ∫‡¥≤‡µà‡µª ‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç</h1>
    <div id="liveTimer" class="timer-box">00:00:00</div>
</div>

<div class="container">
    <div id="waitingArea" class="card" style="text-align:center;">‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï...</div>

    <div id="authArea" class="card hidden">
        <div class="tab-head">
            <button class="tab-btn active" onclick="toggleTab('login')">LOGIN</button>
            <button class="tab-btn" onclick="toggleTab('register')">REGISTER</button>
        </div>
        <div id="loginTab">
            <input type="number" id="loginId" placeholder="‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ê‡¥°‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï">
            <button class="btn btn-primary" onclick="checkLogin()">‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        </div>
        <div id="registerTab" class="hidden">
            <input type="text" id="regName" placeholder="‡¥™‡µá‡¥∞‡µç">
            <input type="number" id="regMob" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
            <select id="regBranch">
                <option value="">‡¥∂‡¥æ‡¥ñ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï</option>
                <option value="KARUVANCHAL">KARUVANCHAL</option>
                <option value="VILAKKANNOOR">VILAKKANNOOR</option>
                <option value="CHAPPARAPPADAV">CHAPPARAPPADAV</option>
                <option value="NADUVIL">NADUVIL</option>
                <option value="PADAPPENGAD">PADAPPENGAD</option>
                <option value="PERUVANA">PERUVANA</option>
                <option value="ELAMBERAM PARA">ELAMBERAM PARA</option>
                <option value="ERUVATTI">ERUVATTI</option>
                <option value="NHANDUMBALAM">NHANDUMBALAM</option>
                <option value="PERUMALABAD">PERUMALABAD</option>
                <option value="MANGARA BADARIYYA">MANGARA BADARIYYA</option>
                <option value="THADIKKADAV">THADIKKADAV</option>
                <option value="SHANTHIGIRI">SHANTHIGIRI</option>
                <option value="NEDUVOODE">NEDUVOODE</option>
                <option value="KUTTAMPARAMBA">KUTTAMPARAMBA</option>
            </select>
            <button class="btn btn-primary" onclick="handleRegister()">‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
        </div>
    </div>

    <div id="posterArea" class="hidden">
        <div class="id-poster" id="idContent"></div>
        <button class="btn btn-primary" style="margin-top:20px; background:var(--gold); color:black;" onclick="startQuiz()">‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
    </div>

    <div id="quizArea" class="hidden">
        <div id="questionList"></div>
        <button class="btn btn-primary" style="background:#27ae60;" onclick="submitFinal()">SUBMIT ANSWERS</button>
    </div>

    <div id="finalArea" class="hidden">
        <div id="winnerPoster" class="card" style="text-align:center;">‡¥®‡¥®‡µç‡¥¶‡¥ø! ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</div>
    </div>

    <div id="stoppedArea" class="card hidden" style="text-align:center; color:red;">
        <h2>‡¥ï‡µç‡¥µ‡¥ø‡¥∏‡µç ‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥ø‡¥ö‡µç‡¥ö‡µÅ</h2>
    </div>
</div>

<footer class="footer-mannani">
    <span class="dev-name">MUHSIN MANNANI</span>
    <div style="margin: 15px 0;">
        <a href="https://wa.me/917559950633" style="color:#25d366; font-size:25px; margin-right:20px;"><i class="fab fa-whatsapp"></i></a>
        <a href="tel:+917559950633" style="color:#3498db; font-size:25px;"><i class="fa fa-phone"></i></a>
    </div>
    <div style="font-size: 12px; opacity:0.7;">Contact: +91 7559950633</div>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyCS9jqJEr_umK_goyXuf3njYCE_Cb8xU7o", authDomain: "skssf-quiz.firebaseapp.com", projectId: "skssf-quiz", storageBucket: "skssf-quiz.firebasestorage.app", messagingSenderId: "999161549501", appId: "1:999161549501:web:7be9c98c287b92881a5dd4" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let userData = null; let userAnswers = {}; let isLive = false;

// Realtime Status
db.collection("quiz_settings").doc("status").onSnapshot(doc => {
    const s = doc.data();
    if(s.showPosters) { showDiv('finalArea'); loadWinners(); return; }
    if(s.closed) { showDiv('stoppedArea'); return; }
    if(s.startTime) startTimer(s.startTime);
});

function startTimer(target) {
    const intv = setInterval(() => {
        const diff = new Date(target).getTime() - new Date().getTime();
        const display = document.getElementById('liveTimer');
        if(diff <= 0) {
            display.innerText = "LIVE NOW";
            isLive = true;
            document.getElementById('waitingArea').classList.add('hidden');
            document.getElementById('authArea').classList.remove('hidden');
            clearInterval(intv);
        } else {
            const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); const s = Math.floor((diff%60000)/1000);
            display.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
    }, 1000);
}

// ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‚Äå‡¥ü‡µç‡¥∞‡µá‡¥∑‡µª - Duplicate Mobile Check ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ
async function handleRegister() {
    const n = document.getElementById('regName').value;
    const m = document.getElementById('regMob').value;
    const b = document.getElementById('regBranch').value;
    if(!n || !m || !b) return alert("‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï!");

    // ‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥°‡µç‡¥Ø‡µÇ‡¥™‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥ï‡µç‡¥ï‡µç
    const dup = await db.collection("participants").where("mobile", "==", m).get();
    if(!dup.empty) return alert("‡¥à ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µÜ ‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥§‡¥æ‡¥£‡µç!");

    const last = await db.collection("participants").orderBy("regId", "desc").limit(1).get();
    let nextId = last.empty ? 1001 : last.docs[0].data().regId + 1;
    
    userData = { regId: nextId, name: n, mobile: m, branch: b };
    await db.collection("participants").doc(nextId.toString()).set(userData);
    showPoster(userData);
}

// ‡¥≤‡µã‡¥ó‡¥ø‡µª - Already Participated Check ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ
async function checkLogin() {
    const id = document.getElementById('loginId').value;
    const doc = await db.collection("participants").doc(id).get();
    if(!doc.exists) return alert("‡¥ê‡¥°‡¥ø ‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥£‡µç!");
    
    // ‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µÜ ‡¥™‡¥ô‡µç‡¥ï‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    const played = await db.collection("results").doc(id).get();
    if(played.exists) return alert("‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥à ‡¥ê‡¥°‡¥ø ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µÜ ‡¥™‡¥ô‡µç‡¥ï‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§‡µÅ ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡µÅ!");

    userData = doc.data();
    showPoster(userData);
}

function showPoster(data) {
    document.getElementById('idContent').innerHTML = `
        <h3 style="color:var(--primary)">ENTRY PASS</h3>
        <p>Name: <b>${data.name}</b></p>
        <div class="id-val">${data.regId}</div>
        <p>Branch: <b>${data.branch}</b></p>
    `;
    showDiv('posterArea');
}

function startQuiz() {
    showDiv('quizArea');
    loadQuestions();
}

async function loadQuestions() {
    const snap = await db.collection("questions").get();
    let h = "";
    snap.forEach(doc => {
        const q = doc.data();
        h += `<div class="q-card"><p><b>${q.text}</b></p>
        ${q.options.map((o, i) => `<button class="opt-btn" onclick="selectAns('${doc.id}', ${i}, this)">${o}</button>`).join('')}
        </div>`;
    });
    document.getElementById('questionList').innerHTML = h;
}

function selectAns(qid, idx, btn) {
    userAnswers[qid] = idx;
    btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.style.background = '#f9f9f9');
    btn.style.background = 'var(--gold)';
}

async function submitFinal() {
    if(Object.keys(userAnswers).length === 0) return alert("‡¥â‡¥§‡µç‡¥§‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");
    await db.collection("results").doc(userData.regId.toString()).set({
        regId: userData.regId, name: userData.name, branch: userData.branch, answers: userAnswers, time: new Date()
    });
    showDiv('finalArea');
}

function showDiv(id) {
    ['authArea', 'quizArea', 'finalArea', 'stoppedArea', 'waitingArea', 'posterArea'].forEach(d => document.getElementById(d).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function toggleTab(t) {
    document.getElementById('loginTab').classList.toggle('hidden', t !== 'login');
    document.getElementById('registerTab').classList.toggle('hidden', t !== 'register');
    document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (t==='login'&&i===0)||(t==='register'&&i===1)));
}

async function loadWinners() {
    const doc = await db.collection("winners").doc("list").get();
    if(!doc.exists) return;
    const ranks = doc.data().ranks;
    let h = "<h2>üèÜ ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ üèÜ</h2>";
    const trophies = { 1: "ü•á", 2: "ü•à", 3: "ü•â" };
    for(let i=1; i<=3; i++) {
        const u = await db.collection("participants").doc(ranks[i].toString()).get();
        if(u.exists) h += `<div class="card" style="border:2px solid var(--gold); background:#fffde7;">${trophies[i]}<br><b>${u.data().name}</b><br><small>${u.data().branch}</small></div>`;
    }
    document.getElementById('winnerPoster').innerHTML = h;
}
</script>
</body>
</html>